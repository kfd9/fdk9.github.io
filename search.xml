<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>ASC平台升级说明文档</title>
      <link href="/2020/06/29/asc20200629/"/>
      <url>/2020/06/29/asc20200629/</url>
      <content type="html"><![CDATA[<h1 id="ASC平台升级说明文档"><a href="#ASC平台升级说明文档" class="headerlink" title="ASC平台升级说明文档"></a>ASC平台升级说明文档</h1><blockquote><p>日期:：2020年6月29日</p></blockquote><blockquote><p>作者：F.D.Kang/Z.Z.Mo</p><p>注意：由于本次<code>ASC</code>平台升级在根项目的<code>pom.xml</code>增加了一些参数配置，在各个项目的根<code>parent</code>的<code>pom.xml</code>文件里最好采用和<code>asc</code>平台不一样的<code>groupId</code>，否则造成平台<code>jar</code>包依赖的根<code>parent</code>变成了项目的根<code>parent</code>，会找不到<code>asc</code>平台定义的相关参数</p></blockquote><h2 id="1-升级前的准备"><a href="#1-升级前的准备" class="headerlink" title="1. 升级前的准备"></a>1. 升级前的准备</h2><h3 id="1-1-版本号"><a href="#1-1-版本号" class="headerlink" title="1.1. 版本号"></a>1.1. 版本号</h3><blockquote><p>统一规定<code>ASC</code>平台本次升级版本号为<code>1.1.202001</code></p></blockquote><blockquote><p>本次升级的<code>ASC</code>平台所有<code>jar</code>包版本统一规定如下</p></blockquote><p><pre><code><br>├── ASC Platform - 1.1.202001<br>│   ├── ASC Basic - 1.1.202001<br>│   │   ├── Mixky Toolkit - 1.1.202001<br>│   │   ├── Mixky Database Access - 1.1.202001<br>│   ├── ASC Commons - 1.1.202001<br>│   │   ├── Platform Commons - Base - 1.1.202001<br>│   │   ├── Platform Commons - Core - 1.1.202001<br>│   │   ├── Platform Commons - DirectJngine - 1.1.202001<br>│   │   ├── Platform Commons - Engine - 1.1.202001<br>│   │   ├── Platform Commons - Esb - 1.1.202001<br>│   │   ├── Platform Commons - Workflow - 1.1.202001<br>│   ├── ASC Facade - 1.1.202001<br>│   │   ├── Application Framework - 1.1.202001<br>│   │   ├── Central Authentication Service - 1.1.202001<br>│   ├── ASC Applications - 1.1.202001<br>│   │   ├── Platform Base Service<br>│   │   ├── Platform Manager<br>│   │   ├── Application Developer<br>│   │   ├── Application Portal<br>│   ├── ASC Module Applications<br>│   │   ├── Demo Application<br></code></pre></p><blockquote><p>所有的平台依赖jar包版本统一为<code>1.1.202001</code></p></blockquote><blockquote><p>各个项目升级前需要把依赖的平台相关jar包全部改为<code>1.1.202001</code></p></blockquote><h3 id="1-2-代理仓库配置"><a href="#1-2-代理仓库配置" class="headerlink" title="1.2. 代理仓库配置"></a>1.2. 代理仓库配置</h3><blockquote><p>在项目的根目录里的<code>pom.xml</code>配置代理仓库，配置好修改完版本号即可自动从代理仓库下载版本号为<code>1.1.202001</code>的<code>jar</code>包，配置如下：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>releases.asp.com<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>releases.asp.com<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://202.85.222.14:7038/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--true或者false表示该仓库是否为下载某种类型构件（发布版，快照版）开启。  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--该元素指定更新发生的频率。Maven会比较本地POM和远程POM的时间戳。这里的选项是：always（一直），daily（默认，每日），interval：X（这里X是以分钟为单位的时间间隔），或者never（从不）。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>never<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--当Maven验证构件校验文件失败时该怎么做-ignore（忽略），fail（失败），或者warn（警告）。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>warn<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>warn<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1-3-依赖版本号修改"><a href="#1-3-依赖版本号修改" class="headerlink" title="1.3. 依赖版本号修改"></a>1.3. 依赖版本号修改</h3><blockquote><p>需要对项目依赖的平台<code>jar</code>包版本号进行修改</p></blockquote><blockquote><p>在根目录里的<code>pom.xml</code>对<code>properties</code>里的依赖版本号进行修改，修改如下：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">commons.core.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">commons.core.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">commons.engine.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">commons.engine.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">asc.cas.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">asc.cas.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mixky.toolkit.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">mixky.toolkit.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">platform.commons.base.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">platform.commons.base.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">platform.commons.esb.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">platform.commons.esb.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">application.framework.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">application.framework.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">platform.base.service.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">platform.base.service.version</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>平台需要修改的jar包版本号包括：</p></blockquote><ul><li>mkdbac</li><li>toolkit</li><li>commons-base</li><li>commons-core</li><li>commons-engine</li><li>commons-esb</li><li>commons-workflow</li><li>directjngine</li><li>cas</li><li>framework</li></ul><blockquote><p>以上的部分<code>jar</code>包如果源码就在项目内，那么会和<code>asc</code>平台依赖的<code>1.1.202001</code>版本号的<code>jar</code>包冲突，那么最好不使用平台内的<code>jar</code>包或者把项目内的<code>jar</code>包版本号改为<code>1.1.202001</code>即可。</p></blockquote><h2 id="2-平台功能升级"><a href="#2-平台功能升级" class="headerlink" title="2. 平台功能升级"></a>2. 平台功能升级</h2><h3 id="2-1-CAS功能升级"><a href="#2-1-CAS功能升级" class="headerlink" title="2.1. CAS功能升级"></a>2.1. <code>CAS</code>功能升级</h3><blockquote><p><code>CAS</code>用户权限认证中心记录用户所登录的应用节点</p></blockquote><h4 id="2-1-1-java代码修改"><a href="#2-1-1-java代码修改" class="headerlink" title="2.1.1. java代码修改"></a>2.1.1. <code>java</code>代码修改</h4><blockquote><p>进入<code>portal</code>项目，打开，打开类<code>com.asc.portal.certification.HttpBaseAuthenticationListenerImp</code></p></blockquote><blockquote><p>在类的首行添加如下代码:</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String nodeId; <span class="comment">// 节点ID</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNodeId</span><span class="params">(String nodeId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.nodeId = nodeId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-2-xml配置修改"><a href="#2-1-2-xml配置修改" class="headerlink" title="2.1.2. xml配置修改"></a>2.1.2. <code>xml</code>配置修改</h4><blockquote><p>进入<code>portal</code>项目，打开<code>{portalProjectPath}\WebRoot\WEB-INF\config\spring\cas-config.xml</code></p></blockquote><blockquote><p>修改<code>com.asc.portal.certification.HttpBaseAuthenticationListenerImp</code>的<code>Bean</code>生成配置</p></blockquote><ul><li>修改前</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"HttpBaseAuthenticationListenerImp"</span> <span class="attr">class</span>=<span class="string">"com.asc.portal.certification.HttpBaseAuthenticationListenerImp"</span>/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>修改后<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"HttpBaseAuthenticationListenerImp"</span> <span class="attr">class</span>=<span class="string">"com.asc.portal.certification.HttpBaseAuthenticationListenerImp"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"nodeId"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;app.nodeId&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-1-3-params-properties配置新增"><a href="#2-1-3-params-properties配置新增" class="headerlink" title="2.1.3. params.properties配置新增"></a>2.1.3. <code>params.properties</code>配置新增</h4><blockquote><p>进入<code>portal</code>项目，打开<code>{portalProjectPath}\WebRoot\WEB-INF\param.properties</code></p></blockquote><blockquote><p>新增以下参数配置</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 应用节点ID</span><br><span class="line">app.nodeId=1</span><br></pre></td></tr></table></figure><h3 id="2-2-dbac功能升级"><a href="#2-2-dbac功能升级" class="headerlink" title="2.2. dbac功能升级"></a>2.2. <code>dbac</code>功能升级</h3><blockquote><p>数据表<code>ID</code>通过<code>redis</code>生成的配置调整</p></blockquote><blockquote><p>以下配置在<code>portal</code>、<code>app</code>、<code>bs</code>、<code>manager</code>里都是一样</p></blockquote><h4 id="2-2-1-param-properties配置新增"><a href="#2-2-1-param-properties配置新增" class="headerlink" title="2.2.1. param.properties配置新增"></a>2.2.1. <code>param.properties</code>配置新增</h4><blockquote><p><code>ID</code>来源配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 该处用于标记ID获取来源，分为Db和Redis，不设置默认使用Db</span><br><span class="line">db.idsource=Redis</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p><code>redis</code>连接配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># redis参数配置-详见redis.clients.jedis.JedisPoolConfig的配置，但是按照当前采用的jredis只支持以下属性配置(maxIdle, maxTotal, minIdle)当前设置为默认值</span><br><span class="line">redis.pool.maxIdle=8</span><br><span class="line">redis.pool.maxTotal=8</span><br><span class="line">redis.pool.minIdle=0</span><br><span class="line">## redis连接url的格式为：http://[password:&#123;password&#125;@]&#123;host&#125;:&#123;port&#125;/&#123;db&#125;</span><br><span class="line">## password: 密码; host: ip或者域名; port: 端口; db: 数据库</span><br><span class="line">## 有密码时可以设置url为: http://password:1234@127.0.0.1:6379/0</span><br><span class="line">## 无密码时可以设置url为: http://127.0.0.1:6379/0</span><br><span class="line">default.redis.url=http://127.0.0.1:6379/0</span><br><span class="line">default.redis.key=defaultRedis</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="2-2-2-redis的xml配置"><a href="#2-2-2-redis的xml配置" class="headerlink" title="2.2.2. redis的xml配置"></a>2.2.2. <code>redis</code>的xml配置</h4><blockquote><p>在<red><code>config</code></red>的文件夹下创建<red><code>redis</code></red>的文件夹,新增两个<code>xml</code>文件，为<red><code>redis.xml</code></red>和<red><code>default-redis.xml</code></red>，以下分别是两个<code>xml</code>的配置内容</p></blockquote><ul><li><code>redis.xml</code>配置内容:</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">  http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">  http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">  http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"poolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.maxIdle&#125;"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.maxTotal&#125;"</span> /&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.minIdle&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 默认库-用于数据库表ID缓存 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"./default-redis.xml"</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 有其他新的redis源直接新增xml追加在此处即可 --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"IdRedisGeneratorFactory"</span> <span class="attr">class</span>=<span class="string">"com.asc.commons.dbac.IdRedisGeneratorFactory"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"RedisAccessFactory"</span> <span class="attr">class</span>=<span class="string">"com.asc.commons.redis.RedisAccessFactory"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"redisConnections"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"defaultRedisConnection"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>default-redis.xml</code>配置内容</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/aop  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/aop/spring-aop-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/context  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/context/spring-context-3.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"defaultJedisShardInfo"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisShardInfo"</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">"String"</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"$&#123;default.redis.url&#125;"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"defaultRedisConnection"</span> <span class="attr">class</span>=<span class="string">"com.asc.commons.redis.RedisConnection"</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"key"</span> <span class="attr">value</span>=<span class="string">"$&#123;default.redis.key&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolConfig"</span> <span class="attr">ref</span>=<span class="string">"poolConfig"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"info"</span> <span class="attr">ref</span>=<span class="string">"defaultJedisShardInfo"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3-应用的xml配置"><a href="#2-2-3-应用的xml配置" class="headerlink" title="2.2.3. 应用的xml配置"></a>2.2.3. 应用的<code>xml</code>配置</h4><blockquote><p>在<code>config/app-config.xml</code>里增加对<code>redis.xml</code>的引入，如下：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"../redis/redis.xml"</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-2-4-DataSource的Bean配置修改"><a href="#2-2-4-DataSource的Bean配置修改" class="headerlink" title="2.2.4. DataSource的Bean配置修改"></a>2.2.4. <code>DataSource</code>的<code>Bean</code>配置修改</h4><blockquote><p>针对数据库配置新增数据库唯一实例名</p></blockquote><blockquote><p>在<code>config/core-config.xml</code>的所有<code>com.mixky.dbac.datasource.DataSource</code>的Bean配置，新增<code>schemaName</code>属性的赋值，该属性用于对真实数据库实例的标记，不管是一个项目还是多个项目在采用<code>schemaName</code>时只要是一个数据库实例名和用户名的情况下必须保持<code>schemaName</code>的一致性。</p></blockquote><blockquote><p>比如伤损项目和焊缝项目都用到<code>rdms</code>数据库实例和<code>rdmsapp</code>用户，那么不管在伤损项目还是在焊缝项目的所有应用配置里这个<code>DataSource</code>的<code>schemaName</code>都必须保持一致，可以使用<code>rdmsAppDsn</code>来标记。</p></blockquote><blockquote><p>配置如下:</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schemaName"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>demoPortalDsn<span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="comment">&lt;!-- 该处是某个demo的portal数据库-必须要改 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idSource"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;db.idsource&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-3-流水号功能升级"><a href="#2-3-流水号功能升级" class="headerlink" title="2.3. 流水号功能升级"></a>2.3. 流水号功能升级</h3><blockquote><p>流水号通过<code>redis</code>生成的配置调整</p></blockquote><blockquote><p>以下配置只需要在使用流水号的项目应用中配置即可</p></blockquote><blockquote><p>以下以伤损项目的流水号生成为例，伤损里的流水号生成工具类为<code>com.crmec.rail.commons.serialnumber.SerialNumberFactory</code>，如何把该类改为可以适用<code>redis</code>获取流水号的工具类。</p></blockquote><h4 id="2-3-1-java代码新增"><a href="#2-3-1-java代码新增" class="headerlink" title="2.3.1. java代码新增"></a>2.3.1. <code>java</code>代码新增</h4><blockquote><p>在<code>com.crmec.rail.commons.serialnumber.SerialNumberFactory</code>新增静态字段为<code>idSource</code>和<code>systemCode</code>，并且生成该字段的<code>get</code>、<code>set</code>方法。</p></blockquote><blockquote><p>新增的字段分别为流水号来源、系统标示，<code>idSource</code>为标示生成流水号的来源；<code>systemCode</code>为标示系统，如伤损项目里的所有应用都应该使用一个编号<code>rdms</code>，加油卡可以使用<code>rcms</code>，钢轨供应链可以使用<code>rscm</code>。</p></blockquote><blockquote><p>代码如下所示</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String idSource;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String systemCode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getIdSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> idSource;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIdSource</span><span class="params">(String idSource)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.idSource = idSource;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getSystemCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> systemCode;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSystemCode</span><span class="params">(String systemCode)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.systemCode = systemCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-2-Bean配置修改"><a href="#2-3-2-Bean配置修改" class="headerlink" title="2.3.2. Bean配置修改"></a>2.3.2. <code>Bean</code>配置修改</h4><blockquote><p>进入<code>Rail Defects Application</code>项目，修改<code>WebRoot\WEB-INF\config\spring</code>下面的<code>core-config.xml</code>文件里的<code>SerialNumberFactory</code>的<code>Bean</code>配置。</p></blockquote><blockquote><p>该处仅针对伤损<code>defects</code>应用里的流水号配置，其他项目或应用里使用如下同样的配置</p></blockquote><blockquote><p>在原来<code>Bean</code>的配置上加上对<code>idSource</code>的赋值</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 生成序列号的时候，获取内外网 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"SerialNumberFactory"</span> <span class="attr">class</span>=<span class="string">"com.crmec.rail.commons.serialnumber.SerialNumberFactory"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idGenerator"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;serialnumber.generator&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idSource"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;serialnumber.source&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"systemCode"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;serialnumber.systemCode&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-3-3-param-properties配置新增"><a href="#2-3-3-param-properties配置新增" class="headerlink" title="2.3.3. param.properties配置新增"></a>2.3.3. <code>param.properties</code>配置新增</h4><blockquote><p>进入<code>Rail Defects Application</code>项目，修改<code>WebRoot\WEB-INF</code>下面的<code>param.properties</code>文件，在该文件里增加一个参数配置，如下所示</p></blockquote><blockquote><p>流水号新增参数配置</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 流水号生成来源，可以配置Redis或者Db，不配置默认是Db</span><br><span class="line">serialnumber.source=Redis</span><br><span class="line">serialnumber.systemCode=rdms</span><br></pre></td></tr></table></figure><blockquote><p>流水号需要依赖的<code>redis</code>连接参数配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">serial.redis.url=http://127.0.0.1:6379/1</span><br><span class="line">serial.redis.key=serialRedis</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="2-3-4-redis的xml配置"><a href="#2-3-4-redis的xml配置" class="headerlink" title="2.3.4. redis的xml配置"></a>2.3.4. <code>redis</code>的<code>xml</code>配置</h4><blockquote><p>在<code>{projectPath}/WebRoot\WEB-INF\config\redis</code>所在文件夹下面创建<code>serialRedis.xml</code>文件</p></blockquote><blockquote><p><code>xml</code>内容如下:</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"  </span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/beans  </span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/aop  </span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/aop/spring-aop-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/context  </span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/context/spring-context-3.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serialJedisShardInfo"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisShardInfo"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">"String"</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"$&#123;serial.redis.url&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serialRedisConnection"</span> <span class="attr">class</span>=<span class="string">"com.asc.commons.redis.RedisConnection"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"key"</span> <span class="attr">value</span>=<span class="string">"$&#123;serial.redis.key&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default"</span> <span class="attr">value</span>=<span class="string">"false"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolConfig"</span> <span class="attr">ref</span>=<span class="string">"poolConfig"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"info"</span> <span class="attr">ref</span>=<span class="string">"serialJedisShardInfo"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>进入到<code>{projectPath}/WebRoot\WEB-INF\config\redis\redis.xml</code>，在<code>RedisAccessFactory</code>的<code>Bean</code>配置上加入对<code>serialRedisConnection</code>的引用</p></blockquote><blockquote><p>配置修改如下：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"RedisAccessFactory"</span> <span class="attr">class</span>=<span class="string">"com.asc.commons.redis.RedisAccessFactory"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"redisConnections"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"defaultRedisConnection"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"serialRedisConnection"</span>/&gt;</span><span class="comment">&lt;!-- 流水号的redis连接应用 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-3-5-java类新增"><a href="#2-3-5-java类新增" class="headerlink" title="2.3.5. java类新增"></a>2.3.5. <code>java</code>类新增</h4><blockquote><p>创建流水号生成抽象类，该抽象类可以创建在和流水号类同一个包下，伤损里创建的类为<code>com.crmec.rail.commons.serialnumber.AbstractSerialNumberFactory</code>。</p></blockquote><blockquote><p>类的内容如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.crmec.rail.commons.serialnumber;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.asc.commons.dbac.CommonDatabaseAccess;</span><br><span class="line"><span class="keyword">import</span> com.asc.commons.exception.DbAccessException;</span><br><span class="line"><span class="keyword">import</span> com.asc.commons.exception.RedisException;</span><br><span class="line"><span class="keyword">import</span> com.asc.commons.redis.RedisAccessFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: AbstractSerialNumberFactory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 流水号生成抽象工厂类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> F.D.Kang [kangfengde962@gmail.com]</span></span><br><span class="line"><span class="comment"> *   _____ ____   _  __                 </span></span><br><span class="line"><span class="comment"> * |  ___|  _ \ | |/ /__ _ _ __   __ _</span></span><br><span class="line"><span class="comment"> * | |_  | | | || ' // _` | '_ \ / _` |</span></span><br><span class="line"><span class="comment"> * |  _|_| |_| || . \ (_| | | | | (_| |</span></span><br><span class="line"><span class="comment"> * |_| (_)____(_)_|\_\__,_|_| |_|\__, |</span></span><br><span class="line"><span class="comment"> *                               |___/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@company</span> Mixky Technology Company</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020年4月22日 下午2:17:50</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSerialNumberFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isRedisSource</span><span class="params">(String idSource)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"Redis"</span>.equals(idSource)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String serialKeySuffix = <span class="string">"_SerialNum"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String redisKey = <span class="string">"serialRedis"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getKey</span><span class="params">(String systemCode)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> systemCode + serialKeySuffix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getNo</span><span class="params">(String idGenerator, String systemCode, String headNum)</span> </span>&#123;</span><br><span class="line"><span class="keyword">long</span> no = <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Boolean hasHash = RedisAccessFactory.getRedisAccess(redisKey).hasMappedKeyExist(getKey(systemCode), headNum);</span><br><span class="line"><span class="keyword">if</span> (hasHash == <span class="keyword">null</span> || !hasHash) &#123;</span><br><span class="line">setMaxNo(idGenerator, systemCode, headNum);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> step = getStep(idGenerator);</span><br><span class="line">no = RedisAccessFactory.getRedisAccess(redisKey).increaseMappedAmount(getKey(systemCode), headNum, step);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RedisException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"通过redis获取流水号失败"</span>, e);</span><br><span class="line">&#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"通过redis获取流水号失败"</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> no;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setMaxNo</span><span class="params">(String idGenerator, String systemCode, String headNum)</span> <span class="keyword">throws</span> DbAccessException, RedisException </span>&#123;</span><br><span class="line"><span class="keyword">long</span> maxId = getMaxId(headNum);</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"Even"</span>.equals(idGenerator)) &#123;</span><br><span class="line">maxId = getEvenId(maxId);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"Odd"</span>.equals(idGenerator)) &#123;</span><br><span class="line">maxId = getOddId(maxId);</span><br><span class="line">&#125;</span><br><span class="line">RedisAccessFactory.getRedisAccess(redisKey).increaseMappedAmount(getKey(systemCode), headNum, maxId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getStep</span><span class="params">(String idGenerator)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"Even"</span>.equals(idGenerator) || <span class="string">"Odd"</span>.equals(idGenerator)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getMaxId</span><span class="params">(String headNum)</span> <span class="keyword">throws</span> DbAccessException </span>&#123;</span><br><span class="line">String sql = <span class="string">"select F_NO from T_RDMS_BASE_SERIALNUM where F_HEAD_NUM=?"</span>;</span><br><span class="line">CommonDatabaseAccess.instance().beginTransaction();</span><br><span class="line">SerialEntity serialEntity = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">serialEntity = CommonDatabaseAccess.instance().getObject(sql,</span><br><span class="line"><span class="keyword">new</span> Object[] &#123; headNum &#125;, SerialEntity.class);</span><br><span class="line">&#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line"><span class="keyword">throw</span> e;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">CommonDatabaseAccess.instance().endTransaction();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (serialEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> serialEntity.getF_no();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getOddId</span><span class="params">(<span class="keyword">long</span> maxId)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (maxId % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// 最大ID是偶数，仅需加一</span></span><br><span class="line">maxId = maxId + <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 最大ID是奇数，加二，取下一个奇数</span></span><br><span class="line">maxId = maxId + <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> maxId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getEvenId</span><span class="params">(<span class="keyword">long</span> maxId)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (maxId % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// 最大ID是奇数，仅需加一</span></span><br><span class="line">maxId = maxId + <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 最大ID是偶数，加二，取下一个偶数</span></span><br><span class="line">maxId = maxId + <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> maxId;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-6-java方法修改"><a href="#2-3-6-java方法修改" class="headerlink" title="2.3.6. java方法修改"></a>2.3.6. <code>java</code>方法修改</h4><blockquote><p>流水号生成类里修改以及各个实现方法修改，以伤损项目的年度计划编号生成的方法<code>getYPlanSerialNumber</code>修改为示例</p></blockquote><blockquote><p>该段代码插入到流水号生成最开始</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isRedisSource(idSource)) &#123; <span class="comment">// 采用redis</span></span><br><span class="line">no = getNo(idGenerator, systemCode, YEAR_FLAG);</span><br><span class="line"><span class="keyword">if</span> (no &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">logger.error(<span class="string">"通过redis获取流水号失败"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">serial = headNum + (String.format(f, no));</span><br><span class="line"><span class="keyword">return</span> serial;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>调整前的方法代码</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getYPlanSerialNumber</span><span class="params">(String num, String dateStr)</span> </span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (LOCK1) &#123;</span><br><span class="line">String serial = <span class="keyword">null</span>;</span><br><span class="line">logger.debug(<span class="string">"start getYPlanSerialNumber 开始产生年度计划序列号！"</span>);</span><br><span class="line">IDbacTransaction tx = getDbAccess().beginTransaction();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">long</span> no = <span class="number">0</span>;</span><br><span class="line">String f = <span class="string">"%04d"</span>;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isEmpty(num)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"编码不能为空！"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isEmpty(dateStr)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"年月时间戳不能为空！"</span>);</span><br><span class="line">&#125;</span><br><span class="line">String headNum = YEAR_FLAG + <span class="string">"-"</span> + num + <span class="string">"-"</span> + dateStr;</span><br><span class="line">String sql = <span class="string">"select F_NO from T_RDMS_BASE_SERIALNUM"</span> + <span class="string">" where F_HEAD_NUM=?"</span>;</span><br><span class="line">SerialEntity serialEntity = getDbAccess().getObject(sql, <span class="keyword">new</span> Object[] &#123; headNum &#125;, SerialEntity.class);</span><br><span class="line"><span class="keyword">if</span> (serialEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// 如果存在该类型流水号，则将流水号+1</span></span><br><span class="line">no = serialEntity.getF_no();</span><br><span class="line"><span class="keyword">if</span> (idGenerator.equals(<span class="string">"Even"</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (no % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">no++;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (no % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">no++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">no += <span class="number">2</span>;</span><br><span class="line">String updateSql = <span class="string">"update T_RDMS_BASE_SERIALNUM set "</span> + <span class="string">" F_NO=? where F_HEAD_NUM=? and F_TYPE=? "</span>;</span><br><span class="line">getDbAccess().execute(updateSql, <span class="keyword">new</span> Object[] &#123; no, headNum, YEAR_FLAG &#125;);</span><br><span class="line">logger.debug(<span class="string">"获取年度计划流水号："</span> + no);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">no = idGenerator.equals(<span class="string">"Even"</span>) ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">serialEntity = <span class="keyword">new</span> SerialEntity();</span><br><span class="line">serialEntity.setF_no(no);</span><br><span class="line">serialEntity.setF_type(YEAR_FLAG);</span><br><span class="line">serialEntity.setF_head_num(headNum);</span><br><span class="line">getDbAccess().saveObject(serialEntity);</span><br><span class="line">&#125;</span><br><span class="line">serial = headNum + (String.format(f, no));</span><br><span class="line">tx.commit();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">tx.rollback();</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">getDbAccess().endTransaction();</span><br><span class="line">&#125;</span><br><span class="line">logger.debug(<span class="string">"年度序列号获取成功，序列号为："</span> + serial);</span><br><span class="line"><span class="keyword">return</span> serial;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>调整后的方法代码–可参考调整后的流水号生成代码</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getYPlanSerialNumber</span><span class="params">(String num, String dateStr)</span> </span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (LOCK1) &#123;</span><br><span class="line">String serial = <span class="keyword">null</span>;</span><br><span class="line">String f = <span class="string">"%04d"</span>;</span><br><span class="line"><span class="keyword">long</span> no = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isEmpty(num)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"编码不能为空！"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isEmpty(dateStr)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"年月时间戳不能为空！"</span>);</span><br><span class="line">&#125;</span><br><span class="line">String headNum = YEAR_FLAG + <span class="string">"-"</span> + num + <span class="string">"-"</span> + dateStr;</span><br><span class="line">logger.debug(<span class="string">"start getYPlanSerialNumber 开始产生年度计划序列号！"</span>);</span><br><span class="line"><span class="keyword">if</span> (isRedisSource(idSource)) &#123; <span class="comment">// 采用redis</span></span><br><span class="line">no = getNo(idGenerator, systemCode, YEAR_FLAG);</span><br><span class="line"><span class="keyword">if</span> (no &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">logger.error(<span class="string">"通过redis获取流水号失败"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">serial = headNum + (String.format(f, no));</span><br><span class="line"><span class="keyword">return</span> serial;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">IDbacTransaction tx = getDbAccess().beginTransaction();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">String sql = <span class="string">"select F_NO from T_RDMS_BASE_SERIALNUM"</span> + <span class="string">" where F_HEAD_NUM=?"</span>;</span><br><span class="line">SerialEntity serialEntity = getDbAccess().getObject(sql, <span class="keyword">new</span> Object[] &#123; headNum &#125;, SerialEntity.class);</span><br><span class="line"><span class="keyword">if</span> (serialEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// 如果存在该类型流水号，则将流水号+1</span></span><br><span class="line">no = serialEntity.getF_no();</span><br><span class="line"><span class="keyword">if</span> (idGenerator.equals(<span class="string">"Even"</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (no % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">no++;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (no % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">no++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">no += <span class="number">2</span>;</span><br><span class="line">String updateSql = <span class="string">"update T_RDMS_BASE_SERIALNUM set "</span> + <span class="string">" F_NO=? where F_HEAD_NUM=? and F_TYPE=? "</span>;</span><br><span class="line">getDbAccess().execute(updateSql, <span class="keyword">new</span> Object[] &#123; no, headNum, YEAR_FLAG &#125;);</span><br><span class="line">logger.debug(<span class="string">"获取年度计划流水号："</span> + no);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">no = idGenerator.equals(<span class="string">"Even"</span>) ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">serialEntity = <span class="keyword">new</span> SerialEntity();</span><br><span class="line">serialEntity.setF_no(no);</span><br><span class="line">serialEntity.setF_type(YEAR_FLAG);</span><br><span class="line">serialEntity.setF_head_num(headNum);</span><br><span class="line">getDbAccess().saveObject(serialEntity);</span><br><span class="line">&#125;</span><br><span class="line">serial = headNum + (String.format(f, no));</span><br><span class="line">tx.commit();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">tx.rollback();</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">getDbAccess().endTransaction();</span><br><span class="line">&#125;</span><br><span class="line">logger.debug(<span class="string">"年度序列号获取成功，序列号为："</span> + serial);</span><br><span class="line"><span class="keyword">return</span> serial;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-ID管理升级"><a href="#2-4-ID管理升级" class="headerlink" title="2.4. ID管理升级"></a>2.4. ID管理升级</h3><blockquote><p><code>manager</code>应用新增手动维护redis最大ID功能升级配置</p></blockquote><blockquote><p>该功能主要用于对数据表ID进行向上手动设置当前最大ID</p></blockquote><blockquote><p>该功能属于<code>manager</code>应用，功能菜单位于<code>应用运行管理</code>菜单下</p></blockquote><h4 id="2-4-1-java类新增代码"><a href="#2-4-1-java类新增代码" class="headerlink" title="2.4.1. java类新增代码"></a>2.4.1. <code>java</code>类新增代码</h4><h5 id="2-4-1-1-常量定义新增"><a href="#2-4-1-1-常量定义新增" class="headerlink" title="2.4.1.1. 常量定义新增"></a>2.4.1.1. 常量定义新增</h5><blockquote><p><code>CommonTextFolderNode</code>类新增<code>ID管理</code>的菜单<code>KEY</code>常量定义代码</p></blockquote><blockquote><p>类全路径为<code>com.asc.manager.navigator.node.CommonTextFolderNode</code>，新增代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_APPLICATION_ID_MANAGER = <span class="string">"ApplicationIdManager"</span>;</span><br></pre></td></tr></table></figure><h5 id="2-4-1-2-菜单新增"><a href="#2-4-1-2-菜单新增" class="headerlink" title="2.4.1.2. 菜单新增"></a>2.4.1.2. 菜单新增</h5><blockquote><p><code>ApplicationManagerFolderLoader</code>类新增应用运行管理下子菜单<code>ID管理</code>代码</p></blockquote><blockquote><p>类全路径为<code>com.asc.manager.navigator.loader.ApplicationManagerFolderLoader</code>，新增代码如下：</p></blockquote><blockquote><p>在方法<code>getChildren</code>里，新增代码写在<code>缓存管理</code>和<code>流程实例</code>之间</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node = <span class="keyword">new</span> CommonTextFolderNode(CommonTextFolderNode.TYPE_APPLICATION_ID_MANAGER, key, <span class="string">"ID管理"</span>, <span class="keyword">true</span>);</span><br><span class="line">nodes.add(node);</span><br></pre></td></tr></table></figure><h5 id="2-4-1-3-接口新增"><a href="#2-4-1-3-接口新增" class="headerlink" title="2.4.1.3. 接口新增"></a>2.4.1.3. 接口新增</h5><blockquote><p><code>ManagerAppDirect</code>类新增<code>ID</code>查询接口和<code>ID</code>修改接口代码</p></blockquote><blockquote><p>类全路径<code>com.asc.manager.direct.ManagerAppDirect</code>，新增代码如下：</p></blockquote><blockquote><p>追加方法<code>listSchemaTableId</code>，代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonObject <span class="title">listSchemaTableId</span><span class="params">(String schemaName)</span></span>&#123;</span><br><span class="line">    JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">    json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(schemaName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> json;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;Object, Object&gt; map = RedisAccessFactory.getDefaultRedisAccess()</span><br><span class="line">                .hashEntries(schemaName + <span class="string">"_SEQID"</span>);</span><br><span class="line">        Iterator&lt;Entry&lt;Object, Object&gt;&gt; it = map.entrySet().iterator();</span><br><span class="line">        JsonArray array = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            JsonObject data = <span class="keyword">new</span> JsonObject();</span><br><span class="line">            Entry&lt;Object, Object&gt; entry = it.next();</span><br><span class="line">            data.addProperty(<span class="string">"tableName"</span>, String.valueOf(entry.getKey()));</span><br><span class="line">            data.addProperty(<span class="string">"idValue"</span>, entry.getValue().toString());</span><br><span class="line">            array.add(data);</span><br><span class="line">        &#125;</span><br><span class="line">        json.add(<span class="string">"datas"</span>, array);</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>追加方法<code>saveSchemaTableId</code>，代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonObject <span class="title">saveSchemaTableId</span><span class="params">(String schemaName, JsonArray array)</span></span>&#123;</span><br><span class="line">    JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">    json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(schemaName) || array == <span class="keyword">null</span> || array.isJsonNull()) &#123;</span><br><span class="line">            json.addProperty(<span class="string">"message"</span>, <span class="string">"传入参数错误"</span>);</span><br><span class="line">            <span class="keyword">return</span> json;</span><br><span class="line">        &#125;</span><br><span class="line">        Iterator&lt;JsonElement&gt; it = array.iterator();</span><br><span class="line">        <span class="keyword">boolean</span> valid = <span class="keyword">true</span>;</span><br><span class="line">        Map&lt;String, Long&gt; datas = Maps.newHashMap();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            JsonObject obj = it.next().getAsJsonObject();</span><br><span class="line">            String hashKey = obj.get(<span class="string">"tableName"</span>).getAsString();</span><br><span class="line">            Long value = obj.get(<span class="string">"idValue"</span>).getAsLong();</span><br><span class="line">            <span class="keyword">if</span> (Strings.isNullOrEmpty(hashKey) || value == <span class="keyword">null</span> || value &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                valid = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Long newValue = RedisAccessFactory.getDefaultRedisAccess()</span><br><span class="line">                    .getMappedLong(schemaName + <span class="string">"_SEQID"</span>, hashKey);</span><br><span class="line">            <span class="keyword">if</span> (newValue == <span class="keyword">null</span> || newValue &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                valid = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (value - <span class="number">1000</span> &lt;= newValue) &#123;</span><br><span class="line">                valid = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            datas.put(hashKey, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!valid) &#123;</span><br><span class="line">            json.addProperty(<span class="string">"message"</span>, <span class="string">"本次设置ID最大值失败：设置的最大值必须大于当前最大值1000"</span>);</span><br><span class="line">            <span class="keyword">return</span> json;</span><br><span class="line">        &#125;</span><br><span class="line">        Iterator&lt;Entry&lt;String, Long&gt;&gt; it1 = datas.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (it1.hasNext()) &#123;</span><br><span class="line">            Entry&lt;String, Long&gt; entry = it1.next();</span><br><span class="line">            String hashKey = entry.getKey();</span><br><span class="line">            Long value = entry.getValue();</span><br><span class="line">            String idGenerator = DataSourceFactory.instance().getDefaultDataSource().getIdGenerator();</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"Even"</span>.equals(idGenerator)) &#123;</span><br><span class="line">                value = AbstractIdGenerator.getEvenId(value);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"Odd"</span>.equals(idGenerator)) &#123;</span><br><span class="line">                value = AbstractIdGenerator.getOddId(value);</span><br><span class="line">            &#125;</span><br><span class="line">            RedisAccessFactory.getDefaultRedisAccess()</span><br><span class="line">                .putMappedLong(schemaName + <span class="string">"_SEQID"</span>, hashKey, value);</span><br><span class="line">        &#125;</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        json.addProperty(<span class="string">"message"</span>, <span class="string">"设置数据表最大ID失败"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-2-js新增代码"><a href="#2-4-2-js新增代码" class="headerlink" title="2.4.2. js新增代码"></a>2.4.2. <code>js</code>新增代码</h4><blockquote><p><code>js</code>新增代码属于平台对ID管理的菜单配置和属性修改配置</p></blockquote><blockquote><p>新增文件路径为<code>Platform Manager\WebRoot\app\framework\manager\class</code>，以下两个js文件均新增在该路径下</p></blockquote><h5 id="2-4-2-1-菜单新增"><a href="#2-4-2-1-菜单新增" class="headerlink" title="2.4.2.1. 菜单新增"></a>2.4.2.1. 菜单新增</h5><blockquote><p>新增<code>ApplicationIdManager.js</code>文件</p></blockquote><blockquote><p>代码如下：</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">AscApp.ClassManager.registerClass(&#123;</span><br><span class="line">    <span class="comment">// 类型</span></span><br><span class="line">    type : <span class="string">'ApplicationIdManager'</span>,</span><br><span class="line">    <span class="comment">// 名称</span></span><br><span class="line">    caption : <span class="string">'ID管理'</span>,</span><br><span class="line">    <span class="comment">// 属性定义</span></span><br><span class="line">    <span class="comment">// 编辑器定义</span></span><br><span class="line">    editors : [&#123;</span><br><span class="line">        title : <span class="string">'运行状态管理'</span>,</span><br><span class="line">        jspUrl : <span class="string">'manager/apptableid/application.table.id'</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="2-4-2-2-属性新增"><a href="#2-4-2-2-属性新增" class="headerlink" title="2.4.2.2. 属性新增"></a>2.4.2.2. 属性新增</h5><blockquote><p>新增<code>TableId.js</code>文件</p></blockquote><blockquote><p>代码如下</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">AscApp.ClassManager.registerClass(&#123;</span><br><span class="line">    <span class="comment">// 类型</span></span><br><span class="line">    type : <span class="string">'TableId'</span>,</span><br><span class="line">    <span class="comment">// 名称</span></span><br><span class="line">    caption : <span class="string">'数据表ID配置'</span>,</span><br><span class="line">    <span class="comment">// 属性定义</span></span><br><span class="line">    properties : [&#123;</span><br><span class="line">        name : <span class="string">'tableName'</span>,</span><br><span class="line">        text : <span class="string">'数据表名'</span>,</span><br><span class="line">        editor : <span class="string">'none'</span>,</span><br><span class="line">        description : <span class="string">'数据表记录ID（唯一）。'</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        name : <span class="string">'idValue'</span>,</span><br><span class="line">        text : <span class="string">'数据表ID值'</span>,</span><br><span class="line">        editor : <span class="string">'number'</span>,</span><br><span class="line">        description : <span class="string">'数据表当前最大ID。'</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="comment">// 列表编辑字段</span></span><br><span class="line">    propertyColumns : &#123;</span><br><span class="line">        <span class="string">'tableName'</span>:&#123;<span class="attr">width</span>: <span class="number">350</span>, <span class="attr">flex</span>: <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="string">'idValue'</span>:&#123;<span class="attr">width</span>: <span class="number">200</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="2-4-3-jsp新增代码"><a href="#2-4-3-jsp新增代码" class="headerlink" title="2.4.3. jsp新增代码"></a>2.4.3. <code>jsp</code>新增代码</h4><blockquote><p><code>jsp</code>代码属于<code>ID</code>的查询和修改界面代码</p></blockquote><h5 id="2-4-3-1-创建文件夹"><a href="#2-4-3-1-创建文件夹" class="headerlink" title="2.4.3.1. 创建文件夹"></a>2.4.3.1. 创建文件夹</h5><blockquote><p>在路径<code>Platform Manager\WebRoot\WEB-INF\jsp\manager</code>下创建名字为<code>apptableid</code>的文件夹</p></blockquote><h5 id="2-4-3-2-页面新增"><a href="#2-4-3-2-页面新增" class="headerlink" title="2.4.3.2. 页面新增"></a>2.4.3.2. 页面新增</h5><blockquote><p>新增<code>application.table.id.jsp</code>文件</p></blockquote><blockquote><p>在路径<code>Platform Manager\WebRoot\WEB-INF\jsp\manager\apptableid</code>下创建<code>application.table.id.jsp</code>文件</p></blockquote><blockquote><p>代码如下：</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@page contentType=<span class="string">"text/html;charset=UTF-8"</span>%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="built_in">String</span> panelid = request.getParameter(<span class="string">"panelid"</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">Ext.onReady(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> panel = Ext.getCmp(<span class="string">'&lt;%=panelid%&gt;'</span>);</span><br><span class="line">    <span class="keyword">var</span> type = <span class="string">'TableId'</span>;</span><br><span class="line">    <span class="keyword">var</span> typeClass = AscApp.ClassManager.getClass(type);</span><br><span class="line">    <span class="comment">// 获得对象属性列表</span></span><br><span class="line">    <span class="keyword">var</span> properties = AscApp.ClassManager.getProperties(type);</span><br><span class="line">    <span class="comment">// 初始化视图列</span></span><br><span class="line">    <span class="keyword">var</span> columns = AscApp.ClassManager.getGridColumns(properties, typeClass.propertyColumns);</span><br><span class="line">    <span class="comment">// 初始化存储字段</span></span><br><span class="line">    <span class="keyword">var</span> fields = AscApp.ClassManager.getStoreFields(properties);</span><br><span class="line"></span><br><span class="line">    panel.schemaName = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> editor = Ext.create(<span class="string">'Asc.extension.JspPanel'</span>, &#123;</span><br><span class="line">        disabled : <span class="literal">true</span>,</span><br><span class="line">        layout : <span class="string">'fit'</span>,</span><br><span class="line">        region : <span class="string">'east'</span>,</span><br><span class="line">        split : <span class="literal">true</span>,</span><br><span class="line">        border : <span class="literal">false</span>,</span><br><span class="line">        collapseMode:<span class="string">'mini'</span>,</span><br><span class="line">        width : <span class="number">350</span>,</span><br><span class="line">        minWidth : <span class="number">200</span>,</span><br><span class="line">        title : <span class="string">'属性编辑窗口'</span>,</span><br><span class="line">        iconCls : <span class="string">'icon-manager-property'</span>,</span><br><span class="line">        jspUrl : <span class="string">'manager/properties.editor'</span>,</span><br><span class="line">        params : &#123;<span class="attr">type</span> : type&#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> store = <span class="keyword">new</span> Ext.data.Store(&#123;</span><br><span class="line">        clearRemovedOnLoad : <span class="literal">true</span>,</span><br><span class="line">        pageSize : <span class="number">30</span>,<span class="comment">//每页显示几条数据(初始值)</span></span><br><span class="line">        proxy : &#123;</span><br><span class="line">            type : <span class="string">'direct'</span>,</span><br><span class="line">            directFn : ManagerAppDirect.listSchemaTableId,</span><br><span class="line">            extraParams : &#123;</span><br><span class="line">                relationId : <span class="string">''</span></span><br><span class="line">            &#125;,</span><br><span class="line">            paramOrder : <span class="string">'schemaName'</span>,</span><br><span class="line">            paramsAsHash : <span class="literal">true</span>,</span><br><span class="line">            reader : &#123;</span><br><span class="line">                type: <span class="string">'json'</span>,</span><br><span class="line">                root : <span class="string">'datas'</span>,</span><br><span class="line">                totalProperty : <span class="string">'total'</span>,</span><br><span class="line">                successProperty : <span class="string">'successed'</span>,</span><br><span class="line">                messageProperty : <span class="string">'message'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        fields : fields,</span><br><span class="line">        listeners : &#123;</span><br><span class="line">            <span class="string">'beforeload'</span> : <span class="function"><span class="keyword">function</span>(<span class="params">s, operation, eOpts</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> schemaNameValue = textfield.getValue();</span><br><span class="line">                <span class="keyword">if</span> (schemaNameValue) &#123;</span><br><span class="line">                    operation.params = &#123;<span class="attr">schemaName</span>: schemaNameValue&#125;;</span><br><span class="line">                    panel.schemaName = schemaNameValue;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询框</span></span><br><span class="line">    <span class="keyword">var</span> textfield = <span class="keyword">new</span> Ext.form.TextField(&#123;</span><br><span class="line">        width : <span class="number">180</span>,</span><br><span class="line">        emptyText : <span class="string">'输入数据库实例名'</span>,</span><br><span class="line">        enableKeyEvents : <span class="literal">true</span>,</span><br><span class="line">        listeners : &#123;</span><br><span class="line">            <span class="string">'specialkey'</span> : <span class="function"><span class="keyword">function</span> (<span class="params">field, e</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (e.getKey() == e.ENTER) &#123;</span><br><span class="line">                    store.load();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> grid = Ext.create(<span class="string">'Ext.grid.Panel'</span>, &#123;</span><br><span class="line">        region : <span class="string">'center'</span>,</span><br><span class="line">        border : <span class="literal">false</span>,</span><br><span class="line">        sortableColumns : <span class="literal">false</span>,</span><br><span class="line">        viewConfig: &#123;<span class="attr">stripeRows</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">        allowDeselect : <span class="literal">true</span>,</span><br><span class="line">        columns : columns,</span><br><span class="line">        store : store,</span><br><span class="line"><span class="comment">//      width : 800,</span></span><br><span class="line">        split : <span class="literal">true</span>,</span><br><span class="line">        tbar : [textfield, &#123;</span><br><span class="line">            text : <span class="string">'搜索'</span>,</span><br><span class="line">            iconCls : <span class="string">'icon-sys-search'</span>,</span><br><span class="line">            handler : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                store.load();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">'-'</span>, &#123;</span><br><span class="line">            text : <span class="string">'刷新'</span>,</span><br><span class="line">            iconCls : <span class="string">'icon-sys-refresh'</span>,</span><br><span class="line">            handler : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                grid.getStore().reload();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选中</span></span><br><span class="line">    grid.on(<span class="string">'selectionchange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">g, selected</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(selected.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            editor.loadRecord(selected[<span class="number">0</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            editor.clearRecord();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    panel.doApply = panel.doSave = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> updateRecs = grid.getStore().getUpdatedRecords();</span><br><span class="line">        <span class="keyword">if</span>(updateRecs.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> datas = [];</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> updateRecs)&#123;</span><br><span class="line">                <span class="keyword">var</span> record = updateRecs[i];</span><br><span class="line">                datas.push(&#123;</span><br><span class="line">                    <span class="string">'tableName'</span>: record.get(<span class="string">'tableName'</span>),</span><br><span class="line">                    <span class="string">'idValue'</span>: record.get(<span class="string">'idValue'</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            ManagerAppDirect.saveSchemaTableId(panel.schemaName, datas, <span class="function"><span class="keyword">function</span>(<span class="params">result, e</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(result &amp;&amp; result.success)&#123;</span><br><span class="line">                    Asc.common.Message.showInfo(<span class="string">'设置数据表ID最大值成功！'</span>);</span><br><span class="line">                    grid.getStore().reload();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result &amp;&amp; result.message) &#123;</span><br><span class="line">                    Asc.common.Message.showError(result.message);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Asc.common.Message.showError(<span class="string">'保存对象操作失败！'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Asc.common.Message.showError(<span class="string">'当前无修改数据，需要修改后再保存！'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示界面</span></span><br><span class="line">    panel.add(&#123;</span><br><span class="line">        layout : <span class="string">'border'</span>,</span><br><span class="line">        border : <span class="literal">false</span>,</span><br><span class="line">        items : [grid, editor]</span><br><span class="line">    &#125;);</span><br><span class="line">    panel.doLayout();</span><br><span class="line">&#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-5-在线监控升级"><a href="#2-5-在线监控升级" class="headerlink" title="2.5. 在线监控升级"></a>2.5. 在线监控升级</h3><blockquote><p>属于用户在线监控功能升级配置</p></blockquote><blockquote><p>该功能主要用于监控在线用户、统计用户（当日、当月、当年、任意一天、某个时间段内）登录人次并通过折线图的方式展示</p></blockquote><blockquote><p>该功能属于<code>manager</code>应用，功能菜单位于<code>应用运行管理</code>菜单下</p></blockquote><h4 id="2-5-1java类新增代码"><a href="#2-5-1java类新增代码" class="headerlink" title="2.5.1java类新增代码"></a>2.5.1<code>java</code>类新增代码</h4><h5 id="2-5-1-1-常量定义新增"><a href="#2-5-1-1-常量定义新增" class="headerlink" title="2.5.1.1. 常量定义新增"></a>2.5.1.1. 常量定义新增</h5><blockquote><p><code>CommonTextFolderNode</code>类新增<code>在线用户列表</code>和<code>在线用户统计</code>的菜单<code>KEY</code>常量定义代码</p></blockquote><blockquote><p>类全路径为<code>com.asc.manager.navigator.node.CommonTextFolderNode</code>，新增代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_ONLINE_USER_LIST = <span class="string">"ApplicationOnlineUserManager"</span>;<span class="comment">//在线用户列表</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_ONLINE_USER_STATISTICS = <span class="string">"ApplicationOnlineUserStatistics"</span>;<span class="comment">//在线用户统计</span></span><br></pre></td></tr></table></figure><h5 id="2-5-1-2-菜单新增"><a href="#2-5-1-2-菜单新增" class="headerlink" title="2.5.1.2. 菜单新增"></a>2.5.1.2. 菜单新增</h5><blockquote><p><code>ApplicationManagerFolderLoader</code>类新增应用运行管理下子菜单<code>在线用户列表</code>和<code>在线用户统计</code>代码</p></blockquote><blockquote><p>类全路径为<code>com.asc.manager.navigator.loader.ApplicationManagerFolderLoader</code>，新增代码如下：</p></blockquote><blockquote><p>在方法<code>getChildren</code>里，新增代码写在<code>日志管理</code>后面</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node = <span class="keyword">new</span> CommonTextFolderNode(CommonTextFolderNode.TYPE_ONLINE_USER_LIST, key, <span class="string">"在线用户列表"</span>, <span class="keyword">true</span>);</span><br><span class="line">nodes.add(node);</span><br><span class="line">node = <span class="keyword">new</span> CommonTextFolderNode(CommonTextFolderNode.TYPE_ONLINE_USER_STATISTICS, key, <span class="string">"在线用户统计"</span>, <span class="keyword">true</span>);</span><br><span class="line">nodes.add(node);</span><br></pre></td></tr></table></figure><h5 id="2-5-1-3-接口新增"><a href="#2-5-1-3-接口新增" class="headerlink" title="2.5.1.3. 接口新增"></a>2.5.1.3. 接口新增</h5><blockquote><p><code>ManagerAppDirect</code>类新增<code>获取在线用户列表</code>查询接口、<code>查询自定义x轴下拉数据</code>接口、<code>查询某个用户的登录历史记录</code>接口、<code>获取当前在线人数，当日登录人次，当月登录人次</code>接口、<code>统计登录用户人次(折线图)</code>接口代码</p></blockquote><blockquote><p>类全路径<code>com.asc.manager.direct.ManagerAppDirect</code>，新增代码如下：</p></blockquote><blockquote><p>追加方法<code>onlineUser</code>（获取在线用户列表），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonObject <span class="title">onlineUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        JsonArray datas = OnlineUserHandler.instance().listOnlineUser();</span><br><span class="line">        json.add(<span class="string">"datas"</span>, datas);</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">        json.addProperty(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>追加方法<code>listCustomXAxis</code>（在线用户统计 - 查询自定义x轴下拉数据），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonObject <span class="title">listCustomXAxis</span><span class="params">(JsonObject params)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        JsonArray datas = CustomXAxisEnum.listCustomXAxisVO();</span><br><span class="line">        json.add(<span class="string">"datas"</span>, datas);</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">        json.addProperty(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>追加方法<code>loginHistory</code>（在线用户列表 - 查询某个用户的登录历史记录），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonObject <span class="title">loginHistory</span><span class="params">(JsonObject params, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        JsonArray datas = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (params.has(<span class="string">"loginName"</span>) || !params.get(<span class="string">"loginName"</span>).isJsonNull()) &#123;</span><br><span class="line">            datas = OnlineUserHandler.instance().loginHistory(params.get(<span class="string">"loginName"</span>).getAsString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        json.add(<span class="string">"datas"</span>, datas);</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">        json.addProperty(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>追加方法<code>curDayMonthUser</code>（在线用户统计 - 获取当前在线人数，当日登录人次，当月登录人次），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonObject <span class="title">curDayMonthUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        JsonObject data = OnlineUserHandler.instance().curDayMonthUser();</span><br><span class="line">        json.add(<span class="string">"data"</span>, data);</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">        json.addProperty(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>追加方法<code>listStatisticsLoginUser</code>（在线用户统计 - 统计登录用户人次(折线图)），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> JsonObject <span class="title">listStatisticsNodeBrowserLoginUser</span><span class="params">(JsonObject params)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (!params.has(<span class="string">"data"</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"参数错误，请指定统计的维度（当日、当月、当年、选择某一天、自定义时间！）"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           JsonArray datas = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">if</span> (!params.has(<span class="string">"type"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (<span class="string">"day"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())</span><br><span class="line">                       || <span class="string">"any"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                   datas = OnlineUserHandler.instance().listStatisticsDayLoginUser(params.has(<span class="string">"date"</span>) ? params.get(<span class="string">"date"</span>).getAsString() : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"month"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                   datas = OnlineUserHandler.instance().listStatisticsMonthLoginUser();</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"year"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                   datas = OnlineUserHandler.instance().listStatisticsYearLoginUser();</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"custom"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                   JsonObject value = params.get(<span class="string">"value"</span>) != <span class="keyword">null</span> ? params.get(<span class="string">"value"</span>).getAsJsonObject() : <span class="keyword">null</span>;</span><br><span class="line">                   <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       CustomLineReqDTO customLineReqDTO = JsonObjectTool.jsonObject2Object(value, CustomLineReqDTO.class);</span><br><span class="line">                       datas = OnlineUserHandler.instance().listCustomStatisticsLoginUser(customLineReqDTO);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (<span class="string">"day"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())</span><br><span class="line">                       || <span class="string">"any"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                   datas = OnlineUserHandler.instance().listCurDayStatistics(params.get(<span class="string">"type"</span>).getAsString(), params.has(<span class="string">"date"</span>) ? params.get(<span class="string">"date"</span>).getAsString() : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"month"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                   datas = OnlineUserHandler.instance().listStatisticsCurMonth(params.get(<span class="string">"type"</span>).getAsString());</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"year"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                   datas = OnlineUserHandler.instance().listCurYesrStatistics(params.get(<span class="string">"type"</span>).getAsString());</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"custom"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                   JsonObject value = params.get(<span class="string">"value"</span>) != <span class="keyword">null</span> ? params.get(<span class="string">"value"</span>).getAsJsonObject() : <span class="keyword">null</span>;</span><br><span class="line">                   <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       CustomLineReqDTO customLineReqDTO = JsonObjectTool.jsonObject2Object(value, CustomLineReqDTO.class);</span><br><span class="line">                       datas = OnlineUserHandler.instance().listStatisticsCustom(customLineReqDTO, params.get(<span class="string">"type"</span>).getAsString());</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">           json.add(<span class="string">"datas"</span>, datas);</span><br><span class="line">           json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">           json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">           json.addProperty(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> json;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><blockquote><p>追加方法<code>listStatisticsNodeBrowserLoginUserPie</code>（在线用户统计 - 统计登录用户人次(饼状图)），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonObject <span class="title">listStatisticsNodeBrowserLoginUserPie</span><span class="params">(JsonObject params)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!params.has(<span class="string">"data"</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"参数错误，请指定统计的维度（当日、当月、当年、选择某一天、自定义时间！）"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            JsonArray datas = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"day"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())</span><br><span class="line">                    || <span class="string">"any"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                datas = OnlineUserPieStatisticsHandler.instance().statisticsDayPie(params.has(<span class="string">"type"</span>) ? params.get(<span class="string">"type"</span>).getAsString() : <span class="keyword">null</span>,</span><br><span class="line">                        params.has(<span class="string">"date"</span>) ? params.get(<span class="string">"date"</span>).getAsString() : <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"month"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                datas = OnlineUserPieStatisticsHandler.instance().statisticsCurMonthPie(params.has(<span class="string">"type"</span>) ? params.get(<span class="string">"type"</span>).getAsString() : <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"year"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                datas = OnlineUserPieStatisticsHandler.instance().statisticsCurYearPie(params.has(<span class="string">"type"</span>) ? params.get(<span class="string">"type"</span>).getAsString() : <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"custom"</span>.equals(params.get(<span class="string">"data"</span>).getAsString())) &#123;</span><br><span class="line">                JsonObject value = params.get(<span class="string">"value"</span>) != <span class="keyword">null</span> ? params.get(<span class="string">"value"</span>).getAsJsonObject() : <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    CustomLineReqDTO customLineReqDTO = JsonObjectTool.jsonObject2Object(value, CustomLineReqDTO.class);</span><br><span class="line">                    datas = OnlineUserPieStatisticsHandler.instance().listCustomStatisticsLoginUser(customLineReqDTO, params.has(<span class="string">"type"</span>) ? params.get(<span class="string">"type"</span>).getAsString() : <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            json.add(<span class="string">"datas"</span>, datas);</span><br><span class="line">            json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">            json.addProperty(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>追加方法<code>browserField</code>（在线用户统计 - 按浏览器类型统计获取折线图统计的字段），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonObject <span class="title">browserField</span><span class="params">(JsonObject params)</span> </span>&#123;</span><br><span class="line">        JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!params.has(<span class="string">"data"</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"参数错误，请指定统计的维度（当日、当月、当年、选择某一天、自定义时间！）"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            JsonArray datas = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (params.has(<span class="string">"type"</span>)) &#123;</span><br><span class="line">                datas = OnlineUserHandler.instance().browserField(params.get(<span class="string">"type"</span>).getAsString());</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                datas = <span class="keyword">new</span> JsonArray();</span><br><span class="line">                datas.add(<span class="string">"f_user_count"</span>);</span><br><span class="line">                datas.add(<span class="string">"time"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            json.add(<span class="string">"datas"</span>, datas);</span><br><span class="line">            json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">            json.addProperty(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>类全路径<code>com.asc.manager</code>新增<code>onlineuser</code>包，全路径为com.asc.manager.onlineuser，在全路径com.asc.manager.onlineuser下还新增其他包，全路径如下：</p><ul><li><code>com.asc.manager.onlineuser.constant</code></li><li><code>com.asc.manager.onlineuser.entity</code></li><li><code>com.asc.manager.onlineuser.exception</code></li><li>com.asc.manager.onlineuser.params<ul><li><code>com.asc.manager.onlineuser.params.req</code></li><li><code>com.asc.manager.onlineuser.params.resp</code></li></ul></li><li><code>com.asc.manager.onlineuser.service</code><ul><li><code>com.asc.manager.onlineuser.service.imp</code></li></ul></li><li><code>com.asc.manager.onlineuser.utils</code><ul><li><code>com.asc.manager.onlineuser.utils.db</code></li></ul></li></ul></blockquote><blockquote><p>在全路径<code>com.asc.manager.onlineuser.constant</code>下新增了<code>CustomXAxisEnum</code>和<code>UserOnlineEnum</code>两个枚举类</p><p><code>CustomXAxisEnum</code>（自定义x轴下拉数据）代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> CustomXAxisEnum &#123;</span><br><span class="line">    MONTH(<span class="string">"month"</span>, <span class="string">"月"</span>),</span><br><span class="line">    DAY(<span class="string">"day"</span>, <span class="string">"天"</span>),</span><br><span class="line">    HOUR(<span class="string">"hour"</span>, <span class="string">"小时"</span>),</span><br><span class="line">    M30(<span class="string">"30m"</span>, <span class="string">"30分钟"</span>),</span><br><span class="line"><span class="comment">//    M10("10m", "10分钟"),</span></span><br><span class="line"><span class="comment">//    M1("1m", "1分钟"),</span></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">    CustomXAxisEnum(String key, String value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JsonArray <span class="title">listCustomXAxisVO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LinkedList&lt;CustomXAxisComboVO&gt; listCustomXAxisVO = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        CustomXAxisEnum[] values = CustomXAxisEnum.values();</span><br><span class="line">        <span class="keyword">for</span> (CustomXAxisEnum customXAxisEnum : values) &#123;</span><br><span class="line">            CustomXAxisComboVO customXAxisVO = <span class="keyword">new</span> CustomXAxisComboVO(customXAxisEnum.getKey(), customXAxisEnum.getValue());</span><br><span class="line">            listCustomXAxisVO.add(customXAxisVO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonObjectTool.objectList2JsonArray(listCustomXAxisVO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CustomXAxisEnum <span class="title">getByKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (CustomXAxisEnum constants : values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (constants.getKey().equalsIgnoreCase(key)) &#123;</span><br><span class="line">                <span class="keyword">return</span> constants;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String MM = <span class="string">"MM"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String DD = <span class="string">"DD"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String HH24 = <span class="string">"HH24"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String MINUTE30 = <span class="string">"MINUTE30"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取自定义日期按x轴（月、天、小时、30分钟、10分钟、1分钟）其中的一个进行统计</span></span><br><span class="line"><span class="comment">     * @date 2020/5/8 17:16</span></span><br><span class="line"><span class="comment">     * @param customXAxisComboVO</span></span><br><span class="line"><span class="comment">     * @return java.lang.String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCustomGroupStatistics</span><span class="params">(String xaxis)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (CustomXAxisEnum.getByKey(xaxis)) &#123;</span><br><span class="line">            <span class="keyword">case</span> MONTH:</span><br><span class="line">                <span class="keyword">return</span> MM;</span><br><span class="line">            <span class="keyword">case</span> DAY:</span><br><span class="line">                <span class="keyword">return</span> DD;</span><br><span class="line">            <span class="keyword">case</span> HOUR:</span><br><span class="line">                <span class="keyword">return</span> HH24;</span><br><span class="line">            <span class="keyword">case</span> M30:</span><br><span class="line">                <span class="keyword">return</span> MINUTE30;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> MM;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>UserOnlineEnum</code>（用户在线状态）代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> UserOnlineEnum &#123;</span><br><span class="line">    LOGIN(<span class="string">"登录"</span>),</span><br><span class="line">    LOGOUT(<span class="string">"logout"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line"></span><br><span class="line">    UserOnlineEnum(String state) &#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在全路径<code>com.asc.manager.onlineuser.entity</code>下新增了<code>OnlineUser</code>和<code>UserLogCas</code>两个实体类</p><p><code>OnlineUser</code>（在线用户）代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnlineUser</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 登录名 */</span></span><br><span class="line">    <span class="keyword">private</span> String loginName;</span><br><span class="line">    <span class="comment">/* 登录时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Long loginTime;</span><br><span class="line">    <span class="comment">/* 更新时间 */</span></span><br><span class="line">    <span class="keyword">private</span> Long updateTime;</span><br><span class="line">    <span class="comment">/* 在线时长 */</span></span><br><span class="line">    <span class="keyword">private</span> String onlineTime;</span><br><span class="line">    <span class="comment">/* 浏览器 */</span></span><br><span class="line">    <span class="keyword">private</span> String agent;</span><br><span class="line">    <span class="comment">/* 应用节点 */</span></span><br><span class="line">    <span class="keyword">private</span> String f_node_id;</span><br><span class="line">    <span class="comment">/* 姓名 */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/* 所在机构 */</span></span><br><span class="line">    <span class="keyword">private</span> String org;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String ticket;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLoginName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loginName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginName</span><span class="params">(String loginName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loginName = loginName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getLoginTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loginTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginTime</span><span class="params">(Long loginTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loginTime = loginTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getUpdateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUpdateTime</span><span class="params">(Long updateTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.updateTime = updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOnlineTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> onlineTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnlineTime</span><span class="params">(String onlineTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onlineTime = onlineTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAgent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> agent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAgent</span><span class="params">(String agent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.agent = agent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_node_id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_node_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_node_id</span><span class="params">(String f_node_id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_node_id = f_node_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOrg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> org;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrg</span><span class="params">(String org)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.org = org;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTicket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ticket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTicket</span><span class="params">(String ticket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ticket = ticket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHost</span><span class="params">(String host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>UserLogCas</code>（用户登录日志类），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span>(tableName = <span class="string">"T_ASC_LOG_CAS"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserLogCas</span> <span class="keyword">extends</span> <span class="title">DbAccessSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String f_application_id;  <span class="comment">//应用名</span></span><br><span class="line">    <span class="keyword">private</span> String f_resource_id;  <span class="comment">//</span></span><br><span class="line">    <span class="keyword">private</span> String f_action_name;  <span class="comment">//登录或登出</span></span><br><span class="line">    <span class="keyword">private</span> String f_type;  <span class="comment">//类别</span></span><br><span class="line">    <span class="keyword">private</span> String f_level;  <span class="comment">//级别</span></span><br><span class="line">    <span class="keyword">private</span> String f_log;  <span class="comment">//记录</span></span><br><span class="line">    <span class="keyword">private</span> String f_detail;  <span class="comment">//详细信息</span></span><br><span class="line">    <span class="keyword">private</span> String f_threadid;  <span class="comment">//线程id</span></span><br><span class="line">    <span class="keyword">private</span> String f_successed;  <span class="comment">//成功</span></span><br><span class="line">    <span class="keyword">private</span> String f_user_id;  <span class="comment">//用户号</span></span><br><span class="line">    <span class="keyword">private</span> String f_user_name;  <span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">private</span> String f_user_host;  <span class="comment">//用户登录id</span></span><br><span class="line">    <span class="keyword">private</span> String f_user_agent;  <span class="comment">//用户登录设备</span></span><br><span class="line">    <span class="keyword">private</span> String f_terminal_type;  <span class="comment">//终端类型：电脑浏览器/移动端</span></span><br><span class="line">    <span class="keyword">private</span> String f_ticket_id;  <span class="comment">//</span></span><br><span class="line">    <span class="keyword">private</span> String f_request_url;  <span class="comment">//请求路径</span></span><br><span class="line">    <span class="keyword">private</span> Date f_create_time;  <span class="comment">//创建时间</span></span><br><span class="line">    <span class="keyword">private</span> Date f_update_time;  <span class="comment">//变更修改时间</span></span><br><span class="line">    <span class="keyword">private</span> String f_node_id;  <span class="comment">//应用节点</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserLogCas</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_application_id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_application_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_application_id</span><span class="params">(String f_application_id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_application_id = f_application_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_resource_id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_resource_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_resource_id</span><span class="params">(String f_resource_id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_resource_id = f_resource_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_action_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_action_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_action_name</span><span class="params">(String f_action_name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_action_name = f_action_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_type</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_type</span><span class="params">(String f_type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_type = f_type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_level</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_level</span><span class="params">(String f_level)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_level = f_level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_log</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_log;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_log</span><span class="params">(String f_log)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_log = f_log;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_detail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_detail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_detail</span><span class="params">(String f_detail)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_detail = f_detail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_threadid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_threadid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_threadId</span><span class="params">(String f_threadid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_threadid = f_threadid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_successed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_successed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_successed</span><span class="params">(String f_successed)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_successed = f_successed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_user_id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_user_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_user_id</span><span class="params">(String f_user_id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_user_id = f_user_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_user_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_user_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_user_name</span><span class="params">(String f_user_name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_user_name = f_user_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_user_host</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_user_host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_user_host</span><span class="params">(String f_user_host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_user_host = f_user_host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_user_agent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_user_agent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_user_agent</span><span class="params">(String f_user_agent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_user_agent = f_user_agent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_terminal_type</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_terminal_type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_terminal_type</span><span class="params">(String f_terminal_type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_terminal_type = f_terminal_type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_ticket_id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_ticket_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_ticket_id</span><span class="params">(String f_ticket_id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_ticket_id = f_ticket_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_request_url</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_request_url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_request_url</span><span class="params">(String f_request_url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_request_url = f_request_url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getF_create_time</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_create_time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_create_time</span><span class="params">(Date f_create_time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_create_time = f_create_time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getF_update_time</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_update_time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_update_time</span><span class="params">(Date f_update_time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_update_time = f_update_time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_node_id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_node_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_node_id</span><span class="params">(String f_node_id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_node_id = f_node_id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在全路径<code>com.asc.manager.onlineuser.exception</code>下，新增了<code>OnlineUserException</code>异常类</p><p><code>OnlineUserException</code>（处理用户在线过程中出现的异常），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnlineUserException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Exception originalE;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnlineUserException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnlineUserException</span><span class="params">(String message, Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, e);</span><br><span class="line">        originalE = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printStack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.originalE != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.originalE.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OnlineUserException <span class="title">forDataServiceError</span><span class="params">(String message, Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OnlineUserException(message, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在全路径<code>com.asc.manager.onlineuser.params.req</code>下，新增了<code>CurrDayMonthUserDTO</code>、<code>CustomLineReqDTO</code>、<code>LoginUserStatisticsDTO</code>、<code>LoginUserStatisticsPieDTO</code> 数据传输类。</p><p><code>CurrDayMonthUserDTO</code>（记录当前在线人数，当日登录人次，当月登录人次），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CurrDayMonthUserDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 当前在线用户人数 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer f_curr_user;</span><br><span class="line">    <span class="comment">/* 当日登录人次 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer f_day_user;</span><br><span class="line">    <span class="comment">/* 当月登录人次 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer f_month_user;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getF_curr_user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_curr_user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_curr_user</span><span class="params">(Integer f_curr_user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_curr_user = f_curr_user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getF_day_user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_day_user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_day_user</span><span class="params">(Integer f_day_user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_day_user = f_day_user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getF_month_user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_month_user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_month_user</span><span class="params">(Integer f_month_user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_month_user = f_month_user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>CustomLineReqDTO</code>（自定义折线图统计参数），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomLineReqDTO</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* x轴 */</span></span><br><span class="line">    <span class="keyword">private</span> String f_xaxis;</span><br><span class="line">    <span class="comment">/* 开始时间 */</span></span><br><span class="line">    <span class="keyword">private</span> String f_startdate;</span><br><span class="line">    <span class="comment">/* 结束时间 */</span></span><br><span class="line">    <span class="keyword">private</span> String f_enddate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_xaxis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_xaxis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_xaxis</span><span class="params">(String f_xaxis)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_xaxis = f_xaxis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_startdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_startdate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_startdate</span><span class="params">(String f_startdate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_startdate = f_startdate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getF_enddate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_enddate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_enddate</span><span class="params">(String f_enddate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_enddate = f_enddate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>LoginUserStatisticsDTO</code>（在线用户统计 - 统计当天、当月、当年登录用户人次），代码如下：‘</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginUserStatisticsDTO</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 人次 */</span></span><br><span class="line">    <span class="keyword">private</span> Integer f_user_count;</span><br><span class="line">    <span class="comment">/* 时间点 */</span></span><br><span class="line">    <span class="keyword">private</span> String time;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录当日二十四小时的登录统计</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; dayLoginUserStatisticsDTOMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当日二十四小时中的每一个小时的数据先赋0值，然后再从数据库中获取到的数据将0值替换</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; <span class="title">getDayLoginUserStatisticsDTOMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dayLoginUserStatisticsDTOMap.size() == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">24</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                    dayLoginUserStatisticsDTOMap.put(<span class="string">"0"</span> + i, <span class="keyword">new</span> LoginUserStatisticsDTO(<span class="number">0</span>, <span class="string">"0"</span> + i));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    dayLoginUserStatisticsDTOMap.put(String.valueOf(i), <span class="keyword">new</span> LoginUserStatisticsDTO(<span class="number">0</span>, String.valueOf(i)));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dayLoginUserStatisticsDTOMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 当月每一天的数据先赋0值，然后再从数据库中获取到的数据将0值替换</span></span><br><span class="line"><span class="comment">     * @date 2020/5/8 9:33</span></span><br><span class="line"><span class="comment">     * @param monthDayCount 每月的天数</span></span><br><span class="line"><span class="comment">     * @return java.util.LinkedHashMap&lt;java.lang.String,com.asc.manager.onlineuser.params.req.LoginUserStatisticsDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; <span class="title">getMonthLoginUserStatisticsDTOMap</span><span class="params">(<span class="keyword">int</span> monthDayCount)</span> </span>&#123;</span><br><span class="line">        LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; monthLoginUserStatisticsDTOMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= monthDayCount; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                monthLoginUserStatisticsDTOMap.put(<span class="string">"0"</span> + i, <span class="keyword">new</span> LoginUserStatisticsDTO(<span class="number">0</span>, <span class="string">"0"</span> + i));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                monthLoginUserStatisticsDTOMap.put(String.valueOf(i), <span class="keyword">new</span> LoginUserStatisticsDTO(<span class="number">0</span>, String.valueOf(i)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> monthLoginUserStatisticsDTOMap;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取两个日期之间的所有月份数据</span></span><br><span class="line"><span class="comment">     * 当始日期和结束日期时间段内的每一个月的数据先赋0值，然后再从数据库中获取到的数据将0值替换</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xaxis</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startTime 开始日期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endTime   结束日期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; <span class="title">getMonthLoginUserStatisticsDTOMap</span><span class="params">(String xaxis, String startTime, String endTime)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        <span class="comment">// 日期集合</span></span><br><span class="line">        List&lt;String&gt; dates = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        String dateFormatPatten = <span class="string">"yyyy-MM"</span>;</span><br><span class="line">        <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.DD)) &#123;</span><br><span class="line">            dateFormatPatten = <span class="string">"yyyy-MM-dd"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.HH24)) &#123;</span><br><span class="line">            dateFormatPatten = <span class="string">"yyyy-MM-dd HH"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; monthLoginUserStatisticsDTOMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(dateFormatPatten);</span><br><span class="line">        Date start = dateFormat.parse(startTime);</span><br><span class="line">        Date end = dateFormat.parse(endTime);</span><br><span class="line"></span><br><span class="line">        Calendar tempStart = Calendar.getInstance();</span><br><span class="line">        tempStart.setTime(start);</span><br><span class="line"></span><br><span class="line">        Calendar tempEnd = Calendar.getInstance();</span><br><span class="line">        tempEnd.setTime(end);</span><br><span class="line">        <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.MM)) &#123;</span><br><span class="line">            tempEnd.add(Calendar.MONTH, +<span class="number">1</span>);<span class="comment">// 月份加1(包含结束)</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.DD)) &#123;</span><br><span class="line">            tempEnd.add(Calendar.DAY_OF_MONTH, +<span class="number">1</span>);<span class="comment">// 天数加1(包含结束)</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.HH24)) &#123;</span><br><span class="line">            tempEnd.add(Calendar.HOUR, +<span class="number">1</span>);<span class="comment">// 小时加1(包含结束)</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (tempStart.before(tempEnd)) &#123;</span><br><span class="line"></span><br><span class="line">            dates.add(dateFormat.format(tempStart.getTime()));</span><br><span class="line">            <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.MM)) &#123;</span><br><span class="line">                tempStart.add(Calendar.MONTH, +<span class="number">1</span>);<span class="comment">// 月份加1(包含结束)</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.DD)) &#123;</span><br><span class="line">                tempStart.add(Calendar.DAY_OF_MONTH, +<span class="number">1</span>);<span class="comment">// 天数加1(包含结束)</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.HH24)) &#123;</span><br><span class="line">                tempStart.add(Calendar.HOUR, +<span class="number">1</span>);<span class="comment">// 小时加1(包含结束)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 每一个月的数据先赋0值，然后再从数据库中获取到的数据将0值替换</span></span><br><span class="line">        <span class="keyword">for</span> (String date : dates) &#123;</span><br><span class="line">            monthLoginUserStatisticsDTOMap.put(date, <span class="keyword">new</span> LoginUserStatisticsDTO(<span class="number">0</span>, date));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> monthLoginUserStatisticsDTOMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取两个日期之间的所有间隔三十分钟的数据</span></span><br><span class="line"><span class="comment">     * 当始日期和结束日期时间段内的每间隔三十分钟的数据先赋0值，然后再从数据库中获取到的数据将0值替换</span></span><br><span class="line"><span class="comment">     * @date 2020/5/9 13:53</span></span><br><span class="line"><span class="comment">     * @param startdate</span></span><br><span class="line"><span class="comment">     * @param enddate</span></span><br><span class="line"><span class="comment">     * @return java.util.LinkedHashMap&lt;java.lang.String,com.asc.manager.onlineuser.params.req.LoginUserStatisticsDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; <span class="title">getMinute30LoginUserStatisticsDTOMap</span><span class="params">(String startdate, String enddate)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        <span class="comment">// 日期集合</span></span><br><span class="line">        List&lt;String&gt; dates = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">        LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; minute30LoginUserStatisticsDTOMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm"</span>);</span><br><span class="line">        Date start = dateFormat.parse(startdate);</span><br><span class="line">        Date end = dateFormat.parse(enddate);</span><br><span class="line"></span><br><span class="line">        Calendar tempStart = Calendar.getInstance();</span><br><span class="line">        tempStart.setTime(start);</span><br><span class="line"></span><br><span class="line">        Calendar tempEnd = Calendar.getInstance();</span><br><span class="line">        tempEnd.setTime(end);</span><br><span class="line"></span><br><span class="line">        tempEnd.add(Calendar.MINUTE, +<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (tempStart.before(tempEnd)) &#123;</span><br><span class="line"></span><br><span class="line">            dates.add(dateFormat.format(tempStart.getTime()));</span><br><span class="line">            tempStart.add(Calendar.MINUTE, +<span class="number">30</span>);<span class="comment">// 分钟加30(包含结束)</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 每间隔三十分钟的数据先赋0值，然后再从数据库中获取到的数据将0值替换</span></span><br><span class="line">        <span class="keyword">for</span> (String date : dates) &#123;</span><br><span class="line">            minute30LoginUserStatisticsDTOMap.put(date, <span class="keyword">new</span> LoginUserStatisticsDTO(<span class="number">0</span>, date));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> minute30LoginUserStatisticsDTOMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginUserStatisticsDTO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginUserStatisticsDTO</span><span class="params">(Integer f_user_count, String time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_user_count = f_user_count;</span><br><span class="line">        <span class="keyword">this</span>.time = time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getF_user_count</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> f_user_count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setF_user_count</span><span class="params">(Integer f_user_count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f_user_count = f_user_count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTime</span><span class="params">(String time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.time = time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>LoginUserStatisticsPieDTO</code> （ 在线用户统计（饼状图）），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginUserStatisticsPieDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(<span class="keyword">int</span> data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在全路径<code>com.asc.manager.onlineuser.params.resp</code>下新增<code>CustomXAxisComboVO</code>（在线用户统计 - 自定义x轴下拉数据），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomXAxisComboVO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomXAxisComboVO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomXAxisComboVO</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在全路径<code>com.asc.manager.onlineuser.service</code>下，新增<code>IOnlineUserService</code>（在线用户服务）接口，代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IOnlineUserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取在线用户列表数据</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.entity.OnlineUser&gt;</span></span><br><span class="line"><span class="comment">     * @throws OnlineUserException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;OnlineUser&gt; <span class="title">getOnlineUserList</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在全路径<code>com.asc.manager.onlineuser.service.imp</code>下，新增<code>OnlineUserServiceImp</code>在线用户服务接口的实现类，代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnlineUserServiceImp</span> <span class="keyword">implements</span> <span class="title">IOnlineUserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String casServiceUrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnlineUserServiceImp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> OnlineUserServiceImp singleton;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OnlineUserServiceImp <span class="title">instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">            singleton = ContextHolder.instance().getBean(<span class="string">"OnlineUserServiceImp"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCasServiceUrl</span><span class="params">(String casServiceUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.casServiceUrl = casServiceUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;OnlineUser&gt; <span class="title">getOnlineUserList</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            WebServiceInvoke wsi = <span class="keyword">new</span> WebServiceInvoke(<span class="keyword">this</span>.casServiceUrl, <span class="string">"http://ws.server.cas.asc.com"</span>);</span><br><span class="line">            Object obj = wsi.invoke(<span class="string">"getOnlineUserList"</span>, <span class="keyword">new</span> Object[]&#123;&#125;, <span class="keyword">new</span> Class[]&#123;String.class&#125;);</span><br><span class="line">            String jsonString = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                jsonString = String.valueOf(obj);</span><br><span class="line">                JsonObject result = JsonObjectTool.string2JsonObject(jsonString);</span><br><span class="line">                <span class="keyword">if</span> (!result.has(<span class="string">"success"</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"返回数据未包含可识别的成功标志"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!result.get(<span class="string">"success"</span>).getAsBoolean()) &#123;</span><br><span class="line">                    String msg = result.get(<span class="string">"message"</span>).getAsString();</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"令牌用户信息查询失败,"</span> + msg);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!result.has(<span class="string">"datas"</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(<span class="string">"返回数据未包含在线用户信息"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// convert jsonstring to user object</span></span><br><span class="line">                <span class="keyword">return</span> JsonObjectTool.jsonArray2ObjectList(result.get(<span class="string">"datas"</span>).getAsJsonArray(), OnlineUser.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(<span class="string">"返回数据格式无法识别"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在全路径<code>com.asc.manager.onlineuser.utils</code>下，新增<code>DateUtil</code>工具类，用于结算用户在线时长，代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 毫秒转化日时分秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">formatTime</span><span class="params">(Long ms)</span> </span>&#123;</span><br><span class="line">        Integer ss = <span class="number">1000</span>;</span><br><span class="line">        Integer mi = ss * <span class="number">60</span>;</span><br><span class="line">        Integer hh = mi * <span class="number">60</span>;</span><br><span class="line">        Integer dd = hh * <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">        Long day = ms / dd;</span><br><span class="line">        Long hour = (ms - day * dd) / hh;</span><br><span class="line">        Long minute = (ms - day * dd - hour * hh) / mi;</span><br><span class="line">        Long second = (ms - day * dd - hour * hh - minute * mi) / ss;</span><br><span class="line"></span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">if</span> (day &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            sb.append(day + <span class="string">"天"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hour &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            sb.append(hour + <span class="string">"小时"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (minute &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            sb.append(minute + <span class="string">"分"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (second &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            sb.append(second + <span class="string">"秒"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在全路径<code>com.asc.manager.onlineuser.utils.db</code>下，新增<code>OnlineUserDbUtil</code>和<code>OnlineUserStatisticsPieDbUtil</code>两个数据库访问工具类</p><p><code>OnlineUserDbUtil</code>（获取在线用户列表数据、当前在线用户、今日登录人次、本月登录人次以及折线图数据），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnlineUserDbUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CommonDatabaseAccess <span class="title">getDbAccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CommonDatabaseAccess.instance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;OnlineUser&gt; <span class="title">getOnlineUserList</span><span class="params">(List&lt;OnlineUser&gt; onlineUserList)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select t1.f_user_agent, "</span> +</span><br><span class="line">                    <span class="string">"t1.f_node_id "</span> +</span><br><span class="line">                    <span class="string">"from (select * from T_ASC_LOG_CAS t where t.f_user_name = ? "</span> +</span><br><span class="line">                    <span class="string">"order by t.f_create_time desc)  "</span> +</span><br><span class="line">                    <span class="string">"t1 where rownum = 1"</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; onlineUserList.size(); i++) &#123;</span><br><span class="line">                UserLogCas userLogCas = getDbAccess().getObject(sql, <span class="keyword">new</span> Object[]&#123;onlineUserList.get(i).getLoginName()&#125;, UserLogCas.class);</span><br><span class="line">                <span class="keyword">if</span> (userLogCas != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    onlineUserList.get(i).setF_node_id(userLogCas.getF_node_id());</span><br><span class="line">                    Browser browser = UserAgent.parseUserAgentString(userLogCas.getF_user_agent()).getBrowser();</span><br><span class="line">                    onlineUserList.get(i).setAgent(browser.getName());</span><br><span class="line">                    onlineUserList.set(i, onlineUserList.get(i));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> onlineUserList;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;UserLogCas&gt; <span class="title">loginHistory</span><span class="params">(String loginName)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select t1.*"</span> +</span><br><span class="line">                    <span class="string">"from T_ASC_LOG_CAS t1 where t1.f_user_name = ? "</span> +</span><br><span class="line">                    <span class="string">"and t1.f_action_name = ? "</span> +</span><br><span class="line">                    <span class="string">"order by t1.f_create_time desc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;loginName, UserOnlineEnum.LOGIN.getState()&#125;, UserLogCas.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取当前在线人数，当日登录人次，当月登录人次</span></span><br><span class="line"><span class="comment">     * @date 2020/5/6 16:49</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.asc.manager.onlineuser.params.req.CurrDayMonthUserDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CurrDayMonthUserDTO <span class="title">curDayMonthUser</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select COUNT(CASE WHEN trunc(t.f_create_time) = trunc(sysdate) THEN 1 ELSE NULL END) as f_day_user, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN (trunc(t.f_create_time, 'MM') &gt;= trunc(sysdate, 'MM') AND trunc(t.f_create_time) "</span> +</span><br><span class="line">                    <span class="string">"&lt;= last_day(sysdate)) THEN 1 ELSE NULL END) as f_month_user "</span> +</span><br><span class="line">                    <span class="string">"from T_ASC_LOG_CAS t where t.f_action_name = ?"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> getDbAccess().getObject(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, CurrDayMonthUserDTO.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 统计当天登录用户人次(折线图)</span></span><br><span class="line"><span class="comment">     * @date 2020/5/7 16:36</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.params.req.LoginUserStatisticsDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LoginUserStatisticsDTO&gt; <span class="title">listStatisticsDayLoginUser</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line"></span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TO_CHAR (TE.f_Create_Time, 'hh24') AS time, COUNT(CASE WHEN TO_CHAR (TRUNC (TE.f_Create_Time),'yyyy-mm-dd') = "</span> +</span><br><span class="line">                    <span class="string">"(SELECT TO_CHAR (SYSDATE, 'yyyy-mm-dd') FROM DUAL) THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE  where TE.F_ACTION_NAME = ? GROUP BY TO_CHAR (TE.f_Create_Time, 'hh24')  order by time asc"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsDTO.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当月登录用户人次(折线图)</span></span><br><span class="line"><span class="comment">     * @date 2020/5/8 9:25</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.params.req.LoginUserStatisticsDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LoginUserStatisticsDTO&gt; <span class="title">listStatisticsMonthLoginUser</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line"></span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            String sql = <span class="string">"select trunc(TE.f_Create_Time) AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN (trunc(TE.f_Create_Time, 'MM') &gt;= trunc(sysdate, 'MM') "</span> +</span><br><span class="line">                    <span class="string">"AND trunc(TE.f_Create_Time) &lt;= last_day(sysdate)) THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE "</span> +</span><br><span class="line">                    <span class="string">"where (trunc(TE.f_Create_Time, 'MM') &gt;= trunc(sysdate, 'MM') "</span> +</span><br><span class="line">                    <span class="string">"AND trunc(TE.f_Create_Time) &lt;= last_day(sysdate)) "</span> +</span><br><span class="line">                    <span class="string">"and TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY trunc(TE.f_Create_Time) "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsDTO.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取当月天数</span></span><br><span class="line"><span class="comment">     * @date 2020/5/8 9:28</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.Map&lt;java.lang.String,java.lang.Object&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">getCurrMothDayCount</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"SELECT to_number(to_char(last_day(trunc(SYSDATE)), 'DD')) as dayCount from dual"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().getDataEntries(sql, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当年每月登录用户人次(折线图)</span></span><br><span class="line"><span class="comment">     * @date 2020/5/8 10:39</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.Map&lt;java.lang.String,java.lang.Object&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">listStatisticsYearLoginUser</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=01 then 1 else null end) as \"1\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=02 then 1 else null end) as \"2\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=03 then 1 else null end) as \"3\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=04 then 1 else null end) as \"4\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=05 then 1 else null end) as \"5\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=06 then 1 else null end) as \"6\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=07 then 1 else null end) as \"7\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=08 then 1 else null end) as \"8\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=09 then 1 else null end) as \"9\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=10 then 1 else null end) as \"10\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=11 then 1 else null end) as \"11\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=12 then 1 else null end) as \"12\"  "</span> +</span><br><span class="line">                    <span class="string">"from T_ASC_LOG_CAS TE  WHERE TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"AND EXTRACT(YEAR FROM TE.f_Create_Time) =  EXTRACT(YEAR FROM sysdate)"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> getDbAccess().getDataEntries(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计某一天登录用户人次(折线图)</span></span><br><span class="line"><span class="comment">     * @date 2020/5/8 13:50</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.params.req.LoginUserStatisticsDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LoginUserStatisticsDTO&gt; <span class="title">listStatisticsAnyDayLoginUser</span><span class="params">(String date)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line"></span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select  TO_CHAR (TE.f_Create_Time, 'hh24') AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN TO_CHAR (TRUNC (TE.f_Create_Time),'yyyy-mm-dd') = ? THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE  where TE.F_ACTION_NAME = ?  "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY TO_CHAR (TE.f_Create_Time, 'hh24')  "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;date, UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsDTO.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取自定义统计登录用户人次(折线图)</span></span><br><span class="line"><span class="comment">     * @date 2020/5/8 17:33</span></span><br><span class="line"><span class="comment">     * @param customLineReqDTO</span></span><br><span class="line"><span class="comment">     * @param xaxis</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LoginUserStatisticsDTO&gt; <span class="title">listCustomStatisticsLoginUser</span><span class="params">(CustomLineReqDTO customLineReqDTO, String xaxis)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select  trunc(TE.f_Create_Time, '"</span> + xaxis + <span class="string">"') AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN (to_char(TE.f_Create_Time,'YYYY-MM-DD HH24:MI') between ? and  ?) THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE "</span> +</span><br><span class="line">                    <span class="string">"where TE.F_ACTION_NAME = ? AND to_char(TE.f_Create_Time,'YYYY-MM-DD HH24:MI') between ? and  ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY trunc(TE.f_Create_Time, '"</span> + xaxis + <span class="string">"') "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;customLineReqDTO.getF_startdate(), customLineReqDTO.getF_enddate(),</span><br><span class="line">                            UserOnlineEnum.LOGIN.getState(), customLineReqDTO.getF_startdate(), customLineReqDTO.getF_enddate()&#125;,</span><br><span class="line">                    LoginUserStatisticsDTO.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取自定义统计每间隔30分钟登录用户人次(折线图)</span></span><br><span class="line"><span class="comment">     * @date 2020/5/9 13:58</span></span><br><span class="line"><span class="comment">     * @param customLineReqDTO</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.params.req.LoginUserStatisticsDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LoginUserStatisticsDTO&gt; <span class="title">listCustomStatisticsMinute30LoginUser</span><span class="params">(CustomLineReqDTO customLineReqDTO)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line"></span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select count(*) as f_user_count, "</span> +</span><br><span class="line">                    <span class="string">"(case floor((to_char(f_Create_Time,'mi'))/30) "</span> +</span><br><span class="line">                    <span class="string">"when 0 then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':00' "</span> +</span><br><span class="line">                    <span class="string">"when 1 then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':30' "</span> +</span><br><span class="line">                    <span class="string">"end) as time "</span> +</span><br><span class="line">                    <span class="string">"from T_ASC_LOG_CAS where to_char(f_Create_Time, 'YYYY-MM-DD HH24:MI') between ? and ? "</span> +</span><br><span class="line">                    <span class="string">"and F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"group by (case floor((to_char(f_Create_Time,'mi'))/30) "</span> +</span><br><span class="line">                    <span class="string">"when 0 then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':00' "</span> +</span><br><span class="line">                    <span class="string">"when 1 then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':30' "</span> +</span><br><span class="line">                    <span class="string">"end) order by time asc"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;customLineReqDTO.getF_startdate(), customLineReqDTO.getF_enddate(),</span><br><span class="line">                    UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsDTO.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按浏览器类型统计当年登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/24 10:17</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsCurYearBrowser() <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.F_USER_AGENT, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=01 then 1 else null end) as \"1\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=02 then 1 else null end) as \"2\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=03 then 1 else null end) as \"3\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=04 then 1 else null end) as \"4\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=05 then 1 else null end) as \"5\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=06 then 1 else null end) as \"6\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=07 then 1 else null end) as \"7\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=08 then 1 else null end) as \"8\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=09 then 1 else null end) as \"9\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=10 then 1 else null end) as \"10\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=11 then 1 else null end) as \"11\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=12 then 1 else null end) as \"12\"  "</span> +</span><br><span class="line">                    <span class="string">"from T_ASC_LOG_CAS TE  WHERE TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"AND EXTRACT(YEAR FROM TE.f_Create_Time) =  EXTRACT(YEAR FROM sysdate) "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY TE.F_USER_AGENT"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按节点类型统计当年登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/24 10:17</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsCurYearNode() <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.f_node_id as F_USER_AGENT, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=01 then 1 else null end) as \"1\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=02 then 1 else null end) as \"2\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=03 then 1 else null end) as \"3\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=04 then 1 else null end) as \"4\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=05 then 1 else null end) as \"5\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=06 then 1 else null end) as \"6\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=07 then 1 else null end) as \"7\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=08 then 1 else null end) as \"8\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=09 then 1 else null end) as \"9\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=10 then 1 else null end) as \"10\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=11 then 1 else null end) as \"11\",  "</span> +</span><br><span class="line">                    <span class="string">"COUNT(case when TO_CHAR(TE.f_Create_Time, 'MM')=12 then 1 else null end) as \"12\"  "</span> +</span><br><span class="line">                    <span class="string">"from T_ASC_LOG_CAS TE  WHERE TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"AND EXTRACT(YEAR FROM TE.f_Create_Time) =  EXTRACT(YEAR FROM sysdate) "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY TE.f_node_id"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取浏览器类型</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/24 17:34</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.entity.UserLogCas&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;UserLogCas&gt; <span class="title">browserField</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line"></span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.F_USER_AGENT "</span> +</span><br><span class="line">                    <span class="string">"from T_ASC_LOG_CAS TE  WHERE TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY TE.F_USER_AGENT"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, UserLogCas.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取节点类型</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/24 17:34</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.entity.UserLogCas&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;UserLogCas&gt; <span class="title">nodeField</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line"></span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.f_node_id "</span> +</span><br><span class="line">                    <span class="string">"from T_ASC_LOG_CAS TE  WHERE TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY TE.f_node_id"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, UserLogCas.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按浏览器类型统计当天登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 15:30</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsCurDayBrowser() <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line"></span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.F_USER_AGENT，TO_CHAR (TE.f_Create_Time, 'hh24') AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN TO_CHAR (TRUNC (TE.f_Create_Time),'yyyy-mm-dd') = "</span> +</span><br><span class="line">                    <span class="string">"(SELECT TO_CHAR (SYSDATE, 'yyyy-mm-dd') FROM DUAL) THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE  where TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY TO_CHAR (TE.f_Create_Time, 'hh24'),TE.F_USER_AGENT  "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按节点类型统计当天登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 15:30</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsCurDayNode() <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line"></span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.f_node_id as f_user_agent，TO_CHAR (TE.f_Create_Time, 'hh24') AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN TO_CHAR (TRUNC (TE.f_Create_Time),'yyyy-mm-dd') = "</span> +</span><br><span class="line">                    <span class="string">"(SELECT TO_CHAR (SYSDATE, 'yyyy-mm-dd') FROM DUAL) THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE  where TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY TO_CHAR (TE.f_Create_Time, 'hh24'),TE.f_node_id  "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按浏览器类型统计某一天登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 15:30</span></span><br><span class="line"><span class="comment">     * @param date</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsAnyDayBrowser(String date) <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.F_USER_AGENT，TO_CHAR (TE.f_Create_Time, 'hh24') AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN TO_CHAR (TRUNC (TE.f_Create_Time),'yyyy-mm-dd') = ? THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE  where TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY TO_CHAR (TE.f_Create_Time, 'hh24'),TE.F_USER_AGENT  "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;date, UserOnlineEnum.LOGIN.getState()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按节点类型统计当天登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 15:30</span></span><br><span class="line"><span class="comment">     * @param date</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsAnyDayNode(String date) <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line"></span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.f_node_id as f_user_agent，TO_CHAR (TE.f_Create_Time, 'hh24') AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN TO_CHAR (TRUNC (TE.f_Create_Time),'yyyy-mm-dd') = ? THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE  where TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY TO_CHAR (TE.f_Create_Time, 'hh24'),TE.f_node_id  "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;date, UserOnlineEnum.LOGIN.getState()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按浏览器类型统计当月登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 15:30</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsCurMonthBrowser() <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.F_USER_AGENT, trunc(TE.f_Create_Time) AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN (trunc(TE.f_Create_Time, 'MM') &gt;= trunc(sysdate, 'MM') "</span> +</span><br><span class="line">                    <span class="string">"AND trunc(TE.f_Create_Time) &lt;= last_day(sysdate)) THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE where (trunc(TE.f_Create_Time, 'MM') &gt;= trunc(sysdate, 'MM') "</span> +</span><br><span class="line">                    <span class="string">"AND trunc(TE.f_Create_Time) &lt;= last_day(sysdate)) and TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY trunc(TE.f_Create_Time), TE.F_USER_AGENT "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按节点类型统计当月登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 15:30</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsCurMonthNode() <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.f_node_id as f_user_agent, trunc(TE.f_Create_Time) AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN (trunc(TE.f_Create_Time, 'MM') &gt;= trunc(sysdate, 'MM') "</span> +</span><br><span class="line">                    <span class="string">"AND trunc(TE.f_Create_Time) &lt;= last_day(sysdate)) THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE where (trunc(TE.f_Create_Time, 'MM') &gt;= trunc(sysdate, 'MM') "</span> +</span><br><span class="line">                    <span class="string">"AND trunc(TE.f_Create_Time) &lt;= last_day(sysdate)) and TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY trunc(TE.f_Create_Time), TE.f_node_id "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按浏览器类型统计自定义（按三十分钟）登录人次</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 19:15</span></span><br><span class="line"><span class="comment">     * @param customLineReqDTO</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsCustomMinute30Browser(CustomLineReqDTO customLineReqDTO) <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select F_USER_AGENT, count(*) as f_user_count, "</span> +</span><br><span class="line">                    <span class="string">"(case floor((to_char(f_Create_Time,'mi'))/30) when 0 "</span> +</span><br><span class="line">                    <span class="string">"then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':00' "</span> +</span><br><span class="line">                    <span class="string">"when 1 then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':30' end) as time "</span> +</span><br><span class="line">                    <span class="string">"from T_ASC_LOG_CAS where to_char(f_Create_Time, 'YYYY-MM-DD HH24:MI') between ? and ? "</span> +</span><br><span class="line">                    <span class="string">"and F_ACTION_NAME = ? group by (case floor((to_char(f_Create_Time,'mi'))/30) "</span> +</span><br><span class="line">                    <span class="string">"when 0 then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':00' when 1 "</span> +</span><br><span class="line">                    <span class="string">"then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':30' end), F_USER_AGENT order by time asc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;customLineReqDTO.getF_startdate(),</span><br><span class="line">                    customLineReqDTO.getF_enddate(), UserOnlineEnum.LOGIN.getState()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按节点类型统计自定义（按三十分钟）登录人次</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 19:15</span></span><br><span class="line"><span class="comment">     * @param customLineReqDTO</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsCustomMinute30Node(CustomLineReqDTO customLineReqDTO) <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select f_node_id as f_user_agent, count(*) as f_user_count, "</span> +</span><br><span class="line">                    <span class="string">"(case floor((to_char(f_Create_Time,'mi'))/30) when 0 "</span> +</span><br><span class="line">                    <span class="string">"then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':00' "</span> +</span><br><span class="line">                    <span class="string">"when 1 then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':30' end) as time "</span> +</span><br><span class="line">                    <span class="string">"from T_ASC_LOG_CAS where to_char(f_Create_Time, 'YYYY-MM-DD HH24:MI') between ? and ? "</span> +</span><br><span class="line">                    <span class="string">"and F_ACTION_NAME = ? group by (case floor((to_char(f_Create_Time,'mi'))/30) "</span> +</span><br><span class="line">                    <span class="string">"when 0 then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':00' when 1 "</span> +</span><br><span class="line">                    <span class="string">"then to_char(f_Create_Time,'yyyy-mm-dd hh24')||':30' end), f_node_id order by time asc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;customLineReqDTO.getF_startdate(),</span><br><span class="line">                    customLineReqDTO.getF_enddate(), UserOnlineEnum.LOGIN.getState()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按浏览器类型统计自定义（除按三十分钟外）登录人次</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 19:15</span></span><br><span class="line"><span class="comment">     * @param customLineReqDTO</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsCustomBrowser(CustomLineReqDTO customLineReqDTO) <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.F_USER_AGENT, trunc(TE.f_Create_Time, 'DD') AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN (to_char(TE.f_Create_Time,'YYYY-MM-DD HH24:MI') "</span> +</span><br><span class="line">                    <span class="string">"between ? and  ?) THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE where TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"AND to_char(TE.f_Create_Time,'YYYY-MM-DD HH24:MI') between ? and ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY trunc(TE.f_Create_Time, 'DD'), TE.F_USER_AGENT "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;customLineReqDTO.getF_startdate(),</span><br><span class="line">                    customLineReqDTO.getF_enddate(), UserOnlineEnum.LOGIN.getState(), customLineReqDTO.getF_startdate(),</span><br><span class="line">                    customLineReqDTO.getF_enddate()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按节点类型统计自定义（除按三十分钟外）登录人次</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 19:15</span></span><br><span class="line"><span class="comment">     * @param customLineReqDTO</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; listStatisticsCustomNode(CustomLineReqDTO customLineReqDTO) <span class="keyword">throws</span> OnlineUserException &#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE.f_node_id as f_user_agent, trunc(TE.f_Create_Time, 'DD') AS time, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(CASE WHEN (to_char(TE.f_Create_Time,'YYYY-MM-DD HH24:MI') "</span> +</span><br><span class="line">                    <span class="string">"between ? and  ?) THEN 1 ELSE NULL END) as f_user_count "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE where TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"AND to_char(TE.f_Create_Time,'YYYY-MM-DD HH24:MI') between ? and ? "</span> +</span><br><span class="line">                    <span class="string">"GROUP BY trunc(TE.f_Create_Time, 'DD'), TE.f_node_id "</span> +</span><br><span class="line">                    <span class="string">"order by time asc"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listDataEntries(sql, <span class="keyword">new</span> Object[]&#123;customLineReqDTO.getF_startdate(),</span><br><span class="line">                    customLineReqDTO.getF_enddate(), UserOnlineEnum.LOGIN.getState(), customLineReqDTO.getF_startdate(),</span><br><span class="line">                    customLineReqDTO.getF_enddate()&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>OnlineUserStatisticsPieDbUtil</code>（获取在线用户统计饼状图数据），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnlineUserStatisticsPieDbUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CommonDatabaseAccess <span class="title">getDbAccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CommonDatabaseAccess.instance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当年全部登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 10:17</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.asc.manager.onlineuser.params.req.LoginUserStatisticsPieDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LoginUserStatisticsPieDTO <span class="title">statisticsCurYearAllPie</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line"></span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select  COUNT(*) as data  from T_ASC_LOG_CAS TE  "</span> +</span><br><span class="line">                    <span class="string">"WHERE TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"AND EXTRACT(YEAR FROM TE.f_Create_Time) =  EXTRACT(YEAR FROM sysdate)"</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().getObject(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsPieDTO.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当月全部登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 10:17</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.asc.manager.onlineuser.params.req.LoginUserStatisticsPieDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LoginUserStatisticsPieDTO <span class="title">statisticsCurMonthAllPie</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select  COUNT(*) as data "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE where "</span> +</span><br><span class="line">                    <span class="string">"(trunc(TE.f_Create_Time, 'MM') &gt;= trunc(sysdate, 'MM') "</span> +</span><br><span class="line">                    <span class="string">"AND trunc(TE.f_Create_Time) &lt;= last_day(sysdate)) "</span> +</span><br><span class="line">                    <span class="string">"and TE.F_ACTION_NAME = ? "</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().getObject(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsPieDTO.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当日全部登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 10:17</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.asc.manager.onlineuser.params.req.LoginUserStatisticsPieDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LoginUserStatisticsPieDTO <span class="title">statisticsCurDayAllPie</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select COUNT(*) as data FROM T_ASC_LOG_CAS TE "</span> +</span><br><span class="line">                    <span class="string">"where TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"and TO_CHAR (TRUNC (TE.f_Create_Time),'yyyy-mm-dd') = (SELECT TO_CHAR (SYSDATE, 'yyyy-mm-dd') FROM DUAL) "</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().getObject(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsPieDTO.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计某一日全部登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 10:17</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.asc.manager.onlineuser.params.req.LoginUserStatisticsPieDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LoginUserStatisticsPieDTO <span class="title">statisticsAnyDayAllPie</span><span class="params">(String day)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select COUNT(*) as data FROM T_ASC_LOG_CAS TE "</span> +</span><br><span class="line">                    <span class="string">"where TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"and TO_CHAR (TRUNC (TE.f_Create_Time),'yyyy-mm-dd') = ? "</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().getObject(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState(), day&#125;, LoginUserStatisticsPieDTO.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计自定义每三十分钟登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 11:24</span></span><br><span class="line"><span class="comment">     * @param customLineReqDTO</span></span><br><span class="line"><span class="comment">     * @param type</span></span><br><span class="line"><span class="comment">     * @return com.asc.manager.onlineuser.params.req.LoginUserStatisticsPieDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LoginUserStatisticsPieDTO <span class="title">listCustomStatisticsLoginUser</span><span class="params">(CustomLineReqDTO customLineReqDTO)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select count(*) as data from T_ASC_LOG_CAS where "</span> +</span><br><span class="line">                    <span class="string">"to_char(f_Create_Time, 'YYYY-MM-DD HH24:MI') between ? and ? "</span> +</span><br><span class="line">                    <span class="string">"and F_ACTION_NAME = ? "</span>;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().getObject(sql, <span class="keyword">new</span> Object[]&#123;customLineReqDTO.getF_startdate(),</span><br><span class="line">                    customLineReqDTO.getF_enddate(), UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsPieDTO.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当日按浏览器类型/节点登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 13:52</span></span><br><span class="line"><span class="comment">     * @param groupBy</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.params.req.LoginUserStatisticsPieDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LoginUserStatisticsPieDTO&gt; <span class="title">listStatisticsCurDayBrowserNodePie</span><span class="params">(String groupBy)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE."</span> + groupBy + <span class="string">" as name, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(*) as data FROM T_ASC_LOG_CAS TE where TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"and TO_CHAR (TRUNC (TE.f_Create_Time),'yyyy-mm-dd') = (SELECT TO_CHAR (SYSDATE, 'yyyy-mm-dd') FROM DUAL) "</span> +</span><br><span class="line">                    <span class="string">"group by TE."</span> + groupBy;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsPieDTO.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计某一日按浏览器类型/节点登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 13:52</span></span><br><span class="line"><span class="comment">     * @param groupBy</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.params.req.LoginUserStatisticsPieDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LoginUserStatisticsPieDTO&gt; <span class="title">listStatisticsAnyDayBrowserNodePie</span><span class="params">(String day, String groupBy)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE."</span> + groupBy + <span class="string">" as name, "</span> +</span><br><span class="line">                    <span class="string">"COUNT(*) as data FROM T_ASC_LOG_CAS TE where TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"and TO_CHAR (TRUNC (TE.f_Create_Time),'yyyy-mm-dd') = ? "</span> +</span><br><span class="line">                    <span class="string">"group by TE."</span> + groupBy;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState(), day&#125;, LoginUserStatisticsPieDTO.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当月按浏览器类型/节点登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 14:21</span></span><br><span class="line"><span class="comment">     * @param groupBy</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.params.req.LoginUserStatisticsPieDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LoginUserStatisticsPieDTO&gt; <span class="title">listStatisticsMonthBrowserNodePie</span><span class="params">(String groupBy)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE."</span> + groupBy + <span class="string">" as name, COUNT(*) as data "</span> +</span><br><span class="line">                    <span class="string">"FROM T_ASC_LOG_CAS TE where "</span> +</span><br><span class="line">                    <span class="string">"(trunc(TE.f_Create_Time, 'MM') &gt;= trunc(sysdate, 'MM') "</span> +</span><br><span class="line">                    <span class="string">"AND trunc(TE.f_Create_Time) &lt;= last_day(sysdate)) "</span> +</span><br><span class="line">                    <span class="string">"and TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"group by TE."</span> + groupBy;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsPieDTO.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当年按浏览器类型/节点登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 14:21</span></span><br><span class="line"><span class="comment">     * @param groupBy</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.params.req.LoginUserStatisticsPieDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LoginUserStatisticsPieDTO&gt; <span class="title">listStatisticsYearBrowserNodePie</span><span class="params">(String groupBy)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE."</span> + groupBy + <span class="string">" as name,  COUNT(*) as data  from T_ASC_LOG_CAS TE  "</span> +</span><br><span class="line">                    <span class="string">"WHERE TE.F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"AND EXTRACT(YEAR FROM TE.f_Create_Time) =  EXTRACT(YEAR FROM sysdate) "</span> +</span><br><span class="line">                    <span class="string">"group by TE."</span> + groupBy;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;UserOnlineEnum.LOGIN.getState()&#125;, LoginUserStatisticsPieDTO.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计自定义按浏览器类型/节点登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 14:21</span></span><br><span class="line"><span class="comment">     * @param customLineReqDTO</span></span><br><span class="line"><span class="comment">     * @param groupBy</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;com.asc.manager.onlineuser.params.req.LoginUserStatisticsPieDTO&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;LoginUserStatisticsPieDTO&gt; <span class="title">listStatisticsCustomBrowserNodePie</span><span class="params">(CustomLineReqDTO customLineReqDTO, String groupBy)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        getDbAccess().beginTransaction(<span class="string">"portalDsn"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sql = <span class="string">"select TE."</span> + groupBy + <span class="string">" as name, count(*) as data from T_ASC_LOG_CAS TE where "</span> +</span><br><span class="line">                    <span class="string">"to_char(f_Create_Time, 'YYYY-MM-DD HH24:MI') between ? and ? "</span> +</span><br><span class="line">                    <span class="string">"and F_ACTION_NAME = ? "</span> +</span><br><span class="line">                    <span class="string">"group by TE."</span> + groupBy;</span><br><span class="line">            <span class="keyword">return</span> getDbAccess().listObjects(sql, <span class="keyword">new</span> Object[]&#123;customLineReqDTO.getF_startdate(),</span><br><span class="line">                    customLineReqDTO.getF_enddate(), UserOnlineEnum.LOGIN.getState()&#125;,</span><br><span class="line">                    LoginUserStatisticsPieDTO.class, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                DbAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OnlineUserException(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getDbAccess().endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在全路径<code>com.asc.manager.onlineuser</code>下，新增<code>OnlineUserHandler</code>和<code>OnlineUserPieStatisticsHandler</code>数据处理类</p><p><code>OnlineUserHandler</code>（处理从数据库中获取的在线用户列表数据、当前在线用户、今日登录人次、本月登录人次以及折线图的数据），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnlineUserHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">OnlineUserHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> OnlineUserHandler singleton;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OnlineUserHandler <span class="title">instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">            singleton = <span class="keyword">new</span> OnlineUserHandler();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 在线用户列表</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     * @throws Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">listOnlineUser</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException, OrganizationException </span>&#123;</span><br><span class="line">        List&lt;OnlineUser&gt; onlineUserList = OnlineUserServiceImp.instance().getOnlineUserList();</span><br><span class="line">        <span class="comment">// 完善在线用户数据</span></span><br><span class="line">        onlineUserList = OnlineUserDbUtil.getOnlineUserList(onlineUserList);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; onlineUserList.size(); i++) &#123;</span><br><span class="line">            <span class="comment">// 登录时间减去当前时间（在线时长）</span></span><br><span class="line">            onlineUserList.get(i).setOnlineTime(DateUtil.formatTime(System.currentTimeMillis() - onlineUserList.get(i).getLoginTime()));</span><br><span class="line">            getUserOrg(onlineUserList.get(i));</span><br><span class="line">            <span class="comment">// 替换原来集合索引中的数据</span></span><br><span class="line">            onlineUserList.set(i, onlineUserList.get(i));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        JsonArray jsonElements = JsonObjectTool.objectList2JsonArray(onlineUserList);</span><br><span class="line">        <span class="keyword">return</span> jsonElements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 根据用户登录名查询某个用户的登录信息</span></span><br><span class="line"><span class="comment">     * @date 2020/5/6 9:42</span></span><br><span class="line"><span class="comment">     * @param loginName 用户登录名</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">loginHistory</span><span class="params">(String loginName)</span> <span class="keyword">throws</span> OnlineUserException, OrganizationException </span>&#123;</span><br><span class="line">        List&lt;UserLogCas&gt; userLogNotes = OnlineUserDbUtil.loginHistory(loginName);</span><br><span class="line">        List&lt;OnlineUser&gt; onlineUserList = <span class="keyword">new</span> ArrayList&lt;OnlineUser&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; userLogNotes.size(); i++) &#123;</span><br><span class="line">            OnlineUser onlineUser = <span class="keyword">new</span> OnlineUser();</span><br><span class="line">            onlineUser.setLoginName(userLogNotes.get(i).getF_user_name());</span><br><span class="line">            onlineUser.setLoginTime(userLogNotes.get(i).getF_create_time().getTime());</span><br><span class="line">            getUserOrg(onlineUser);</span><br><span class="line">            Browser browser = UserAgent.parseUserAgentString(userLogNotes.get(i).getF_user_agent()).getBrowser();</span><br><span class="line">            onlineUser.setAgent(browser.getName());</span><br><span class="line">            onlineUserList.add(onlineUser);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        JsonArray jsonElements = JsonObjectTool.objectList2JsonArray(onlineUserList);</span><br><span class="line">        <span class="keyword">return</span> jsonElements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户信息和处理部门数据</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getUserOrg</span><span class="params">(OnlineUser onlineUser)</span> <span class="keyword">throws</span> OrganizationException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取登录用户</span></span><br><span class="line">        User user = OrganizationService.instance().getUserByName(onlineUser.getLoginName());</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">            onlineUser.setName(user.getF_caption());</span><br><span class="line">            <span class="comment">// 获取上级领导数据列表</span></span><br><span class="line">            List&lt;Org&gt; upperOrgs = OrganizationService.instance().findUpperOrgs(user.getF_dept_id());</span><br><span class="line">            String orgStr = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">if</span> (upperOrgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = upperOrgs.size() - <span class="number">1</span>; j &gt; <span class="number">0</span>; j--) &#123;</span><br><span class="line">                    orgStr += upperOrgs.get(j).getF_caption() + <span class="string">"-&gt;"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            orgStr += user.getF_dept_caption();</span><br><span class="line">            onlineUser.setOrg(orgStr);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取当前在线人数，当日登录人次，当月登录人次</span></span><br><span class="line"><span class="comment">     * @date 2020/5/6 16:44</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonObject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonObject <span class="title">curDayMonthUser</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        CurrDayMonthUserDTO currDayMonthUserDTO = OnlineUserDbUtil.curDayMonthUser();</span><br><span class="line">        List&lt;OnlineUser&gt; onlineUserList = OnlineUserServiceImp.instance().getOnlineUserList();</span><br><span class="line">        <span class="keyword">if</span> (currDayMonthUserDTO != <span class="keyword">null</span> &amp;&amp; onlineUserList != <span class="keyword">null</span>) &#123;</span><br><span class="line">            currDayMonthUserDTO.setF_curr_user(onlineUserList.size());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonObjectTool.object2JsonObject(currDayMonthUserDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计任意一天登录用户人次(折线图)</span></span><br><span class="line"><span class="comment">     * @date 2020/5/7 16:39</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">listStatisticsDayLoginUser</span><span class="params">(String date)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从数据库中获取的数据，小时数（x轴）数据可能不全</span></span><br><span class="line">        List&lt;LoginUserStatisticsDTO&gt; listLoginUserStatisticsDTO;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(date)) &#123;</span><br><span class="line">            listLoginUserStatisticsDTO = OnlineUserDbUtil.listStatisticsAnyDayLoginUser(date);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            listLoginUserStatisticsDTO = OnlineUserDbUtil.listStatisticsDayLoginUser();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonObjectTool.objectList2JsonArray(listLoginUserStatisticsDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当月每日登录用户人次(折线图)</span></span><br><span class="line"><span class="comment">     * @date 2020/5/8 10:38</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">listStatisticsMonthLoginUser</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        List&lt;LoginUserStatisticsDTO&gt; listLoginUserStatisticsDTO = OnlineUserDbUtil.listStatisticsMonthLoginUser();</span><br><span class="line">        LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; loginUserStatisticsDTOMap = LoginUserStatisticsDTO.getMonthLoginUserStatisticsDTOMap(Integer.parseInt(OnlineUserDbUtil</span><br><span class="line">                .getCurrMothDayCount()</span><br><span class="line">                .get(<span class="string">"DAYCOUNT"</span>).toString()));</span><br><span class="line">        <span class="keyword">if</span> (listLoginUserStatisticsDTO != <span class="keyword">null</span> &amp;&amp; listLoginUserStatisticsDTO.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (LoginUserStatisticsDTO loginUserStatisticsDTO : listLoginUserStatisticsDTO) &#123;</span><br><span class="line">                <span class="comment">// 将数据库中查找到的数据替换掉map中的0值</span></span><br><span class="line">                String day = loginUserStatisticsDTO.getTime().substring(loginUserStatisticsDTO.getTime().lastIndexOf(<span class="string">"-"</span>) + <span class="number">1</span>,</span><br><span class="line">                        loginUserStatisticsDTO.getTime().indexOf(<span class="string">" "</span>));</span><br><span class="line">                loginUserStatisticsDTO.setTime(day);</span><br><span class="line">                <span class="keyword">if</span> (loginUserStatisticsDTOMap.get(day) != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    loginUserStatisticsDTOMap.put(day, loginUserStatisticsDTO);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;LoginUserStatisticsDTO&gt; newListLoginUserStatisticsDTO = listLoginUserStatisticsDTO(loginUserStatisticsDTOMap);</span><br><span class="line">        <span class="keyword">return</span> JsonObjectTool.objectList2JsonArray(newListLoginUserStatisticsDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当年每月登录用户人次(折线图)</span></span><br><span class="line"><span class="comment">     * @date 2020/5/8 10:38</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">listStatisticsYearLoginUser</span><span class="params">()</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        List&lt;LoginUserStatisticsDTO&gt; listLoginUserStatisticsDTO = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Map&lt;String, Object&gt; map = OnlineUserDbUtil.listStatisticsYearLoginUser();</span><br><span class="line">        TreeMap&lt;Integer, Object&gt; treemap = sortMap(map);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, Object&gt; me : treemap.entrySet()) &#123;</span><br><span class="line">            LoginUserStatisticsDTO loginUserStatisticsDTO = <span class="keyword">new</span> LoginUserStatisticsDTO();</span><br><span class="line">            loginUserStatisticsDTO.setTime(String.valueOf(me.getKey()));</span><br><span class="line">            loginUserStatisticsDTO.setF_user_count(me.getValue() == <span class="keyword">null</span> ? <span class="number">0</span> : Integer.parseInt(me.getValue().toString()));</span><br><span class="line">            listLoginUserStatisticsDTO.add(loginUserStatisticsDTO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonObjectTool.objectList2JsonArray(listLoginUserStatisticsDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将key进行升序排序</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> TreeMap&lt;Integer, Object&gt; <span class="title">sortMap</span><span class="params">(Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">        TreeMap&lt;Integer, Object&gt; treemap = <span class="keyword">new</span> TreeMap&lt;Integer, Object&gt;(<span class="keyword">new</span> Comparator&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer o1, Integer o2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> o1.compareTo(o2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; me : map.entrySet()) &#123;</span><br><span class="line">            treemap.put(Integer.parseInt(me.getKey()), me.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> treemap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取自定义统计登录用户人次(折线图)</span></span><br><span class="line"><span class="comment">     * @date 2020/5/8 17:33</span></span><br><span class="line"><span class="comment">     * @param customLineReqDTO</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">listCustomStatisticsLoginUser</span><span class="params">(CustomLineReqDTO customLineReqDTO)</span> <span class="keyword">throws</span> OnlineUserException, ParseException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取x轴统计的维度</span></span><br><span class="line">        String xaxis = CustomXAxisEnum.getCustomGroupStatistics(customLineReqDTO.getF_xaxis());</span><br><span class="line">        <span class="comment">// 如果是按每三十分钟统计</span></span><br><span class="line">        <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.MINUTE30)) &#123;</span><br><span class="line">            LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; minute30LoginUserStatisticsDTOMap = LoginUserStatisticsDTO</span><br><span class="line">                    .getMinute30LoginUserStatisticsDTOMap(customLineReqDTO.getF_startdate(), customLineReqDTO.getF_enddate());</span><br><span class="line"></span><br><span class="line">            List&lt;LoginUserStatisticsDTO&gt; listLoginUserStatisticsDTO = OnlineUserDbUtil.listCustomStatisticsMinute30LoginUser(customLineReqDTO);</span><br><span class="line">            <span class="keyword">if</span> (listLoginUserStatisticsDTO != <span class="keyword">null</span> &amp;&amp; listLoginUserStatisticsDTO.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (LoginUserStatisticsDTO loginUserStatisticsDTO : listLoginUserStatisticsDTO) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (minute30LoginUserStatisticsDTOMap.get(loginUserStatisticsDTO.getTime()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        minute30LoginUserStatisticsDTOMap.put(loginUserStatisticsDTO.getTime(), loginUserStatisticsDTO);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;LoginUserStatisticsDTO&gt; newListLoginUserStatisticsDTO = listLoginUserStatisticsDTO(minute30LoginUserStatisticsDTOMap);</span><br><span class="line">            <span class="keyword">return</span> JsonObjectTool.objectList2JsonArray(newListLoginUserStatisticsDTO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; monthLoginUserStatisticsDTOMap = LoginUserStatisticsDTO</span><br><span class="line">                .getMonthLoginUserStatisticsDTOMap(xaxis, customLineReqDTO.getF_startdate(), customLineReqDTO.getF_enddate());</span><br><span class="line"></span><br><span class="line">        List&lt;LoginUserStatisticsDTO&gt; listLoginUserStatisticsDTO = OnlineUserDbUtil.listCustomStatisticsLoginUser(customLineReqDTO, xaxis);</span><br><span class="line">        <span class="keyword">if</span> (listLoginUserStatisticsDTO != <span class="keyword">null</span> &amp;&amp; listLoginUserStatisticsDTO.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (LoginUserStatisticsDTO loginUserStatisticsDTO : listLoginUserStatisticsDTO) &#123;</span><br><span class="line">                <span class="comment">// 默认是按月统计</span></span><br><span class="line">                String date = loginUserStatisticsDTO.getTime().substring(<span class="number">0</span>, loginUserStatisticsDTO.getTime().lastIndexOf(<span class="string">"-"</span>));</span><br><span class="line">                <span class="comment">// 按天统计</span></span><br><span class="line">                <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.DD)) &#123;</span><br><span class="line">                    date = loginUserStatisticsDTO.getTime().substring(<span class="number">0</span>, loginUserStatisticsDTO.getTime().lastIndexOf(<span class="string">" "</span>));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.HH24)) &#123; <span class="comment">// 按小时统计</span></span><br><span class="line">                    date = loginUserStatisticsDTO.getTime().substring(<span class="number">0</span>, loginUserStatisticsDTO.getTime().indexOf(<span class="string">":"</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                loginUserStatisticsDTO.setTime(date);</span><br><span class="line">                <span class="keyword">if</span> (monthLoginUserStatisticsDTOMap.get(date) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 将数据库中查找到的数据替换掉map中的0值</span></span><br><span class="line">                    monthLoginUserStatisticsDTOMap.put(date, loginUserStatisticsDTO);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;LoginUserStatisticsDTO&gt; newListLoginUserStatisticsDTO = listLoginUserStatisticsDTO(monthLoginUserStatisticsDTOMap);</span><br><span class="line">        <span class="keyword">return</span> JsonObjectTool.objectList2JsonArray(newListLoginUserStatisticsDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装完整的统计数据返回去</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;LoginUserStatisticsDTO&gt; <span class="title">listLoginUserStatisticsDTO</span><span class="params">(LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; loginUserStatisticsDTOMap)</span> </span>&#123;</span><br><span class="line">        List&lt;LoginUserStatisticsDTO&gt; newListLoginUserStatisticsDTO = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 将处理后的map遍历，赋值给新的集合</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, LoginUserStatisticsDTO&gt; me : loginUserStatisticsDTOMap.entrySet()) &#123;</span><br><span class="line">            newListLoginUserStatisticsDTO.add(me.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newListLoginUserStatisticsDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按浏览器类型统计当年登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/24 10:17</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">listCurYesrStatistics</span><span class="params">(String type)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; mapList = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="string">"browser"</span>)) &#123;</span><br><span class="line">            mapList = OnlineUserDbUtil.listStatisticsCurYearBrowser();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mapList = OnlineUserDbUtil.listStatisticsCurYearNode();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; browserMapList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="string">"browser"</span>)) &#123;</span><br><span class="line">            <span class="comment">// 处理浏览器名</span></span><br><span class="line">            parseUserAgent(mapList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录月份</span></span><br><span class="line">        Map&lt;String, Object&gt; keyMap = <span class="keyword">new</span> HashedMap();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; me : mapList.get(<span class="number">0</span>).entrySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">"F_USER_AGENT"</span>.equals(me.getKey())) &#123;</span><br><span class="line">                keyMap.put(me.getKey(), <span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将月份从小到大排序</span></span><br><span class="line">        TreeMap&lt;Integer, Object&gt; treeMap = sortMap(keyMap);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, Object&gt; me : treeMap.entrySet()) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; browserMap = <span class="keyword">new</span> HashedMap();</span><br><span class="line">            browserMap.put(<span class="string">"time"</span>, me.getKey());</span><br><span class="line">            browserMapList.add(browserMap);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将浏览器类型作为key</span></span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; browserMap : browserMapList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (map.get(<span class="string">"F_USER_AGENT"</span>) != <span class="keyword">null</span> &amp;&amp; !browserMap.containsKey(map.get(<span class="string">"F_USER_AGENT"</span>).toString())) &#123;</span><br><span class="line">                    browserMap.put(map.get(<span class="string">"F_USER_AGENT"</span>).toString(), <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 统计每个月的每个浏览器的访问量</span></span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; browserMap : browserMapList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (browserMap.get(map.get(<span class="string">"F_USER_AGENT"</span>)) != <span class="keyword">null</span> &amp;&amp; map.get(String.valueOf(browserMap.get(<span class="string">"time"</span>))) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    browserMap.put(map.get(<span class="string">"F_USER_AGENT"</span>).toString(), Integer.parseInt(browserMap.get(map.get(<span class="string">"F_USER_AGENT"</span>)).toString()) + Integer.parseInt(map.get(String.valueOf(browserMap.get(<span class="string">"time"</span>))).toString()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将数据封装成JsonArray</span></span><br><span class="line">        JsonArray jsonArray = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        statisticsBrowserList2JsonArray(browserMapList, jsonArray);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理浏览器名</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseUserAgent</span><span class="params">(List&lt;Map&lt;String, Object&gt;&gt; mapList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">            String browserName = UserAgent.parseUserAgentString(map.get(<span class="string">"F_USER_AGENT"</span>).toString()).getBrowser().getName();</span><br><span class="line">            <span class="keyword">if</span> (browserName.lastIndexOf(<span class="string">" "</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                browserName = browserName.substring(<span class="number">0</span>, browserName.lastIndexOf(<span class="string">" "</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            map.put(<span class="string">"F_USER_AGENT"</span>, browserName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 获取浏览器类型</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/24 17:34</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">browserField</span><span class="params">(String type)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        JsonArray jsonArray = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        List&lt;UserLogCas&gt; userLogCas = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="string">"browser"</span>)) &#123;</span><br><span class="line">            userLogCas = OnlineUserDbUtil.browserField();</span><br><span class="line">            Set&lt;String&gt; browserSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (UserLogCas userLogCa : userLogCas) &#123;</span><br><span class="line">                String browserName = UserAgent.parseUserAgentString(userLogCa.getF_user_agent()).getBrowser().getName();</span><br><span class="line">                <span class="keyword">if</span> (browserName.lastIndexOf(<span class="string">" "</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    browserName = browserName.substring(<span class="number">0</span>, browserName.lastIndexOf(<span class="string">" "</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                browserSet.add(browserName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (String s : browserSet) &#123;</span><br><span class="line">                jsonArray.add(s);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            userLogCas = OnlineUserDbUtil.nodeField();</span><br><span class="line">            <span class="keyword">for</span> (UserLogCas userLogCa : userLogCas) &#123;</span><br><span class="line">                <span class="keyword">if</span> (userLogCa != <span class="keyword">null</span> &amp;&amp; userLogCa.getF_node_id() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    jsonArray.add(userLogCa.getF_node_id());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        jsonArray.add(<span class="string">"time"</span>);</span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按浏览器类型统计当天/某一天登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 15:30</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">listCurDayStatistics</span><span class="params">(String type, String date)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; browserMapList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        JsonArray jsonArray = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; mapList = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="string">"browser"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isNotEmpty(date)) &#123;</span><br><span class="line">                mapList = OnlineUserDbUtil.listStatisticsCurDayBrowser();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mapList = OnlineUserDbUtil.listStatisticsAnyDayBrowser(date);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isNotEmpty(date)) &#123;</span><br><span class="line">                mapList = OnlineUserDbUtil.listStatisticsCurDayNode();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mapList = OnlineUserDbUtil.listStatisticsAnyDayNode(date);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mapList != <span class="keyword">null</span> &amp;&amp; mapList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type.equals(<span class="string">"browser"</span>)) &#123;</span><br><span class="line">                <span class="comment">// 处理浏览器名</span></span><br><span class="line">                parseUserAgent(mapList);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Map&lt;String, Object&gt; keyMap = <span class="keyword">new</span> HashedMap();</span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; me : map.entrySet()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"TIME"</span>.equals(me.getKey())) &#123;</span><br><span class="line">                        keyMap.put(me.getValue().toString(), <span class="string">""</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将时间从小到大排序</span></span><br><span class="line">            TreeMap&lt;Integer, Object&gt; treeMap = sortMap(keyMap);</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Integer, Object&gt; me : treeMap.entrySet()) &#123;</span><br><span class="line">                Map&lt;String, Object&gt; browserMap = <span class="keyword">new</span> HashedMap();</span><br><span class="line">                <span class="keyword">if</span> (me.getKey() &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                    browserMap.put(<span class="string">"time"</span>, <span class="string">"0"</span> + me.getKey());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    browserMap.put(<span class="string">"time"</span>, me.getKey());</span><br><span class="line">                &#125;</span><br><span class="line">                browserMapList.add(browserMap);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将浏览器类型作为key</span></span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map&lt;String, Object&gt; browserMap : browserMapList) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (map.get(<span class="string">"F_USER_AGENT"</span>) != <span class="keyword">null</span> &amp;&amp; !browserMap.containsKey(map.get(<span class="string">"F_USER_AGENT"</span>).toString())) &#123;</span><br><span class="line">                        browserMap.put(map.get(<span class="string">"F_USER_AGENT"</span>).toString(), <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 统计每个月的每个浏览器的访问量</span></span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map&lt;String, Object&gt; browserMap : browserMapList) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (browserMap.get(map.get(<span class="string">"F_USER_AGENT"</span>)) != <span class="keyword">null</span> &amp;&amp; map.get(<span class="string">"TIME"</span>).equals(String.valueOf(browserMap.get(<span class="string">"time"</span>)))) &#123;</span><br><span class="line">                        browserMap.put(map.get(<span class="string">"F_USER_AGENT"</span>).toString(), Integer.parseInt(browserMap.get(map.get(<span class="string">"F_USER_AGENT"</span>)).toString()) + Integer.parseInt(map.get(<span class="string">"F_USER_COUNT"</span>).toString()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            statisticsBrowserList2JsonArray(browserMapList, jsonArray);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按浏览器类型统计当月登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 15:30</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">listStatisticsCurMonth</span><span class="params">(String type)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取当月的天数</span></span><br><span class="line">        <span class="keyword">int</span> dayCount = Integer.parseInt(OnlineUserDbUtil</span><br><span class="line">                .getCurrMothDayCount()</span><br><span class="line">                .get(<span class="string">"DAYCOUNT"</span>).toString());</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; browserMapList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        JsonArray jsonArray = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; mapList = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="string">"browser"</span>)) &#123;</span><br><span class="line">            mapList = OnlineUserDbUtil.listStatisticsCurMonthBrowser();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mapList = OnlineUserDbUtil.listStatisticsCurMonthNode();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="string">"browser"</span>)) &#123;</span><br><span class="line">            <span class="comment">// 处理浏览器名</span></span><br><span class="line">            parseUserAgent(mapList);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; keyMap = <span class="keyword">new</span> HashedMap();</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; me : map.entrySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"TIME"</span>.equals(me.getKey())) &#123;</span><br><span class="line">                    String time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>).format((Date) me.getValue());</span><br><span class="line">                    time = time.substring(time.lastIndexOf(<span class="string">"-"</span>) + <span class="number">1</span>);</span><br><span class="line">                    keyMap.put(time, <span class="string">""</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将时间从小到大排序</span></span><br><span class="line">        TreeMap&lt;Integer, Object&gt; treeMap = sortMap(keyMap);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= dayCount; i++) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; browserMap = <span class="keyword">new</span> HashedMap();</span><br><span class="line">            <span class="comment">// 说明当天没有数据，需要手动设置当天的数据</span></span><br><span class="line">            <span class="keyword">if</span> (treeMap.get(i) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                    browserMap.put(<span class="string">"time"</span>, <span class="string">"0"</span> + i);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    browserMap.put(<span class="string">"time"</span>, i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                browserMap.put(<span class="string">"time"</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line">            browserMapList.add(browserMap);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将浏览器类型作为key</span></span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; browserMap : browserMapList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (map.get(<span class="string">"F_USER_AGENT"</span>) != <span class="keyword">null</span> &amp;&amp; !browserMap.containsKey(map.get(<span class="string">"F_USER_AGENT"</span>).toString())) &#123;</span><br><span class="line">                    browserMap.put(map.get(<span class="string">"F_USER_AGENT"</span>).toString(), <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 统计每个月的每个浏览器的访问量</span></span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; browserMap : browserMapList) &#123;</span><br><span class="line">                String time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>).format((Date) map.get(<span class="string">"TIME"</span>));</span><br><span class="line">                time = time.substring(time.lastIndexOf(<span class="string">"-"</span>) + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (browserMap.get(map.get(<span class="string">"F_USER_AGENT"</span>)) != <span class="keyword">null</span> &amp;&amp; time.equals(String.valueOf(browserMap.get(<span class="string">"time"</span>)))) &#123;</span><br><span class="line">                    browserMap.put(map.get(<span class="string">"F_USER_AGENT"</span>).toString(), Integer.parseInt(browserMap.get(map.get(<span class="string">"F_USER_AGENT"</span>)).toString()) + Integer.parseInt(map.get(<span class="string">"F_USER_COUNT"</span>).toString()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将数据封装成JsonArray</span></span><br><span class="line">        statisticsBrowserList2JsonArray(browserMapList, jsonArray);</span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 按浏览器类型统计自定义登录人次（折线图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/28 15:30</span></span><br><span class="line"><span class="comment">     * @param</span></span><br><span class="line"><span class="comment">     * @return java.util.List&lt;java.util.Map&lt;java.lang.String,java.lang.Object&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">listStatisticsCustom</span><span class="params">(CustomLineReqDTO customLineReqDTO, String type)</span> <span class="keyword">throws</span> ParseException, OnlineUserException </span>&#123;</span><br><span class="line">        JsonArray jsonArray = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; browserMapList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 获取x轴统计的维度</span></span><br><span class="line">        String xaxis = CustomXAxisEnum.getCustomGroupStatistics(customLineReqDTO.getF_xaxis());</span><br><span class="line">        <span class="comment">// 如果是按每三十分钟统计</span></span><br><span class="line">        <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.MINUTE30)) &#123;</span><br><span class="line">            LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; minute30LoginUserStatisticsDTOMap = LoginUserStatisticsDTO</span><br><span class="line">                    .getMinute30LoginUserStatisticsDTOMap(customLineReqDTO.getF_startdate(), customLineReqDTO.getF_enddate());</span><br><span class="line">            List&lt;Map&lt;String, Object&gt;&gt; mapList = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (type.equals(<span class="string">"browser"</span>)) &#123;</span><br><span class="line">                mapList = OnlineUserDbUtil.listStatisticsCustomMinute30Browser(customLineReqDTO);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mapList = OnlineUserDbUtil.listStatisticsCustomMinute30Node(customLineReqDTO);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            handler(type, browserMapList, mapList, minute30LoginUserStatisticsDTOMap);</span><br><span class="line">            <span class="comment">// 统计每个月的每个浏览器的访问量</span></span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map&lt;String, Object&gt; browserMap : browserMapList) &#123;</span><br><span class="line">                    String time = map.get(<span class="string">"TIME"</span>).toString();</span><br><span class="line">                    <span class="keyword">if</span> (browserMap.get(map.get(<span class="string">"F_USER_AGENT"</span>)) != <span class="keyword">null</span> &amp;&amp; time.equals(String.valueOf(browserMap.get(<span class="string">"time"</span>)))) &#123;</span><br><span class="line">                        browserMap.put(map.get(<span class="string">"F_USER_AGENT"</span>).toString(), Integer.parseInt(browserMap.get(map.get(<span class="string">"F_USER_AGENT"</span>)).toString()) + Integer.parseInt(map.get(<span class="string">"F_USER_COUNT"</span>).toString()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; monthLoginUserStatisticsDTOMap = LoginUserStatisticsDTO</span><br><span class="line">                    .getMonthLoginUserStatisticsDTOMap(xaxis, customLineReqDTO.getF_startdate(), customLineReqDTO.getF_enddate());</span><br><span class="line">            List&lt;Map&lt;String, Object&gt;&gt; mapList = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (type.equals(<span class="string">"browser"</span>)) &#123;</span><br><span class="line">                mapList = OnlineUserDbUtil.listStatisticsCustomBrowser(customLineReqDTO);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mapList = OnlineUserDbUtil.listStatisticsCustomNode(customLineReqDTO);</span><br><span class="line">            &#125;</span><br><span class="line">            handler(type, browserMapList, mapList, monthLoginUserStatisticsDTOMap);</span><br><span class="line">            <span class="comment">// 统计每个月的每个浏览器的访问量</span></span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map&lt;String, Object&gt; browserMap : browserMapList) &#123;</span><br><span class="line">                    <span class="comment">// 默认按月</span></span><br><span class="line">                    String time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM"</span>).format((Date) map.get(<span class="string">"TIME"</span>));</span><br><span class="line">                    <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.DD)) &#123; <span class="comment">// 按天</span></span><br><span class="line">                        time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>).format((Date) map.get(<span class="string">"TIME"</span>));</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xaxis.equals(CustomXAxisEnum.HH24)) &#123; <span class="comment">// 按小时统计</span></span><br><span class="line">                        time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH"</span>).format((Date) map.get(<span class="string">"TIME"</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (browserMap.get(map.get(<span class="string">"F_USER_AGENT"</span>)) != <span class="keyword">null</span> &amp;&amp; time.equals(String.valueOf(browserMap.get(<span class="string">"time"</span>)))) &#123;</span><br><span class="line">                        browserMap.put(map.get(<span class="string">"F_USER_AGENT"</span>).toString(), Integer.parseInt(browserMap.get(map.get(<span class="string">"F_USER_AGENT"</span>)).toString()) + Integer.parseInt(map.get(<span class="string">"F_USER_COUNT"</span>).toString()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将数据封装成JsonArray</span></span><br><span class="line">        statisticsBrowserList2JsonArray(browserMapList, jsonArray);</span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将数据封装成JsonArray</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">statisticsBrowserList2JsonArray</span><span class="params">(List&lt;Map&lt;String, Object&gt;&gt; browserMapList, JsonArray jsonArray)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : browserMapList) &#123;</span><br><span class="line">            JsonObject jsonObject = <span class="keyword">new</span> JsonObject();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; me : map.entrySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (me.getKey().equals(<span class="string">"time"</span>)) &#123;</span><br><span class="line">                    jsonObject.addProperty(me.getKey(), me.getValue().toString());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    jsonObject.addProperty(me.getKey(), Integer.parseInt(me.getValue().toString()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            jsonArray.add(jsonObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装折线图数据结构</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handler</span><span class="params">(String type, List&lt;Map&lt;String, Object&gt;&gt; browserMapList, List&lt;Map&lt;String, Object&gt;&gt; mapList, LinkedHashMap&lt;String, LoginUserStatisticsDTO&gt; loginUserStatisticsDTOMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mapList != <span class="keyword">null</span> &amp;&amp; mapList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type.equals(<span class="string">"browser"</span>)) &#123;</span><br><span class="line">                parseUserAgent(mapList);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, LoginUserStatisticsDTO&gt; me : loginUserStatisticsDTOMap.entrySet()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (map.get(me.getKey()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        browserMapList.add(map);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Map&lt;String, Object&gt; browserMap = <span class="keyword">new</span> HashedMap();</span><br><span class="line">                        browserMap.put(<span class="string">"time"</span>, me.getKey());</span><br><span class="line">                        browserMapList.add(browserMap);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将浏览器类型作为key</span></span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : mapList) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, Object&gt; browserMap : browserMapList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (map.get(<span class="string">"F_USER_AGENT"</span>) != <span class="keyword">null</span> &amp;&amp; !browserMap.containsKey(map.get(<span class="string">"F_USER_AGENT"</span>).toString())) &#123;</span><br><span class="line">                    browserMap.put(map.get(<span class="string">"F_USER_AGENT"</span>).toString(), <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>OnlineUserPieStatisticsHandler</code>（处理从数据库中获取的在线用户统计饼状图数据），代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnlineUserPieStatisticsHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">OnlineUserPieStatisticsHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> OnlineUserPieStatisticsHandler singleton;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OnlineUserPieStatisticsHandler <span class="title">instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">            singleton = <span class="keyword">new</span> OnlineUserPieStatisticsHandler();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当年登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 10:17</span></span><br><span class="line"><span class="comment">     * @param type</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">statisticsCurYearPie</span><span class="params">(String type)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        JsonArray jsonArray = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNotEmpty(type)) &#123;</span><br><span class="line">            LoginUserStatisticsPieDTO loginUserStatisticsPieDTO = OnlineUserStatisticsPieDbUtil.statisticsCurYearAllPie();</span><br><span class="line">            <span class="keyword">if</span> (loginUserStatisticsPieDTO != <span class="keyword">null</span> &amp;&amp; loginUserStatisticsPieDTO.getData() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                loginUserStatisticsPieDTO.setName(<span class="string">"全部"</span>);</span><br><span class="line">                jsonArray.add(JsonObjectTool.object2JsonObject(loginUserStatisticsPieDTO));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String groupBy = <span class="string">"F_USER_AGENT"</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"browser"</span>.equals(type)) &#123;</span><br><span class="line">                groupBy = <span class="string">"F_USER_AGENT"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"node"</span>.equals(type)) &#123;</span><br><span class="line">                groupBy = <span class="string">"f_Node_Id"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;LoginUserStatisticsPieDTO&gt; loginUserStatisticsPieDTOList = OnlineUserStatisticsPieDbUtil.listStatisticsYearBrowserNodePie(groupBy);</span><br><span class="line">            jsonArray = handlerStatisticsPie(type, loginUserStatisticsPieDTOList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当月登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 10:17</span></span><br><span class="line"><span class="comment">     * @param type</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">statisticsCurMonthPie</span><span class="params">(String type)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        JsonArray jsonArray = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNotEmpty(type)) &#123;</span><br><span class="line">            LoginUserStatisticsPieDTO loginUserStatisticsPieDTO = OnlineUserStatisticsPieDbUtil.statisticsCurMonthAllPie();</span><br><span class="line">            <span class="keyword">if</span> (loginUserStatisticsPieDTO != <span class="keyword">null</span> &amp;&amp; loginUserStatisticsPieDTO.getData() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                loginUserStatisticsPieDTO.setName(<span class="string">"全部"</span>);</span><br><span class="line">                jsonArray.add(JsonObjectTool.object2JsonObject(loginUserStatisticsPieDTO));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String groupBy = <span class="string">"F_USER_AGENT"</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"browser"</span>.equals(type)) &#123;</span><br><span class="line">                groupBy = <span class="string">"F_USER_AGENT"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"node"</span>.equals(type)) &#123;</span><br><span class="line">                groupBy = <span class="string">"f_Node_Id"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;LoginUserStatisticsPieDTO&gt; loginUserStatisticsPieDTOList = OnlineUserStatisticsPieDbUtil.listStatisticsMonthBrowserNodePie(groupBy);</span><br><span class="line">            jsonArray = handlerStatisticsPie(type, loginUserStatisticsPieDTOList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计当日登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 10:17</span></span><br><span class="line"><span class="comment">     * @param type</span></span><br><span class="line"><span class="comment">     * @param day</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">statisticsDayPie</span><span class="params">(String type, String day)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        JsonArray jsonArray = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNotEmpty(type)) &#123;</span><br><span class="line">            LoginUserStatisticsPieDTO loginUserStatisticsPieDTO;</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isNotEmpty(day)) &#123;</span><br><span class="line">                loginUserStatisticsPieDTO = OnlineUserStatisticsPieDbUtil.statisticsCurDayAllPie();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                loginUserStatisticsPieDTO = OnlineUserStatisticsPieDbUtil.statisticsAnyDayAllPie(day);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (loginUserStatisticsPieDTO != <span class="keyword">null</span> &amp;&amp; loginUserStatisticsPieDTO.getData() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                loginUserStatisticsPieDTO.setName(<span class="string">"全部"</span>);</span><br><span class="line">                jsonArray.add(JsonObjectTool.object2JsonObject(loginUserStatisticsPieDTO));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String groupBy = <span class="string">"F_USER_AGENT"</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"browser"</span>.equals(type)) &#123;</span><br><span class="line">                groupBy = <span class="string">"F_USER_AGENT"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"node"</span>.equals(type)) &#123;</span><br><span class="line">                groupBy = <span class="string">"f_Node_Id"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;LoginUserStatisticsPieDTO&gt; loginUserStatisticsPieDTOList;</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isNotEmpty(day)) &#123;</span><br><span class="line">                loginUserStatisticsPieDTOList = OnlineUserStatisticsPieDbUtil.listStatisticsCurDayBrowserNodePie(groupBy);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                loginUserStatisticsPieDTOList = OnlineUserStatisticsPieDbUtil.listStatisticsAnyDayBrowserNodePie(day, groupBy);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 按浏览器类型统计</span></span><br><span class="line">            jsonArray = handlerStatisticsPie(type, loginUserStatisticsPieDTOList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 统计自定义登录人次（饼状图）</span></span><br><span class="line"><span class="comment">     * @author mzz</span></span><br><span class="line"><span class="comment">     * @date 2020/6/29 11:24</span></span><br><span class="line"><span class="comment">     * @param customLineReqDTO</span></span><br><span class="line"><span class="comment">     * @param type</span></span><br><span class="line"><span class="comment">     * @return com.google.gson.JsonArray</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">listCustomStatisticsLoginUser</span><span class="params">(CustomLineReqDTO customLineReqDTO, String type)</span> <span class="keyword">throws</span> OnlineUserException </span>&#123;</span><br><span class="line">        JsonArray jsonArray = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNotEmpty(type)) &#123;</span><br><span class="line">            LoginUserStatisticsPieDTO loginUserStatisticsPieDTO = <span class="keyword">null</span>;</span><br><span class="line">            loginUserStatisticsPieDTO = OnlineUserStatisticsPieDbUtil.listCustomStatisticsLoginUser(customLineReqDTO);</span><br><span class="line">            <span class="keyword">if</span> (loginUserStatisticsPieDTO != <span class="keyword">null</span> &amp;&amp; loginUserStatisticsPieDTO.getData() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                loginUserStatisticsPieDTO.setName(<span class="string">"全部"</span>);</span><br><span class="line">                jsonArray.add(JsonObjectTool.object2JsonObject(loginUserStatisticsPieDTO));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String groupBy = <span class="string">"F_USER_AGENT"</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"browser"</span>.equals(type)) &#123;</span><br><span class="line">                groupBy = <span class="string">"F_USER_AGENT"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"node"</span>.equals(type)) &#123;</span><br><span class="line">                groupBy = <span class="string">"f_Node_Id"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;LoginUserStatisticsPieDTO&gt; loginUserStatisticsPieDTOList = OnlineUserStatisticsPieDbUtil.listStatisticsCustomBrowserNodePie(customLineReqDTO, groupBy);</span><br><span class="line">            jsonArray = handlerStatisticsPie(type, loginUserStatisticsPieDTOList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理饼状图的统计数据，浏览器和节点统计的数据结构不一样，需要进行处理</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> JsonArray <span class="title">handlerStatisticsPie</span><span class="params">(String type, List&lt;LoginUserStatisticsPieDTO&gt; loginUserStatisticsPieDTOList)</span> </span>&#123;</span><br><span class="line">        JsonArray jsonArray;<span class="comment">// 按浏览器类型统计</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"browser"</span>.equals(type)) &#123;</span><br><span class="line">            Set&lt;String&gt; browserSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (LoginUserStatisticsPieDTO loginUserStatisticsPieDTO : loginUserStatisticsPieDTOList) &#123;</span><br><span class="line">                <span class="comment">// 处理浏览器名</span></span><br><span class="line">                String browserName = UserAgent.parseUserAgentString(loginUserStatisticsPieDTO.getName()).getBrowser().getName();</span><br><span class="line">                <span class="keyword">if</span> (browserName.lastIndexOf(<span class="string">" "</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    browserName = browserName.substring(<span class="number">0</span>, browserName.lastIndexOf(<span class="string">" "</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                browserSet.add(browserName);</span><br><span class="line">                loginUserStatisticsPieDTO.setName(browserName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将相同浏览器名的统计数据累加，然后将浏览器名作为key，统计数值作为value添加到map集合中</span></span><br><span class="line">            Map&lt;String, Integer&gt; oginUserStatisticsPieMap = <span class="keyword">new</span> HashedMap();</span><br><span class="line">            <span class="keyword">for</span> (String browserName : browserSet) &#123;</span><br><span class="line">                <span class="keyword">for</span> (LoginUserStatisticsPieDTO loginUserStatisticsPieDTO : loginUserStatisticsPieDTOList) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (loginUserStatisticsPieDTO.getName().equals(browserName)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (oginUserStatisticsPieMap.get(browserName) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            oginUserStatisticsPieMap.put(browserName, oginUserStatisticsPieMap.get(browserName) + loginUserStatisticsPieDTO.getData());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            oginUserStatisticsPieMap.put(browserName, loginUserStatisticsPieDTO.getData());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将map中的数据解析出来添加到对象集合中</span></span><br><span class="line">            List&lt;LoginUserStatisticsPieDTO&gt; newLoginUserStatisticsPieDTOList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; me : oginUserStatisticsPieMap.entrySet()) &#123;</span><br><span class="line">                LoginUserStatisticsPieDTO loginUserStatisticsPieDTO = <span class="keyword">new</span> LoginUserStatisticsPieDTO();</span><br><span class="line">                loginUserStatisticsPieDTO.setName(me.getKey());</span><br><span class="line">                loginUserStatisticsPieDTO.setData(me.getValue());</span><br><span class="line">                newLoginUserStatisticsPieDTOList.add(loginUserStatisticsPieDTO);</span><br><span class="line">            &#125;</span><br><span class="line">            jsonArray = JsonObjectTool.objectList2JsonArray(newLoginUserStatisticsPieDTOList);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 按应用节点类型统计</span></span><br><span class="line">            jsonArray = JsonObjectTool.objectList2JsonArray(loginUserStatisticsPieDTOList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jsonArray;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-5-2-js新增代码"><a href="#2-5-2-js新增代码" class="headerlink" title="2.5.2. js新增代码"></a>2.5.2. <code>js</code>新增代码</h4><blockquote><p><code>js</code>新增代码属于平台对<code>在线用户列表</code>和<code>在线用户统计</code>的菜单配置</p></blockquote><blockquote><p>新增文件路径为<code>Platform Manager\WebRoot\app\framework\manager\class</code>，以下两个js文件均新增在该路径下</p></blockquote><h5 id="2-5-2-1-菜单新增"><a href="#2-5-2-1-菜单新增" class="headerlink" title="2.5.2.1 菜单新增"></a>2.5.2.1 菜单新增</h5><blockquote><p>新增<code>ApplicationOnlineUserManager.js</code>文件</p></blockquote><blockquote><p>代码如下：</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">AscApp.ClassManager.registerClass(&#123;</span><br><span class="line">    <span class="comment">// 类型</span></span><br><span class="line">    type: <span class="string">'ApplicationOnlineUserManager'</span>,</span><br><span class="line">    <span class="comment">// 名称</span></span><br><span class="line">    caption: <span class="string">'在线用户列表'</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 编辑器定义</span></span><br><span class="line">    editors: [&#123;</span><br><span class="line">        title: <span class="string">'在线用户列表'</span>,</span><br><span class="line">        jspUrl: <span class="string">'manager/olinemontitor/application.online.user'</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p>新增<code>ApplicationOnlineUserStatistics.js</code>文件</p></blockquote><blockquote><p>代码如下：</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">AscApp.ClassManager.registerClass(&#123;</span><br><span class="line">    <span class="comment">// 类型</span></span><br><span class="line">    type: <span class="string">'ApplicationOnlineUserStatistics'</span>,</span><br><span class="line">    <span class="comment">// 名称</span></span><br><span class="line">    caption: <span class="string">'在线用户统计'</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 编辑器定义</span></span><br><span class="line">    editors: [&#123;</span><br><span class="line">        title: <span class="string">'在线用户统计'</span>,</span><br><span class="line">        jspUrl: <span class="string">'manager/olinemontitor/application.online.user.statistics'</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-5-3-jsp新增代码"><a href="#2-5-3-jsp新增代码" class="headerlink" title="2.5.3. jsp新增代码"></a>2.5.3. <code>jsp</code>新增代码</h4><blockquote><p><code>jsp</code>代码属于<code>在线用户列表</code>和<code>在线用户统计</code>的查询界面代码</p></blockquote><h5 id="2-5-3-1-创建文件夹"><a href="#2-5-3-1-创建文件夹" class="headerlink" title="2.5.3.1 创建文件夹"></a>2.5.3.1 创建文件夹</h5><blockquote><p>在路径<code>Platform Manager\WebRoot\WEB-INF\jsp\manager</code>下创建名字为<code>olinemontitor</code>的文件夹</p></blockquote><h5 id="2-5-3-2-页面新增"><a href="#2-5-3-2-页面新增" class="headerlink" title="2.5.3.2 页面新增"></a>2.5.3.2 页面新增</h5><blockquote><p>新增<code>application.online.user.jsp</code>和<code>application.online.user.statistics.jsp</code>文件</p></blockquote><blockquote><p>在路径<code>Platform Manager\WebRoot\WEB-INF\jsp\manager\olinemontitor</code>下创建<code>application.online.user.jsp</code>和<code>application.online.user.statistics.jsp</code>文件</p></blockquote><blockquote><p><code>application.online.user.jsp</code> 代码如下：</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@page contentType=<span class="string">"text/html;charset=UTF-8"</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="built_in">String</span> panelid = request.getParameter(<span class="string">"panelid"</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    Ext.onReady(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> panel = Ext.getCmp(<span class="string">'&lt;%=panelid%&gt;'</span>);</span><br><span class="line"></span><br><span class="line">        panel.schemaName = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> store = <span class="keyword">new</span> Ext.data.Store(&#123;</span><br><span class="line">            autoLoad: <span class="literal">true</span>,</span><br><span class="line">            pageSize: <span class="number">30</span>,<span class="comment">//每页显示几条数据(初始值)</span></span><br><span class="line">            proxy: &#123;</span><br><span class="line">                type: <span class="string">'direct'</span>,</span><br><span class="line">                directFn: ManagerAppDirect.onlineUser,</span><br><span class="line">                reader: &#123;</span><br><span class="line">                    type: <span class="string">'json'</span>,</span><br><span class="line">                    root: <span class="string">'datas'</span>,</span><br><span class="line">                    successProperty: <span class="string">'success'</span>,</span><br><span class="line">                    messageProperty: <span class="string">'message'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            fields: [<span class="string">'loginName'</span>, <span class="string">'name'</span>, <span class="string">'loginTime'</span>, <span class="string">'onlineTime'</span>, <span class="string">'f_node_id'</span>, <span class="string">'agent'</span>, <span class="string">'org'</span>, <span class="string">'ticket'</span>, <span class="string">'host'</span>],</span><br><span class="line">            listeners: &#123;</span><br><span class="line">                <span class="string">'beforeload'</span>: <span class="function"><span class="keyword">function</span> (<span class="params">s, operation, eOpts</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询框</span></span><br><span class="line">        <span class="keyword">var</span> textfield = <span class="keyword">new</span> Ext.form.TextField(&#123;</span><br><span class="line">            width: <span class="number">230</span>,</span><br><span class="line">            emptyText: <span class="string">'检索在线用户：应用节点，浏览器类型'</span>,</span><br><span class="line">            enableKeyEvents: <span class="literal">true</span>,</span><br><span class="line">            listeners: &#123;</span><br><span class="line">                <span class="string">'specialkey'</span>: <span class="function"><span class="keyword">function</span> (<span class="params">field, e</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (e.getKey() == e.ENTER) &#123;</span><br><span class="line">                        store.load();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> grid = Ext.create(<span class="string">'Ext.grid.Panel'</span>, &#123;</span><br><span class="line">            region: <span class="string">'center'</span>,</span><br><span class="line">            border: <span class="literal">false</span>,</span><br><span class="line">            sortableColumns: <span class="literal">false</span>,</span><br><span class="line">            viewConfig: &#123;<span class="attr">stripeRows</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">            allowDeselect: <span class="literal">true</span>,</span><br><span class="line">            columns: [</span><br><span class="line">                &#123;<span class="attr">text</span>: <span class="string">'登录名'</span>, <span class="attr">dataIndex</span>: <span class="string">'loginName'</span>, <span class="attr">width</span>: <span class="number">150</span>&#125;,</span><br><span class="line">                &#123;<span class="attr">text</span>: <span class="string">'姓名'</span>, <span class="attr">dataIndex</span>: <span class="string">'name'</span>, <span class="attr">width</span>: <span class="number">150</span>&#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    text: <span class="string">'登录时间'</span>,</span><br><span class="line">                    dataIndex: <span class="string">'loginTime'</span>,</span><br><span class="line">                    sortable: <span class="literal">true</span>,</span><br><span class="line">                    width: <span class="number">200</span>,</span><br><span class="line">                    renderer: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (value == <span class="literal">null</span> || value == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="string">'null'</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">//时间转好,将时间戳转换成Ext显示的日期格式</span></span><br><span class="line">                            <span class="keyword">return</span> Ext.util.Format.date(<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="built_in">parseInt</span>(value)), <span class="string">'Y-m-d H:i:s'</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;<span class="attr">text</span>: <span class="string">'在线时长'</span>, <span class="attr">dataIndex</span>: <span class="string">'onlineTime'</span>, <span class="attr">width</span>: <span class="number">200</span>&#125;,</span><br><span class="line">                &#123;<span class="attr">text</span>: <span class="string">'应用节点'</span>, <span class="attr">dataIndex</span>: <span class="string">'f_node_id'</span>, <span class="attr">width</span>: <span class="number">100</span>&#125;,</span><br><span class="line">                &#123;<span class="attr">text</span>: <span class="string">'浏览器类型'</span>, <span class="attr">dataIndex</span>: <span class="string">'agent'</span>, <span class="attr">width</span>: <span class="number">150</span>&#125;,</span><br><span class="line">                &#123;<span class="attr">text</span>: <span class="string">'ticket'</span>, <span class="attr">dataIndex</span>: <span class="string">'ticket'</span>, <span class="attr">width</span>: <span class="number">200</span>&#125;,</span><br><span class="line">                &#123;<span class="attr">text</span>: <span class="string">'主机'</span>, <span class="attr">dataIndex</span>: <span class="string">'host'</span>, <span class="attr">width</span>: <span class="number">150</span>&#125;,</span><br><span class="line">                &#123;<span class="attr">text</span>: <span class="string">'所在机构'</span>, <span class="attr">dataIndex</span>: <span class="string">'org'</span>, <span class="attr">flex</span>: <span class="number">1</span>&#125;</span><br><span class="line">            ],</span><br><span class="line">            store: store,</span><br><span class="line">            split: <span class="literal">true</span>,</span><br><span class="line">            tbar: [textfield, &#123;</span><br><span class="line">                text: <span class="string">'检索'</span>,</span><br><span class="line">                iconCls: <span class="string">'icon-sys-search'</span>,</span><br><span class="line">                handler: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    store.filterBy(<span class="function"><span class="keyword">function</span> (<span class="params">record, id</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (record.get(<span class="string">'loginName'</span>).indexOf(textfield.getValue()) != <span class="number">-1</span> ||</span><br><span class="line">                            record.get(<span class="string">'agent'</span>).indexOf(textfield.getValue()) != <span class="number">-1</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span></span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">'-'</span>, &#123;</span><br><span class="line">                text: <span class="string">'查看历史'</span>,</span><br><span class="line">                iconCls: <span class="string">'icon-sys-history'</span>,</span><br><span class="line">                handler: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="comment">// 获取选中行</span></span><br><span class="line">                    <span class="keyword">var</span> select = grid.getSelectionModel().getSelection();</span><br><span class="line">                    <span class="keyword">if</span> (select.length == <span class="number">0</span>) &#123;</span><br><span class="line">                        Asc.common.Message.showError(<span class="string">'请选择一条记录！'</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        history(select);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">'-'</span>, &#123;</span><br><span class="line">                text: <span class="string">'刷新'</span>,</span><br><span class="line">                iconCls: <span class="string">'icon-sys-refresh'</span>,</span><br><span class="line">                handler: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    grid.getStore().reload();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 历史查看</span></span><br><span class="line">        <span class="keyword">var</span> history = <span class="function"><span class="keyword">function</span> (<span class="params">select</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> historyStore = <span class="keyword">new</span> Ext.data.Store(&#123;</span><br><span class="line">                autoLoad: <span class="literal">true</span>,</span><br><span class="line">                pageSize: <span class="number">30</span>,<span class="comment">//每页显示几条数据(初始值)</span></span><br><span class="line">                proxy: &#123;</span><br><span class="line">                    type: <span class="string">'direct'</span>,</span><br><span class="line">                    directFn: ManagerAppDirect.loginHistory,</span><br><span class="line">                    extraParams: &#123;</span><br><span class="line">                        loginName: select[<span class="number">0</span>].data.loginName</span><br><span class="line">                    &#125;,</span><br><span class="line">                    reader: &#123;</span><br><span class="line">                        type: <span class="string">'json'</span>,</span><br><span class="line">                        root: <span class="string">'datas'</span>,</span><br><span class="line">                        successProperty: <span class="string">'success'</span>,</span><br><span class="line">                        totalProperty: <span class="string">'total'</span>,</span><br><span class="line">                        messageProperty: <span class="string">'message'</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                fields: [<span class="string">'loginName'</span>, <span class="string">'name'</span>, <span class="string">'loginTime'</span>, <span class="comment">/*'onlineTime',*/</span> <span class="string">'f_node_id'</span>, <span class="string">'agent'</span>, <span class="string">'org'</span>],</span><br><span class="line">                listeners: &#123;</span><br><span class="line">                    <span class="string">'beforeload'</span>: <span class="function"><span class="keyword">function</span> (<span class="params">s, operation, eOpts</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 分页</span></span><br><span class="line">            <span class="keyword">var</span> loginHistoryPage = Ext.create(<span class="string">'Asc.extension.PagingToolbar'</span>, &#123;</span><br><span class="line">                pageSize: <span class="number">20</span>,</span><br><span class="line">                displayInfo: <span class="literal">true</span>,</span><br><span class="line">                store: historyStore,</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> historyGrid = Ext.create(<span class="string">'Ext.grid.Panel'</span>, &#123;</span><br><span class="line">                region: <span class="string">'center'</span>,</span><br><span class="line">                border: <span class="literal">false</span>,</span><br><span class="line">                sortableColumns: <span class="literal">false</span>,</span><br><span class="line">                viewConfig: &#123;<span class="attr">stripeRows</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">                allowDeselect: <span class="literal">true</span>,</span><br><span class="line">                columns: [</span><br><span class="line">                    &#123;<span class="attr">text</span>: <span class="string">'登录名'</span>, <span class="attr">dataIndex</span>: <span class="string">'loginName'</span>, <span class="attr">width</span>: <span class="number">150</span>&#125;,</span><br><span class="line">                    &#123;<span class="attr">text</span>: <span class="string">'姓名'</span>, <span class="attr">dataIndex</span>: <span class="string">'name'</span>, <span class="attr">width</span>: <span class="number">150</span>&#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        text: <span class="string">'登录时间'</span>,</span><br><span class="line">                        dataIndex: <span class="string">'loginTime'</span>,</span><br><span class="line">                        sortable: <span class="literal">true</span>,</span><br><span class="line">                        width: <span class="number">200</span>,</span><br><span class="line">                        renderer: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (value == <span class="literal">null</span> || value == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="string">'null'</span></span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">//时间转好,将时间戳转换成Ext显示的日期格式</span></span><br><span class="line">                                <span class="keyword">return</span> Ext.util.Format.date(<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="built_in">parseInt</span>(value)), <span class="string">'Y-m-d H:i:s'</span>)</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="comment">// &#123;text: '在线时长', dataIndex: 'onlineTime', width: 200&#125;,</span></span><br><span class="line">                    &#123;<span class="attr">text</span>: <span class="string">'应用节点'</span>, <span class="attr">dataIndex</span>: <span class="string">'f_node_id'</span>, <span class="attr">width</span>: <span class="number">100</span>&#125;,</span><br><span class="line">                    &#123;<span class="attr">text</span>: <span class="string">'浏览器类型'</span>, <span class="attr">dataIndex</span>: <span class="string">'agent'</span>, <span class="attr">width</span>: <span class="number">150</span>&#125;,</span><br><span class="line">                    &#123;<span class="attr">text</span>: <span class="string">'所在机构'</span>, <span class="attr">dataIndex</span>: <span class="string">'org'</span>, <span class="attr">width</span>: <span class="number">500</span>&#125;</span><br><span class="line">                ],</span><br><span class="line">                store: historyStore,</span><br><span class="line">                split: <span class="literal">true</span>,</span><br><span class="line">                bbar: loginHistoryPage</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            Ext.create(<span class="string">'Ext.window.Window'</span>, &#123;</span><br><span class="line">                title: select[<span class="number">0</span>].data.name + <span class="string">'-历史登录'</span>,</span><br><span class="line">                height: <span class="number">500</span>,</span><br><span class="line">                width: <span class="number">1000</span>,</span><br><span class="line">                layout: <span class="string">'fit'</span>,</span><br><span class="line">                closeAction : <span class="string">'hide'</span>,</span><br><span class="line">                maximizable : <span class="literal">true</span>,<span class="comment">// 禁止最大化</span></span><br><span class="line">                items: historyGrid,</span><br><span class="line">                listeners: &#123;</span><br><span class="line">                    <span class="string">'hide'</span>: &#123;<span class="attr">fn</span>: hideMask&#125;,</span><br><span class="line">                    <span class="string">'show'</span>: &#123;<span class="attr">fn</span>: showMask&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).show();</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 选中</span></span><br><span class="line">        grid.on(<span class="string">'selectionchange'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">g, selected</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (selected.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示屏蔽</span></span><br><span class="line">        <span class="keyword">var</span> showMask = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            Ext.getBody().mask();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 隐藏屏蔽</span></span><br><span class="line">        <span class="keyword">var</span> hideMask = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            Ext.getBody().unmask();</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示界面</span></span><br><span class="line">        panel.add(&#123;</span><br><span class="line">            layout: <span class="string">'border'</span>,</span><br><span class="line">            border: <span class="literal">false</span>,</span><br><span class="line">            items: [grid]</span><br><span class="line">        &#125;);</span><br><span class="line">        panel.doLayout();</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p><code>application.online.user.statistics.jsp</code> 代码如下：</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@page contentType=<span class="string">"text/html;charset=UTF-8"</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="built_in">String</span> panelid = request.getParameter(<span class="string">"panelid"</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    Ext.onReady(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> panel = Ext.getCmp(<span class="string">'&lt;%=panelid%&gt;'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> currentDayMonthLogin = Ext.create(<span class="string">'Ext.panel.Panel'</span>, &#123;</span><br><span class="line">            bodyStyle: <span class="string">'background: #fff;'</span>,</span><br><span class="line">            layout: &#123;</span><br><span class="line">                align: <span class="string">'middle'</span>, <span class="attr">pack</span>: <span class="string">'center'</span>, <span class="attr">type</span>: <span class="string">'hbox'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            layout: <span class="string">'border'</span>,</span><br><span class="line">            region: <span class="string">'north'</span>,</span><br><span class="line">            border: <span class="literal">false</span>,</span><br><span class="line">            html: <span class="string">'&lt;div style="display: flex; justify-content: space-between;height: 100px;margin: 50px;"&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;div style="height: 80px;width: 150px;background-color: #D5E2F2;border-radius: 30px;padding: 2px 10px 2px 10px;font-size: 16px;text-align: center;line-height: 40px;"&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;div&gt;当前在线用户&lt;/div&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;div id="curOnlineUser"&gt;0人&lt;/div&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;div style="height: 80px;width: 130px;background-color: #D5E2F2;border-radius: 30px;padding: 2px 10px 2px 10px;font-size: 16px;text-align: center;line-height: 40px;"&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;div&gt;今日登录人次&lt;/div&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;div id="dayLoginCount"&gt;0人次&lt;/div&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;div style="height: 80px;width: 150px;background-color: #D5E2F2;border-radius: 30px;padding: 2px 10px 2px 10px;font-size: 16px;text-align: center;line-height: 40px;"&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;div&gt;本月登录人次&lt;/div&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;div id="monthLoginCount"&gt;0人次&lt;/div&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">                <span class="string">'&lt;/div&gt;'</span>,</span><br><span class="line">            afterRender: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                ManagerAppDirect.curDayMonthUser(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (res.success) &#123;</span><br><span class="line">                        <span class="built_in">document</span>.getElementById(<span class="string">'curOnlineUser'</span>).innerText = res.data.f_curr_user + <span class="string">"人"</span>;</span><br><span class="line">                        <span class="built_in">document</span>.getElementById(<span class="string">'dayLoginCount'</span>).innerText = res.data.f_day_user + <span class="string">"人次"</span>;</span><br><span class="line">                        <span class="built_in">document</span>.getElementById(<span class="string">'monthLoginCount'</span>).innerText = res.data.f_month_user + <span class="string">"人次"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> params;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">browserFieldFn</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">            ManagerAppDirect.browserField(params, <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (res &amp;&amp; res.success) &#123;</span><br><span class="line">                    toSelectPanel.removeAll();</span><br><span class="line">                    <span class="keyword">var</span> fieldArr = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">                    <span class="keyword">var</span> seriesArr = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> res.datas) &#123;</span><br><span class="line">                        fieldArr.push(res.datas[i]);</span><br><span class="line">                        <span class="keyword">if</span> (res.datas[i] != <span class="string">'time'</span>) &#123;</span><br><span class="line">                            <span class="comment">// seriesArr.push(JSON.parse("&#123;\"type\": \"line\", \"highlight\": &#123;\"size\": \"7\", \"radius\": \"7\"&#125;, \"displayName\": \"" + res.datas[i] + "\", \"axis\": \"left\", \"xField\": \"time\", \"yField\": \"" + res.datas[i] + "\", \"markerConfig\": &#123;\"type\": \"cross\", \"size\": \"4\", \"radius\": \"4\", \"stroke-width\": \"0\"&#125;,\"style\":&#123;\"color\":\"" + colorFnc()[i] + "\"&#125;&#125;"));</span></span><br><span class="line">                            seriesArr.push(<span class="built_in">JSON</span>.parse(<span class="string">"&#123;\"type\": \"line\", \"displayName\": \""</span> + res.datas[i] + <span class="string">"\", \"xField\": \"time\", \"yField\": \""</span> + res.datas[i] + <span class="string">"\"&#125;"</span>));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">var</span> browserStore = Ext.create(<span class="string">'Ext.data.Store'</span>, &#123;</span><br><span class="line">                        proxy: &#123;</span><br><span class="line">                            type: <span class="string">'direct'</span>,</span><br><span class="line">                            directFn: ManagerAppDirect.listStatisticsNodeBrowserLoginUser,</span><br><span class="line">                            extraParams: params,</span><br><span class="line">                            reader: &#123;</span><br><span class="line">                                type: <span class="string">'json'</span>,</span><br><span class="line">                                root: <span class="string">'datas'</span>,</span><br><span class="line">                                successProperty: <span class="string">'success'</span>,</span><br><span class="line">                                totalProperty: <span class="string">'total'</span>,</span><br><span class="line">                                messageProperty: <span class="string">'message'</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        fields: fieldArr</span><br><span class="line">                    &#125;);</span><br><span class="line">                    browserStore.load(&#123;</span><br><span class="line">                        callback: <span class="function"><span class="keyword">function</span> (<span class="params">records, operation, success</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">var</span> powerCart</span><br><span class="line">                            <span class="keyword">if</span> (params.type == <span class="string">'browser'</span> || params.type == <span class="string">'node'</span>) &#123;</span><br><span class="line">                                powerCart = Ext.create(<span class="string">'Ext.chart.Chart'</span>, &#123;</span><br><span class="line">                                    renderTo: Ext.getBody(),</span><br><span class="line">                                    width: (panel.getWidth() - <span class="number">50</span>) / <span class="number">2</span>,</span><br><span class="line">                                    height: panel.getHeight() - <span class="number">300</span>,</span><br><span class="line">                                    region: <span class="string">'west'</span>,</span><br><span class="line">                                    autoSize: <span class="literal">true</span>,</span><br><span class="line">                                    style: <span class="string">'background:#fff'</span>,</span><br><span class="line">                                    animate: <span class="literal">true</span>,</span><br><span class="line">                                    store: browserStore,</span><br><span class="line">                                    shadow: <span class="literal">true</span>,</span><br><span class="line">                                    theme: <span class="string">'Category1'</span>,</span><br><span class="line">                                    legend: &#123;</span><br><span class="line">                                        position: <span class="string">'bottom'</span></span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    axes: [&#123;</span><br><span class="line">                                        type: <span class="string">'Numeric'</span>,</span><br><span class="line">                                        minimum: <span class="number">0</span>,</span><br><span class="line">                                        position: <span class="string">'left'</span>,</span><br><span class="line">                                        fields: fieldArr,</span><br><span class="line">                                        minorTickSteps: <span class="number">1</span>,</span><br><span class="line">                                        grid: &#123;</span><br><span class="line">                                            odd: &#123;</span><br><span class="line">                                                opacity: <span class="number">1</span>,</span><br><span class="line">                                                fill: <span class="string">'#ddd'</span>,</span><br><span class="line">                                                stroke: <span class="string">'#bbb'</span>,</span><br><span class="line">                                                <span class="string">'stroke-width'</span>: <span class="number">0.5</span></span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;, &#123;</span><br><span class="line">                                        type: <span class="string">'Category'</span>,</span><br><span class="line">                                        position: <span class="string">'bottom'</span>,</span><br><span class="line">                                        fields: [<span class="string">'time'</span>],</span><br><span class="line">                                    &#125;],</span><br><span class="line">                                    series: seriesArr</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                powerCart = Ext.create(<span class="string">'Ext.chart.Chart'</span>, &#123;</span><br><span class="line">                                    renderTo: Ext.getBody(),</span><br><span class="line">                                    width: (panel.getWidth() - <span class="number">50</span>) / <span class="number">2</span>,</span><br><span class="line">                                    height: panel.getHeight() - <span class="number">300</span>,</span><br><span class="line">                                    region: <span class="string">'west'</span>,</span><br><span class="line">                                    autoSize: <span class="literal">true</span>,</span><br><span class="line">                                    style: <span class="string">'background:#fff'</span>,</span><br><span class="line">                                    animate: <span class="literal">true</span>,</span><br><span class="line">                                    store: browserStore,</span><br><span class="line">                                    shadow: <span class="literal">true</span>,</span><br><span class="line">                                    theme: <span class="string">'Category1'</span>,</span><br><span class="line">                                    axes: [&#123;</span><br><span class="line">                                        type: <span class="string">'Numeric'</span>,</span><br><span class="line">                                        minimum: <span class="number">0</span>,</span><br><span class="line">                                        position: <span class="string">'left'</span>,</span><br><span class="line">                                        fields: fieldArr,</span><br><span class="line">                                        minorTickSteps: <span class="number">1</span>,</span><br><span class="line">                                        grid: &#123;</span><br><span class="line">                                            odd: &#123;</span><br><span class="line">                                                opacity: <span class="number">1</span>,</span><br><span class="line">                                                fill: <span class="string">'#ddd'</span>,</span><br><span class="line">                                                stroke: <span class="string">'#bbb'</span>,</span><br><span class="line">                                                <span class="string">'stroke-width'</span>: <span class="number">0.5</span></span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;, &#123;</span><br><span class="line">                                        type: <span class="string">'Category'</span>,</span><br><span class="line">                                        position: <span class="string">'bottom'</span>,</span><br><span class="line">                                        fields: [<span class="string">'time'</span>],</span><br><span class="line">                                    &#125;],</span><br><span class="line">                                    series: seriesArr</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            toSelectPanel.add(powerCart);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">var</span> pieStore = Ext.create(<span class="string">'Ext.data.Store'</span>, &#123;</span><br><span class="line">                                proxy: &#123;</span><br><span class="line">                                    type: <span class="string">'direct'</span>,</span><br><span class="line">                                    directFn: ManagerAppDirect.listStatisticsNodeBrowserLoginUserPie,</span><br><span class="line">                                    extraParams: params,</span><br><span class="line">                                    reader: &#123;</span><br><span class="line">                                        type: <span class="string">'json'</span>,</span><br><span class="line">                                        root: <span class="string">'datas'</span>,</span><br><span class="line">                                        successProperty: <span class="string">'success'</span>,</span><br><span class="line">                                        totalProperty: <span class="string">'total'</span>,</span><br><span class="line">                                        messageProperty: <span class="string">'message'</span></span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                fields: [<span class="string">'name'</span>, <span class="string">'data'</span>],</span><br><span class="line">                            &#125;);</span><br><span class="line"></span><br><span class="line">                            pieStore.load(&#123;</span><br><span class="line">                                callback: <span class="function"><span class="keyword">function</span> (<span class="params">records, operation, success</span>) </span>&#123;</span><br><span class="line">                                    <span class="keyword">var</span> pieChart = Ext.create(<span class="string">'Ext.chart.Chart'</span>, &#123;</span><br><span class="line">                                        xtype: <span class="string">'chart'</span>,</span><br><span class="line">                                        renderTo: Ext.getBody(),</span><br><span class="line">                                        animate: <span class="literal">true</span>,</span><br><span class="line">                                        store: pieStore,</span><br><span class="line">                                        width: (panel.getWidth() - <span class="number">50</span>) / <span class="number">2</span>,</span><br><span class="line">                                        height: panel.getHeight() - <span class="number">300</span>,</span><br><span class="line">                                        region: <span class="string">'east'</span>,</span><br><span class="line">                                        shadow: <span class="literal">true</span>,</span><br><span class="line">                                        legend: &#123;</span><br><span class="line">                                            position: <span class="string">'bottom'</span></span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        insetPadding: <span class="number">20</span>,</span><br><span class="line">                                        theme: <span class="string">'Base:gradients'</span>,</span><br><span class="line">                                        series: [&#123;</span><br><span class="line">                                            type: <span class="string">'pie'</span>,</span><br><span class="line">                                            field: <span class="string">'data'</span>,</span><br><span class="line">                                            showInLegend: <span class="literal">true</span>,</span><br><span class="line">                                            donut: <span class="literal">false</span>,</span><br><span class="line">                                            tips: &#123;</span><br><span class="line">                                                trackMouse: <span class="literal">true</span>,</span><br><span class="line">                                                width: <span class="number">200</span>,</span><br><span class="line">                                                height: <span class="number">25</span>,</span><br><span class="line">                                                renderer: <span class="function"><span class="keyword">function</span> (<span class="params">storeItem, item</span>) </span>&#123;</span><br><span class="line">                                                    <span class="keyword">var</span> total = <span class="number">0</span>;</span><br><span class="line">                                                    pieStore.each(<span class="function"><span class="keyword">function</span> (<span class="params">rec</span>) </span>&#123;</span><br><span class="line">                                                        total += rec.get(<span class="string">'data'</span>);</span><br><span class="line">                                                    &#125;);</span><br><span class="line">                                                    <span class="keyword">this</span>.setTitle(storeItem.get(<span class="string">'name'</span>) + <span class="string">': '</span> + storeItem.get(<span class="string">'data'</span>) + <span class="string">"人次  "</span> + <span class="built_in">Math</span>.round(storeItem.get(<span class="string">'data'</span>) / total * <span class="number">100</span>) + <span class="string">'%'</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                                            &#125;,</span><br><span class="line">                                            highlight: &#123;</span><br><span class="line">                                                segment: &#123;</span><br><span class="line">                                                    margin: <span class="number">20</span></span><br><span class="line">                                                &#125;</span><br><span class="line">                                            &#125;,</span><br><span class="line">                                            label: &#123;</span><br><span class="line">                                                field: <span class="string">'name'</span>,</span><br><span class="line">                                                display: <span class="string">'rotate'</span>,</span><br><span class="line">                                                contrast: <span class="literal">true</span>,</span><br><span class="line">                                                font: <span class="string">'18px Arial'</span></span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;]</span><br><span class="line">                                    &#125;);</span><br><span class="line">                                    toSelectPanel.add(pieChart);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        params = &#123;<span class="attr">data</span>: <span class="string">'day'</span>&#125;;</span><br><span class="line">        browserFieldFn(params);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> toSelectPanel = Ext.create(<span class="string">'Ext.panel.Panel'</span>, &#123;</span><br><span class="line">            bodyStyle: <span class="string">'background: #fff;'</span>,</span><br><span class="line">            layout: <span class="string">'border'</span>,</span><br><span class="line">            region: <span class="string">'center'</span>,</span><br><span class="line">            border: <span class="literal">false</span>,</span><br><span class="line">            layout: &#123;</span><br><span class="line">                align: <span class="string">'middle'</span>, <span class="attr">pack</span>: <span class="string">'center'</span>, <span class="attr">type</span>: <span class="string">'hbox'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            tbar: &#123;</span><br><span class="line">                width: <span class="number">500</span>,</span><br><span class="line">                items: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        id: <span class="string">'dayBtn'</span>,</span><br><span class="line">                        xtype: <span class="string">'button'</span>, <span class="comment">// 默认的工具栏类型</span></span><br><span class="line">                        pressed: <span class="literal">true</span>,</span><br><span class="line">                        text: <span class="string">'当日'</span>,</span><br><span class="line">                        listeners: &#123;</span><br><span class="line">                            click: <span class="function"><span class="keyword">function</span> (<span class="params">btn</span>) </span>&#123;</span><br><span class="line">                                btn.toggle(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">                                <span class="keyword">for</span> (; ;) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (btn.nextSibling() &amp;&amp; btn.nextSibling().xtype == <span class="string">'button'</span>) &#123;</span><br><span class="line">                                        btn.nextSibling().toggle(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                                        btn = btn.nextSibling();</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                Ext.getCmp(<span class="string">'date'</span>).setValue(<span class="literal">null</span>);</span><br><span class="line">                                formPanel.setVisible(<span class="literal">false</span>);<span class="comment">//显示的时候点击隐藏</span></span><br><span class="line">                                params.data = <span class="string">'day'</span>;</span><br><span class="line">                                browserFieldFn(params);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, &#123;</span><br><span class="line">                        id: <span class="string">'monthBtn'</span>,</span><br><span class="line">                        xtype: <span class="string">'button'</span>, <span class="comment">// 默认的工具栏类型</span></span><br><span class="line">                        text: <span class="string">'当月'</span>,</span><br><span class="line">                        listeners: &#123;</span><br><span class="line">                            click: <span class="function"><span class="keyword">function</span> (<span class="params">btn</span>) </span>&#123;</span><br><span class="line">                                btn.toggle(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">                                <span class="keyword">var</span> _btn = btn;</span><br><span class="line">                                toggleFuc(_btn, btn);</span><br><span class="line">                                Ext.getCmp(<span class="string">'date'</span>).setValue(<span class="literal">null</span>);</span><br><span class="line">                                formPanel.setVisible(<span class="literal">false</span>);<span class="comment">//显示的时候点击隐藏</span></span><br><span class="line">                                params.data = <span class="string">'month'</span>;</span><br><span class="line">                                browserFieldFn(params);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, &#123;</span><br><span class="line">                        id: <span class="string">'yearBtn'</span>,</span><br><span class="line">                        xtype: <span class="string">'button'</span>, <span class="comment">// 默认的工具栏类型</span></span><br><span class="line">                        text: <span class="string">'当年'</span>,</span><br><span class="line">                        listeners: &#123;</span><br><span class="line">                            click: <span class="function"><span class="keyword">function</span> (<span class="params">btn</span>) </span>&#123;</span><br><span class="line">                                btn.toggle(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">                                <span class="keyword">var</span> _btn = btn;</span><br><span class="line">                                toggleFuc(_btn, btn);</span><br><span class="line">                                Ext.getCmp(<span class="string">'date'</span>).setValue(<span class="literal">null</span>);</span><br><span class="line">                                formPanel.setVisible(<span class="literal">false</span>);<span class="comment">//显示的时候点击隐藏</span></span><br><span class="line">                                params.data = <span class="string">'year'</span>;</span><br><span class="line">                                browserFieldFn(params);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, &#123;</span><br><span class="line">                        id: <span class="string">'customBtn'</span>,</span><br><span class="line">                        xtype: <span class="string">'button'</span>, <span class="comment">// 默认的工具栏类型</span></span><br><span class="line">                        text: <span class="string">'自定义'</span>,</span><br><span class="line">                        listeners: &#123;</span><br><span class="line">                            click: <span class="function"><span class="keyword">function</span> (<span class="params">btn</span>) </span>&#123;</span><br><span class="line">                                btn.toggle(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">                                <span class="keyword">for</span> (; ;) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (btn.previousSibling()) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (btn.previousSibling().xtype == <span class="string">'button'</span>) &#123;</span><br><span class="line">                                            btn.previousSibling().toggle(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        btn = btn.previousSibling()</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (formPanel.hidden) &#123;</span><br><span class="line">                                    formPanel.setVisible(<span class="literal">true</span>);<span class="comment">//隐藏的时候点击显示</span></span><br><span class="line">                                    formPanel.setX(formPanel.getWidth() + btn.getX() - <span class="number">110</span>);<span class="comment">//根据总宽度动态按比例设置X位置</span></span><br><span class="line">                                    formPanel.setY(btn.getY() + <span class="number">25</span>);<span class="comment">//根据总高度动态按比例设置Y位置bodyHeight*0.276+4</span></span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    formPanel.setVisible(<span class="literal">false</span>);<span class="comment">//显示的时候点击隐藏</span></span><br><span class="line">                                    btn.toggle(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, &#123;</span><br><span class="line">                        id: <span class="string">'date'</span>,</span><br><span class="line">                        xtype: <span class="string">'datefield'</span>,</span><br><span class="line">                        format: <span class="string">'Y-m-d'</span>,</span><br><span class="line">                        editable: <span class="literal">false</span>,</span><br><span class="line">                        emptyText: <span class="string">'---请选择---'</span>,</span><br><span class="line">                        width: <span class="number">130</span>,</span><br><span class="line">                        listeners: &#123;</span><br><span class="line">                            <span class="comment">//添加日期选择事件</span></span><br><span class="line">                            <span class="string">"change"</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                                <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">                                toggleFuc(that, <span class="keyword">this</span>);</span><br><span class="line">                                formPanel.setVisible(<span class="literal">false</span>);<span class="comment">//显示的时候点击隐藏</span></span><br><span class="line">                                params.data = <span class="string">'any'</span>;</span><br><span class="line">                                params.date = that.rawValue;</span><br><span class="line"></span><br><span class="line">                                browserFieldFn(params);</span><br><span class="line">                            &#125;,</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, <span class="string">'-&gt;'</span>, &#123;</span><br><span class="line">                        id: <span class="string">'allBtn'</span>,</span><br><span class="line">                        xtype: <span class="string">'button'</span>, <span class="comment">// 默认的工具栏类型</span></span><br><span class="line">                        text: <span class="string">'全部'</span>,</span><br><span class="line">                        pressed: <span class="literal">true</span>,</span><br><span class="line">                        listeners: &#123;</span><br><span class="line">                            click: <span class="function"><span class="keyword">function</span> (<span class="params">btn</span>) </span>&#123;</span><br><span class="line">                                btn.toggle(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">                                btn.nextSibling().toggle(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                                btn.nextSibling().nextSibling().toggle(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                                formPanel.setVisible(<span class="literal">false</span>);<span class="comment">//显示的时候点击隐藏</span></span><br><span class="line">                                <span class="keyword">if</span> (!params) &#123;</span><br><span class="line">                                    params.data = <span class="string">'day'</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (params.type) &#123;</span><br><span class="line">                                    <span class="keyword">delete</span> params.type;</span><br><span class="line">                                &#125;</span><br><span class="line">                                browserFieldFn(params);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, &#123;</span><br><span class="line">                        id: <span class="string">'nodeBtn'</span>,</span><br><span class="line">                        xtype: <span class="string">'button'</span>, <span class="comment">// 默认的工具栏类型</span></span><br><span class="line">                        text: <span class="string">'应用节点'</span>,</span><br><span class="line">                        listeners: &#123;</span><br><span class="line">                            click: <span class="function"><span class="keyword">function</span> (<span class="params">btn</span>) </span>&#123;</span><br><span class="line">                                btn.toggle(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">                                btn.previousSibling().toggle(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                                btn.nextSibling().toggle(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                                params.type = <span class="string">'node'</span>;</span><br><span class="line">                                browserFieldFn(params);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, &#123;</span><br><span class="line">                        id: <span class="string">'browserBtn'</span>,</span><br><span class="line">                        xtype: <span class="string">'button'</span>, <span class="comment">// 默认的工具栏类型</span></span><br><span class="line">                        text: <span class="string">'浏览器类型'</span>,</span><br><span class="line">                        listeners: &#123;</span><br><span class="line">                            click: <span class="function"><span class="keyword">function</span> (<span class="params">btn</span>) </span>&#123;</span><br><span class="line">                                btn.toggle(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">                                btn.previousSibling().toggle(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                                btn.previousSibling().previousSibling().toggle(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                                formPanel.setVisible(<span class="literal">false</span>);<span class="comment">//显示的时候点击隐藏</span></span><br><span class="line">                                params.type = <span class="string">'browser'</span></span><br><span class="line">                                browserFieldFn(params);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取消按钮选中样式</span></span><br><span class="line">        <span class="keyword">var</span> toggleFuc = <span class="function"><span class="keyword">function</span> (<span class="params">that, _this</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (; ;) &#123;</span><br><span class="line">                <span class="keyword">if</span> (that.nextSibling() &amp;&amp; that.nextSibling().xtype == <span class="string">'button'</span>) &#123;</span><br><span class="line">                    that.nextSibling().toggle(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                    that = that.nextSibling();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            that = _this;</span><br><span class="line">            <span class="keyword">for</span> (; ;) &#123;</span><br><span class="line">                <span class="keyword">if</span> (that.previousSibling() &amp;&amp; that.previousSibling().xtype == <span class="string">'button'</span>) &#123;</span><br><span class="line">                    that.previousSibling().toggle(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                    that = that.previousSibling();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> xAxisStore = Ext.create(<span class="string">'Ext.data.Store'</span>, &#123;</span><br><span class="line">            autoLoad: <span class="literal">true</span>,</span><br><span class="line">            proxy: &#123;</span><br><span class="line">                type: <span class="string">'direct'</span>,</span><br><span class="line">                directFn: ManagerAppDirect.listCustomXAxis,</span><br><span class="line">                reader: &#123;</span><br><span class="line">                    type: <span class="string">'json'</span>,</span><br><span class="line">                    root: <span class="string">'datas'</span>,</span><br><span class="line">                    successProperty: <span class="string">'success'</span>,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            fields: [<span class="string">'key'</span>, <span class="string">'value'</span>]</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自定义x轴设置</span></span><br><span class="line">        <span class="keyword">var</span> xAxis = Ext.create(<span class="string">'Ext.form.ComboBox'</span>, &#123;</span><br><span class="line">            enableRegEx: <span class="literal">true</span>,</span><br><span class="line">            fieldLabel: <span class="string">'x轴设置'</span>,</span><br><span class="line">            localFieldFilter: <span class="literal">true</span>,</span><br><span class="line">            store: xAxisStore,</span><br><span class="line">            allowBlank: <span class="literal">false</span>,</span><br><span class="line">            emptyText: <span class="string">'月,天,小时,30分钟'</span>,<span class="comment">/*,10分钟,1分钟*/</span></span><br><span class="line">            displayField: <span class="string">'value'</span>,</span><br><span class="line">            valueField: <span class="string">'key'</span>,</span><br><span class="line">            margin: <span class="string">'15 0 0 0'</span>,</span><br><span class="line">            labelWidth: <span class="number">60</span>,</span><br><span class="line">            labelAlign: <span class="string">'right'</span>,</span><br><span class="line">            width: <span class="number">260</span>,</span><br><span class="line">            name: <span class="string">'f_xaxis'</span>,</span><br><span class="line">            listeners: &#123;</span><br><span class="line">                change: &#123;</span><br><span class="line">                    fn: <span class="function"><span class="keyword">function</span> (<span class="params">com, nv, ov, eopts</span>) </span>&#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始时间</span></span><br><span class="line">        <span class="keyword">var</span> startDate = <span class="keyword">new</span> Ext.ux.form.field.DateTime(&#123;</span><br><span class="line">            name: <span class="string">'f_startdate'</span>,</span><br><span class="line">            fieldLabel: <span class="string">'开始时间'</span>,</span><br><span class="line">            allowBlank: <span class="literal">false</span>,</span><br><span class="line">            selectOnFocus: <span class="literal">true</span>,</span><br><span class="line">            format: <span class="string">'Y-m-d H:i'</span>,</span><br><span class="line">            margin: <span class="string">'15 0 0 0'</span>,</span><br><span class="line">            labelWidth: <span class="number">60</span>,</span><br><span class="line">            labelAlign: <span class="string">'right'</span>,</span><br><span class="line">            width: <span class="number">260</span>,</span><br><span class="line">            listeners: &#123;</span><br><span class="line">                change: <span class="function"><span class="keyword">function</span> (<span class="params">dateField, date</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> EDate = endDate.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (EDate != <span class="literal">null</span> &amp;&amp; EDate != <span class="string">""</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (EDate &lt; date) &#123;</span><br><span class="line">                            Asc.common.Message.showError(<span class="string">"结束时间不能小于开始时间！"</span>);</span><br><span class="line">                            startDate.setValue(<span class="string">""</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//结束时间</span></span><br><span class="line">        <span class="keyword">var</span> endDate = <span class="keyword">new</span> Ext.ux.form.field.DateTime(&#123;</span><br><span class="line">            name: <span class="string">'f_enddate'</span>,</span><br><span class="line">            fieldLabel: <span class="string">'结束时间'</span>,</span><br><span class="line">            allowBlank: <span class="literal">false</span>,</span><br><span class="line">            selectOnFocus: <span class="literal">true</span>,</span><br><span class="line">            format: <span class="string">'Y-m-d H:i'</span>,</span><br><span class="line">            margin: <span class="string">'15 0 0 0'</span>,</span><br><span class="line">            labelWidth: <span class="number">60</span>,</span><br><span class="line">            labelAlign: <span class="string">'right'</span>,</span><br><span class="line">            width: <span class="number">260</span>,</span><br><span class="line">            listeners: &#123;</span><br><span class="line">                change: <span class="function"><span class="keyword">function</span> (<span class="params">dateField, date</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> SDate = startDate.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (SDate != <span class="literal">null</span> &amp;&amp; SDate != <span class="string">""</span> &amp;&amp; date != <span class="literal">null</span> &amp;&amp; date != <span class="string">""</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (SDate &gt; date) &#123;</span><br><span class="line">                            Asc.common.Message.showError(<span class="string">"结束时间不能小于开始时间！"</span>);</span><br><span class="line">                            endDate.setValue(<span class="string">""</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询</span></span><br><span class="line">        <span class="keyword">var</span> queryBtn = Ext.create(<span class="string">'Ext.Button'</span>, &#123;</span><br><span class="line">            text: <span class="string">'查询'</span>,</span><br><span class="line">            width: <span class="number">70</span>,</span><br><span class="line">            margin: <span class="string">'15 15 0 0'</span>,</span><br><span class="line">            padding: <span class="string">'2 5 2 8'</span>,</span><br><span class="line">            handler: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 执行查询逻辑</span></span><br><span class="line">                <span class="keyword">var</span> formPanelData = <span class="keyword">this</span>.ownerCt.ownerCt.getForm().getValues();</span><br><span class="line">                <span class="keyword">if</span> (!formPanelData.f_xaxis || !formPanelData.f_startdate || !formPanelData.f_enddate) &#123;</span><br><span class="line">                    Asc.common.Message.showError(<span class="string">"x轴、开始时间、结束时间均不能为空！"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 限制x轴坐标点个数</span></span><br><span class="line">                <span class="keyword">if</span> (formPanelData.f_xaxis == <span class="string">'month'</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> months = monthsBetw(formPanelData.f_startdate, formPanelData.f_enddate);</span><br><span class="line">                    <span class="keyword">if</span> (months &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">                        Asc.common.Message.showError(<span class="string">"开始时间和结束时间跨度不能超过300个月， 请重新选择！"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (formPanelData.f_xaxis == <span class="string">'day'</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> days = daysBetw(formPanelData.f_startdate, formPanelData.f_enddate);</span><br><span class="line">                    <span class="keyword">if</span> (days &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">                        Asc.common.Message.showError(<span class="string">"开始时间和结束时间跨度不能超过300天， 请重新选择！"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (formPanelData.f_xaxis == <span class="string">'hour'</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> hours = hoursBetw(formPanelData.f_startdate, formPanelData.f_enddate);</span><br><span class="line">                    <span class="keyword">if</span> (hours &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">                        Asc.common.Message.showError(<span class="string">"开始时间和结束时间跨度不能超过300个小时， 请重新选择！"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (formPanelData.f_xaxis == <span class="string">'30m'</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> minute30 = minute30Betw(formPanelData.f_startdate, formPanelData.f_enddate);</span><br><span class="line">                    <span class="keyword">if</span> (minute30 &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">                        Asc.common.Message.showError(<span class="string">"时间间隔不能超过300个， 请重新选择！"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                Ext.getCmp(<span class="string">'date'</span>).setValue(<span class="literal">null</span>);</span><br><span class="line">                params.data = <span class="string">'custom'</span>;</span><br><span class="line">                params.value = formPanelData;</span><br><span class="line"></span><br><span class="line">                browserFieldFn(params);</span><br><span class="line">                <span class="comment">// 隐藏formpannel</span></span><br><span class="line">                formPanel.setVisible(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> restBtn = Ext.create(<span class="string">'Ext.Button'</span>, &#123;</span><br><span class="line">            text: <span class="string">'重置'</span>,</span><br><span class="line">            width: <span class="number">70</span>,</span><br><span class="line">            margin: <span class="string">'15 15 0 0'</span>,</span><br><span class="line">            padding: <span class="string">'2 5 2 8'</span>,</span><br><span class="line">            handler: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                formPanel.getForm().reset();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自定义时间Form</span></span><br><span class="line">        <span class="keyword">var</span> formPanel = Ext.create(<span class="string">'Ext.form.Panel'</span>, &#123;</span><br><span class="line">            renderTo: Ext.getBody(),</span><br><span class="line">            floating: <span class="literal">true</span>,</span><br><span class="line">            width: <span class="number">280</span>,</span><br><span class="line">            height: <span class="number">160</span>,</span><br><span class="line">            hidden: <span class="literal">true</span>,</span><br><span class="line">            header: <span class="literal">false</span>,<span class="comment">//不显示header部分</span></span><br><span class="line">            items: [&#123;</span><br><span class="line">                xtype: <span class="string">'container'</span>, <span class="attr">items</span>: xAxis</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                xtype: <span class="string">'container'</span>, <span class="attr">items</span>: [startDate, endDate]</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                layout: <span class="string">'hbox'</span>,</span><br><span class="line">                align: <span class="string">'top'</span>,</span><br><span class="line">                border: <span class="literal">false</span>,</span><br><span class="line">                columnWidth: <span class="number">1</span>,</span><br><span class="line">                items: [&#123;</span><br><span class="line">                    xtype: <span class="string">'tbspacer'</span>,</span><br><span class="line">                    flex: <span class="number">1</span></span><br><span class="line">                &#125;, restBtn, queryBtn]</span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回两个日期相差的月数</span></span><br><span class="line">        <span class="keyword">var</span> monthsBetw = <span class="function"><span class="keyword">function</span> (<span class="params">startDate, endDate</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//用-分成数组</span></span><br><span class="line">            startDate = startDate.split(<span class="string">"-"</span>);</span><br><span class="line">            endDate = endDate.split(<span class="string">"-"</span>);</span><br><span class="line">            <span class="comment">//获取年,月数</span></span><br><span class="line">            <span class="keyword">var</span> startYear = <span class="built_in">parseInt</span>(startDate[<span class="number">0</span>]),</span><br><span class="line">                startMonth = <span class="built_in">parseInt</span>(startDate[<span class="number">1</span>]),</span><br><span class="line">                endYear = <span class="built_in">parseInt</span>(endDate[<span class="number">0</span>]),</span><br><span class="line">                endMonth = <span class="built_in">parseInt</span>(endDate[<span class="number">1</span>]),</span><br><span class="line">                <span class="comment">//通过年,月差计算月份差</span></span><br><span class="line">                months = (endYear - startYear) * <span class="number">12</span> + (startMonth - endMonth) + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> months;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回两个日期相差的天数</span></span><br><span class="line">        <span class="keyword">var</span> daysBetw = <span class="function"><span class="keyword">function</span> (<span class="params">startDate, endDate</span>) </span>&#123;</span><br><span class="line">            startDate = <span class="built_in">Date</span>.parse(startDate);</span><br><span class="line">            endDate = <span class="built_in">Date</span>.parse(endDate);</span><br><span class="line">            <span class="keyword">var</span> days = (endDate - startDate) / (<span class="number">1</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> days;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回两个日期相差的小时数</span></span><br><span class="line">        <span class="keyword">var</span> hoursBetw = <span class="function"><span class="keyword">function</span> (<span class="params">startDate, endDate</span>) </span>&#123;</span><br><span class="line">            startDate = <span class="built_in">Date</span>.parse(startDate);</span><br><span class="line">            endDate = <span class="built_in">Date</span>.parse(endDate);</span><br><span class="line">            <span class="keyword">var</span> hours = (endDate - startDate) / (<span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> hours;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回两个日期间隔30分钟的个数</span></span><br><span class="line">        <span class="keyword">var</span> minute30Betw = <span class="function"><span class="keyword">function</span> (<span class="params">startDate, endDate</span>) </span>&#123;</span><br><span class="line">            startDate = <span class="built_in">Date</span>.parse(startDate);</span><br><span class="line">            endDate = <span class="built_in">Date</span>.parse(endDate);</span><br><span class="line">            <span class="keyword">var</span> minute30 = (endDate - startDate) / (<span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> minute30;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 显示界面</span></span><br><span class="line">        panel.add(&#123;</span><br><span class="line">            layout: <span class="string">'border'</span>,</span><br><span class="line">            border: <span class="literal">false</span>,</span><br><span class="line">            items: [currentDayMonthLogin, toSelectPanel]</span><br><span class="line">        &#125;);</span><br><span class="line">        panel.doLayout();</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-5-4-日期时间控件插件新增"><a href="#2-5-4-日期时间控件插件新增" class="headerlink" title="2.5.4 日期时间控件插件新增"></a>2.5.4 日期时间控件插件新增</h4><blockquote><p>日期时间控件插件是用于统计在线用户时，自定义选择里需要用到日期和时间</p></blockquote><h5 id="2-5-4-1-创建文件夹"><a href="#2-5-4-1-创建文件夹" class="headerlink" title="2.5.4.1 创建文件夹"></a>2.5.4.1 创建文件夹</h5><blockquote><p>在路径<code>Platform Manager\WebRoot\dependencies\ext-4.2.1</code>下创建名字为<code>datetime</code>的文件夹</p></blockquote><h5 id="2-5-4-2-插件新增"><a href="#2-5-4-2-插件新增" class="headerlink" title="2.5.4.2 插件新增"></a>2.5.4.2 插件新增</h5><blockquote><p>在路径<code>Platform Manager\WebRoot\dependencies\ext-4.2.1\datetime</code>下添加<code>DateTimeField.js</code>和<code>DateTimePicker.js</code>文件</p></blockquote><h5 id="2-5-4-4-日期时间控件插件引入"><a href="#2-5-4-4-日期时间控件插件引入" class="headerlink" title="2.5.4.4 日期时间控件插件引入"></a>2.5.4.4 日期时间控件插件引入</h5><blockquote><p>用到日期时间控件插件需要在<code>home.jsp</code>文件下引入<code>DateTimeField.js</code>和<code>DateTimePicker.js</code>文件，为了汉化日期控件，还需要引入<code>Platform Manager\WebRoot\dependencies/ext-4.2.1/locale/ext-lang-zh_CN.js</code>文件</p></blockquote><blockquote><p>在<code>Platform Manager\WebRoot\WEB-INF\jsp\home.jsp</code>文件中，引入</p><p><code>Platform Manager\WebRoot\dependencies\ext-4.2.1\datetime\DateTimeField.js</code>，</p><p><code>Platform Manager\WebRoot\dependencies\ext-4.2.1\datetime\DateTimePicker.js</code>，</p><p><code>Platform Manager\WebRoot\dependencies/ext-4.2.1/locale/ext-lang-zh_CN.js</code>文件</p></blockquote><p>代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;&lt;%=appTitle%&gt;&lt;/title&gt;</span><br><span class="line">&lt;link rel=&quot;shortcut icon&quot; href=&quot;resources/icon/logo.png&quot;/&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;dependencies/ext-4.2.1/resources/css/ext-all.css&quot;&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;resources/ux/window/Notification.css&quot;&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;runtime/css/asc.icon.css&quot;&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;resources/css/desktop.css&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;dependencies/ext-4.2.1/ext-all.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;dependencies/ext-4.2.1/locale/ext-lang-zh_CN.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;dependencies/ext-4.2.1/datetime/DateTimePicker.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;dependencies/ext-4.2.1/datetime/DateTimeField.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;runtime/api.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;app/home.js&quot;&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h4 id="2-5-5-core-config-xml配置新增"><a href="#2-5-5-core-config-xml配置新增" class="headerlink" title="2.5.5 core-config.xml配置新增"></a>2.5.5 core-config.xml配置新增</h4><blockquote><p>在全路径<code>Platform Manager\WebRoot/WEB-INF/config/spring</code>下的<code>core-config.xml</code>中新增如下代码：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"OnlineUserServiceImp"</span> <span class="attr">class</span>=<span class="string">"com.asc.manager.onlineuser.service.imp.OnlineUserServiceImp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"casServiceUrl"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;cas.serviceurl&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-5-6-pom-xml配置新增"><a href="#2-5-6-pom-xml配置新增" class="headerlink" title="2.5.6 pom.xml配置新增"></a>2.5.6 pom.xml配置新增</h4><blockquote><p>在全路径<code>Platform Manager下的pom.xml</code>中新增如下代码：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>eu.bitwalker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>UserAgentUtils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-6-默认密码设置"><a href="#2-6-默认密码设置" class="headerlink" title="2.6. 默认密码设置"></a>2.6. 默认密码设置</h3><h4 id="2-6-1-创建用户默认密码设置"><a href="#2-6-1-创建用户默认密码设置" class="headerlink" title="2.6.1. 创建用户默认密码设置"></a>2.6.1. 创建用户默认密码设置</h4><blockquote><p>在<code>manager</code>里创建用户时的默认密码设置，直接在<code>bs</code>项目修改都可以</p></blockquote><blockquote><p>进入<code>bs</code>项目，打开类<code>com.asc.bs.organization.access.imp.OrganizationWriterImp</code>，进入<code>saveUser</code>方法，在以下代码处进行调整</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> <span class="keyword">throws</span> OrganizationException </span>&#123;</span><br><span class="line">    <span class="comment">// 检查用户信息是否合法（关键字段）</span></span><br><span class="line">    <span class="keyword">if</span> (user.getF_name() == <span class="keyword">null</span> || <span class="string">""</span>.equals(user.getF_name())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OrganizationException(<span class="string">"未指定用户登录名"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (user.getF_caption() == <span class="keyword">null</span> || <span class="string">""</span>.equals(user.getF_caption())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OrganizationException(<span class="string">"未指定用户姓名"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未指定密码时使用默认密码</span></span><br><span class="line">    <span class="keyword">if</span> (user.getF_password() == <span class="keyword">null</span> || <span class="string">""</span>.equals(user.getF_password())) &#123;</span><br><span class="line">        PasswordEncoder encoder = <span class="keyword">new</span> PasswordEncoder();</span><br><span class="line">        user.setF_password(encoder.encode(<span class="string">"csmm@6789"</span>)); <span class="comment">// 直接修改此处的默认密码</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存用户实体对象</span></span><br><span class="line">    user.setF_update_time(<span class="keyword">new</span> Date());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getDbAccess().saveObject(user);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OrganizationException(<span class="string">"保存用户对象失败："</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 记录日志</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-6-2-重置密码默认密码设置"><a href="#2-6-2-重置密码默认密码设置" class="headerlink" title="2.6.2. 重置密码默认密码设置"></a>2.6.2. 重置密码默认密码设置</h4><blockquote><p>进入<code>manager</code>项目，打开类<code>com.asc.manager.org.OrganizationHandler</code>，进入<code>retPassword</code>方法，在以下代码处进行调整</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retPassword</span><span class="params">(<span class="keyword">long</span> userId)</span> <span class="keyword">throws</span> OrganizationException </span>&#123;</span><br><span class="line">    User user = OrganizationService.instance().getUserById(userId);</span><br><span class="line">    IDbacTransaction tx = CommonDatabaseAccess.instance().beginTransaction();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PasswordEncoder encoder = <span class="keyword">new</span> PasswordEncoder();</span><br><span class="line">        user.setF_password(encoder.encode(<span class="string">"csmm@6789"</span>)); <span class="comment">// 直接修改此处的默认密码</span></span><br><span class="line">        user.save();</span><br><span class="line">        tx.commit();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">        tx.rollback();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OrganizationException(<span class="string">"密码重置失败。"</span>, e);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        CommonDatabaseAccess.instance().endTransaction();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> asc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> asc </tag>
            
            <tag> js </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>伤损系统智能回放波形文件20200511升级</title>
      <link href="/2020/05/11/wave-file-20200511/"/>
      <url>/2020/05/11/wave-file-20200511/</url>
      <content type="html"><![CDATA[<h1 id="伤损系统智能回放波形文件升级文档"><a href="#伤损系统智能回放波形文件升级文档" class="headerlink" title="伤损系统智能回放波形文件升级文档"></a>伤损系统智能回放波形文件升级文档</h1><blockquote><p>日期：20200511</p></blockquote><blockquote><p>作者：康凤德</p></blockquote><h2 id="波形文件业务代码"><a href="#波形文件业务代码" class="headerlink" title="波形文件业务代码"></a>波形文件业务代码</h2><blockquote><p>代码所属项目为<code>Rail Defects Service Schedules</code></p></blockquote><ol><li>新增<code>java</code>代码类为:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Rail Defects Service Schedules/trunk/src/main/java/com/crmec/rail/playback/access/IWaveFileAccess.java</span><br><span class="line">Rail Defects Service Schedules/trunk/src/main/java/com/crmec/rail/playback/access/impl/WaveFileAccessImpl.java</span><br><span class="line">Rail Defects Service Schedules/trunk/src/main/java/com/crmec/rail/playback/service/WaveFileService.java</span><br><span class="line">Rail Defects Service Schedules/trunk/src/main/java/com/crmec/rail/playback/entity/WaveFile.java</span><br><span class="line">Rail Defects Service Schedules/trunk/src/main/java/com/crmec/rail/playback/qco/WaveFileQco.java</span><br></pre></td></tr></table></figure><ol start="2"><li>修改<code>java</code>代码类为:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rail Defects Service Schedules/trunk/src/main/java/com/crmec/rail/playback/service/DailyReportDetailVerifyService.java</span><br></pre></td></tr></table></figure><h2 id="移动端接口代码"><a href="#移动端接口代码" class="headerlink" title="移动端接口代码"></a>移动端接口代码</h2><blockquote><p>代码所属项目为<code>Mobile Device Service Interface</code></p></blockquote><ol><li>修改<code>java</code>代码类为:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mobile Device Service Interface/trunk/src/main/java/com/crmec/service/pad/service/FileUploadService.java</span><br><span class="line">Mobile Device Service Interface/trunk/src/main/java/com/crmec/service/pad/action/FileUploadAction.java</span><br><span class="line">Mobile Device Service Interface/trunk/src/main/java/com/crmec/service/pad/service/PadDataLogService.java</span><br></pre></td></tr></table></figure><ol start="2"><li>修改配置文件为:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mobile Device Service Interface/trunk/WebRoot/WEB-INF/config/spring/service-config.xml</span><br></pre></td></tr></table></figure><h2 id="伤损应用端代码"><a href="#伤损应用端代码" class="headerlink" title="伤损应用端代码"></a>伤损应用端代码</h2><blockquote><p>代码所属项目为<code>Rail Defects Application</code></p></blockquote><ol><li>新增<code>java</code>代码类为:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rail Defects Application/trunk/src/main/java/com/crmec/raildefects/action/WaveFileAction.java</span><br></pre></td></tr></table></figure><ol start="2"><li>修改<code>java</code>代码类为:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rail Defects Application/trunk/src/main/java/com/crmec/raildefects/action/WaveFileAction.java</span><br></pre></td></tr></table></figure><ol start="3"><li>新增<code>json</code>文件为:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rail Defects Application/trunk/WebRoot/WEB-INF/designs/<span class="keyword">module</span>/mSchedules/mSchedules.upWaveFileList.json</span><br></pre></td></tr></table></figure><ol start="4"><li>修改<code>json</code>文件为:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rail Defects Application/trunk/WebRoot/WEB-INF/designs/<span class="keyword">module</span>/mSchedules/mSchedules.json</span><br></pre></td></tr></table></figure><ol start="5"><li>新增<code>jsp</code>文件为:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Rail Defects Application/trunk/WebRoot/WEB-INF/jsp/app/mSchedules/waveFile/waveFileListRes.jsp</span><br><span class="line">Rail Defects Application/trunk/WebRoot/WEB-INF/jsp/app/mSchedules/waveFile/waveFileList.jsp</span><br><span class="line">Rail Defects Application/trunk/WebRoot/WEB-INF/jsp/app/mSchedules/waveFile/waveFileListTop.jsp</span><br></pre></td></tr></table></figure><ol start="6"><li>修改配置文件为:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rail Defects Application/trunk/WebRoot/WEB-INF/config/spring/service-config.xml</span><br></pre></td></tr></table></figure><h2 id="数据库脚本"><a href="#数据库脚本" class="headerlink" title="数据库脚本"></a>数据库脚本</h2><ol><li>表<code>T_RDMS_WAVE_FILE</code><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span>  T_RDMS_WAVE_FILE</span><br><span class="line">(</span><br><span class="line">       <span class="keyword">ID</span>                <span class="built_in">NUMBER</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">       F_TLJ_CODE        <span class="keyword">NVARCHAR2</span>(<span class="number">16</span>),</span><br><span class="line">       F_TLJ_NAME        <span class="keyword">NVARCHAR2</span>(<span class="number">50</span>),</span><br><span class="line">       F_TLJ_SHORTNAME   <span class="keyword">NVARCHAR2</span>(<span class="number">16</span>),</span><br><span class="line">       F_GWD_CODE        <span class="keyword">NVARCHAR2</span>(<span class="number">16</span>),</span><br><span class="line">       F_GWD_NAME        <span class="keyword">NVARCHAR2</span>(<span class="number">50</span>),</span><br><span class="line">       F_CJ_CODE         <span class="keyword">NVARCHAR2</span>(<span class="number">16</span>),</span><br><span class="line">       F_CJ_NAME         <span class="keyword">NVARCHAR2</span>(<span class="number">50</span>),</span><br><span class="line">       F_GQ_CODE         <span class="keyword">NVARCHAR2</span>(<span class="number">16</span>),</span><br><span class="line">       F_GQ_NAME         <span class="keyword">NVARCHAR2</span>(<span class="number">50</span>),</span><br><span class="line">       F_BZ_CODE         <span class="keyword">NVARCHAR2</span>(<span class="number">16</span>),</span><br><span class="line">       F_BZ_NAME         <span class="keyword">NVARCHAR2</span>(<span class="number">50</span>),</span><br><span class="line">       F_DATE            <span class="keyword">NVARCHAR2</span>(<span class="number">8</span>),</span><br><span class="line">       F_INS_NO          <span class="keyword">NVARCHAR2</span>(<span class="number">32</span>),</span><br><span class="line">       F_INS_ID          <span class="built_in">NUMBER</span>(<span class="number">32</span>),</span><br><span class="line">       F_MARK            <span class="keyword">NVARCHAR2</span>(<span class="number">1024</span>),</span><br><span class="line">       F_BZ_MAN          <span class="keyword">NVARCHAR2</span>(<span class="number">50</span>),</span><br><span class="line">       F_PLAN_MAN        <span class="keyword">NVARCHAR2</span>(<span class="number">50</span>),</span><br><span class="line">       F_PLAN_TIME       <span class="built_in">DATE</span>,</span><br><span class="line">       F_FILE_NAME       <span class="keyword">NVARCHAR2</span>(<span class="number">512</span>),</span><br><span class="line">       F_FILE_PATH       <span class="keyword">NVARCHAR2</span>(<span class="number">512</span>),</span><br><span class="line">       F_CREATE_TIME     <span class="built_in">DATE</span>,</span><br><span class="line">       F_UPDATE_TIME     <span class="built_in">DATE</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">alter</span>  <span class="keyword">table</span> T_RDMS_WAVE_FILE</span><br><span class="line">       <span class="keyword">add</span> <span class="keyword">constraint</span> PK_T_RDMS_WAVE_FILE_ID primary <span class="keyword">key</span> (<span class="keyword">ID</span>);</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">table</span> T_RDMS_WAVE_FILE <span class="keyword">is</span> <span class="string">'波形文件表'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.ID <span class="keyword">is</span> <span class="string">'主键'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_TLJ_CODE <span class="keyword">is</span> <span class="string">'铁路局编码'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_TLJ_NAME <span class="keyword">is</span> <span class="string">'铁路局名称'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_TLJ_SHORTNAME <span class="keyword">is</span> <span class="string">'铁路局简称'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_GWD_CODE <span class="keyword">is</span> <span class="string">'工务段编码'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_GWD_NAME <span class="keyword">is</span> <span class="string">'工务段名称'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_CJ_CODE <span class="keyword">is</span> <span class="string">'车间编码'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_CJ_NAME <span class="keyword">is</span> <span class="string">'车间名称'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_GQ_CODE <span class="keyword">is</span> <span class="string">'工区编码'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_GQ_NAME <span class="keyword">is</span> <span class="string">'工区名称'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_BZ_CODE <span class="keyword">is</span> <span class="string">'班组编码'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_BZ_NAME <span class="keyword">is</span> <span class="string">'班组名称'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_DATE <span class="keyword">is</span> <span class="string">'探伤日期'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_INS_NO <span class="keyword">is</span> <span class="string">'仪器编号'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_INS_ID <span class="keyword">is</span> <span class="string">'仪器ID'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_MARK <span class="keyword">is</span> <span class="string">'备注'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_BZ_MAN <span class="keyword">is</span> <span class="string">'班组负责人'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_PLAN_MAN <span class="keyword">is</span> <span class="string">'编制人'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_PLAN_TIME <span class="keyword">is</span> <span class="string">'编制时间'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_FILE_NAME <span class="keyword">is</span> <span class="string">'波形文件名称'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_FILE_PATH <span class="keyword">is</span> <span class="string">'波形文件路径'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_CREATE_TIME <span class="keyword">is</span> <span class="string">'创建时间'</span>;</span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">column</span> T_RDMS_WAVE_FILE.F_UPDATE_TIME <span class="keyword">is</span> <span class="string">'更新时间'</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">sequence</span> SEQ_T_RDMS_WAVE_FILE;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      <categories>
          
          <category> asc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> asc </tag>
            
            <tag> rdms </tag>
            
            <tag> js </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ASC平台升级说明文档</title>
      <link href="/2020/04/23/asc20200401/"/>
      <url>/2020/04/23/asc20200401/</url>
      <content type="html"><![CDATA[<h1 id="ASC平台升级说明文档"><a href="#ASC平台升级说明文档" class="headerlink" title="ASC平台升级说明文档"></a>ASC平台升级说明文档</h1><blockquote><p>日期:：2020年4月21日</p></blockquote><blockquote><p>作者：康凤德</p><p>注意：由于本次<code>ASC</code>平台升级在根项目的<code>pom.xml</code>增加了一些参数配置，在各个项目的根<code>parent</code>的<code>pom.xml</code>文件里最好采用和<code>asc</code>平台不一样的<code>groupId</code>，否则造成平台<code>jar</code>包依赖的根<code>parent</code>变成了项目的根<code>parent</code>，会找不到<code>asc</code>平台定义的相关参数</p></blockquote><h2 id="1-升级前的准备"><a href="#1-升级前的准备" class="headerlink" title="1. 升级前的准备"></a>1. 升级前的准备</h2><h3 id="1-1-版本号"><a href="#1-1-版本号" class="headerlink" title="1.1. 版本号"></a>1.1. 版本号</h3><blockquote><p>统一规定<code>ASC</code>平台本次升级版本号为<code>1.1.202001</code></p></blockquote><blockquote><p>本次升级的<code>ASC</code>平台所有<code>jar</code>包版本统一规定如下</p></blockquote><p><pre><code><br>├── ASC Platform - 1.1.202001<br>│   ├── ASC Basic - 1.1.202001<br>│   │   ├── Mixky Toolkit - 1.1.202001<br>│   │   ├── Mixky Database Access - 1.1.202001<br>│   ├── ASC Commons - 1.1.202001<br>│   │   ├── Platform Commons - Base - 1.1.202001<br>│   │   ├── Platform Commons - Core - 1.1.202001<br>│   │   ├── Platform Commons - DirectJngine - 1.1.202001<br>│   │   ├── Platform Commons - Engine - 1.1.202001<br>│   │   ├── Platform Commons - Esb - 1.1.202001<br>│   │   ├── Platform Commons - Workflow - 1.1.202001<br>│   ├── ASC Facade - 1.1.202001<br>│   │   ├── Application Framework - 1.1.202001<br>│   │   ├── Central Authentication Service - 1.1.202001<br>│   ├── ASC Applications - 1.1.202001<br>│   │   ├── Platform Base Service<br>│   │   ├── Platform Manager<br>│   │   ├── Application Developer<br>│   │   ├── Application Portal<br>│   ├── ASC Module Applications<br>│   │   ├── Demo Application<br></code></pre></p><blockquote><p>所有的平台依赖jar包版本统一为<code>1.1.202001</code></p></blockquote><blockquote><p>各个项目升级前需要把依赖的平台相关jar包全部改为<code>1.1.202001</code></p></blockquote><h3 id="1-2-代理仓库配置"><a href="#1-2-代理仓库配置" class="headerlink" title="1.2. 代理仓库配置"></a>1.2. 代理仓库配置</h3><blockquote><p>在项目的根目录里的<code>pom.xml</code>配置代理仓库，配置好修改完版本号即可自动从代理仓库下载版本号为<code>1.1.202001</code>的<code>jar</code>包，配置如下：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>releases.asp.com<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>releases.asp.com<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://219.239.105.55:7038/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--true或者false表示该仓库是否为下载某种类型构件（发布版，快照版）开启。  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--该元素指定更新发生的频率。Maven会比较本地POM和远程POM的时间戳。这里的选项是：always（一直），daily（默认，每日），interval：X（这里X是以分钟为单位的时间间隔），或者never（从不）。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>never<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--当Maven验证构件校验文件失败时该怎么做-ignore（忽略），fail（失败），或者warn（警告）。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>warn<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>warn<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1-3-依赖版本号修改"><a href="#1-3-依赖版本号修改" class="headerlink" title="1.3. 依赖版本号修改"></a>1.3. 依赖版本号修改</h3><blockquote><p>需要对项目依赖的平台<code>jar</code>包版本号进行修改</p></blockquote><blockquote><p>在根目录里的<code>pom.xml</code>对<code>properties</code>里的依赖版本号进行修改，修改如下：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">commons.core.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">commons.core.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">commons.engine.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">commons.engine.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">asc.cas.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">asc.cas.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mixky.toolkit.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">mixky.toolkit.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">platform.commons.base.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">platform.commons.base.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">platform.commons.esb.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">platform.commons.esb.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">application.framework.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">application.framework.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">platform.base.service.version</span>&gt;</span>1.1.202001<span class="tag">&lt;/<span class="name">platform.base.service.version</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>平台需要修改的jar包版本号包括：</p></blockquote><ul><li>mkdbac</li><li>toolkit</li><li>commons-base</li><li>commons-core</li><li>commons-engine</li><li>commons-esb</li><li>commons-workflow</li><li>directjngine</li><li>cas</li><li>framework</li></ul><blockquote><p>以上的部分<code>jar</code>包如果源码就在项目内，那么会和<code>asc</code>平台依赖的<code>1.1.202001</code>版本号的<code>jar</code>包冲突，那么最好不使用平台内的<code>jar</code>包或者把项目内的<code>jar</code>包版本号改为<code>1.1.202001</code>即可。</p></blockquote><h2 id="2-平台功能升级"><a href="#2-平台功能升级" class="headerlink" title="2. 平台功能升级"></a>2. 平台功能升级</h2><h3 id="2-1-CAS功能升级"><a href="#2-1-CAS功能升级" class="headerlink" title="2.1. CAS功能升级"></a>2.1. <code>CAS</code>功能升级</h3><blockquote><p><code>CAS</code>用户权限认证中心记录用户所登录的应用节点</p></blockquote><h4 id="2-1-1-java代码修改"><a href="#2-1-1-java代码修改" class="headerlink" title="2.1.1. java代码修改"></a>2.1.1. <code>java</code>代码修改</h4><blockquote><p>进入<code>portal</code>项目，打开，打开类<code>com.asc.portal.certification.HttpBaseAuthenticationListenerImp</code></p></blockquote><blockquote><p>在类的首行添加如下代码:</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String nodeId; <span class="comment">// 节点ID</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNodeId</span><span class="params">(String nodeId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.nodeId = nodeId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-2-xml配置修改"><a href="#2-1-2-xml配置修改" class="headerlink" title="2.1.2. xml配置修改"></a>2.1.2. <code>xml</code>配置修改</h4><blockquote><p>进入<code>portal</code>项目，打开<code>{portalProjectPath}\WebRoot\WEB-INF\config\spring\cas-config.xml</code></p></blockquote><blockquote><p>修改<code>com.asc.portal.certification.HttpBaseAuthenticationListenerImp</code>的<code>Bean</code>生成配置</p></blockquote><ul><li>修改前</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"HttpBaseAuthenticationListenerImp"</span> <span class="attr">class</span>=<span class="string">"com.asc.portal.certification.HttpBaseAuthenticationListenerImp"</span>/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>修改后<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"HttpBaseAuthenticationListenerImp"</span> <span class="attr">class</span>=<span class="string">"com.asc.portal.certification.HttpBaseAuthenticationListenerImp"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"nodeId"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;app.nodeId&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-1-3-params-properties配置新增"><a href="#2-1-3-params-properties配置新增" class="headerlink" title="2.1.3. params.properties配置新增"></a>2.1.3. <code>params.properties</code>配置新增</h4><blockquote><p>进入<code>portal</code>项目，打开<code>{portalProjectPath}\WebRoot\WEB-INF\param.properties</code></p></blockquote><blockquote><p>新增以下参数配置</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 应用节点ID</span><br><span class="line">app.nodeId=1</span><br></pre></td></tr></table></figure><h3 id="2-2-dbac功能升级"><a href="#2-2-dbac功能升级" class="headerlink" title="2.2. dbac功能升级"></a>2.2. <code>dbac</code>功能升级</h3><blockquote><p>数据表<code>ID</code>通过<code>redis</code>生成的配置调整</p></blockquote><blockquote><p>以下配置在<code>portal</code>、<code>app</code>、<code>bs</code>、<code>manager</code>里都是一样</p></blockquote><h4 id="2-2-1-param-properties配置新增"><a href="#2-2-1-param-properties配置新增" class="headerlink" title="2.2.1. param.properties配置新增"></a>2.2.1. <code>param.properties</code>配置新增</h4><blockquote><p><code>ID</code>来源配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 该处用于标记ID获取来源，分为Db和Redis，不设置默认使用Db</span><br><span class="line">db.idsource=Redis</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p><code>redis</code>连接配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># redis参数配置-详见redis.clients.jedis.JedisPoolConfig的配置，但是按照当前采用的jredis只支持以下属性配置(maxIdle, maxTotal, minIdle)当前设置为默认值</span><br><span class="line">redis.pool.maxIdle=8</span><br><span class="line">redis.pool.maxTotal=8</span><br><span class="line">redis.pool.minIdle=0</span><br><span class="line">## redis连接url的格式为：http://[password:&#123;password&#125;@]&#123;host&#125;:&#123;port&#125;/&#123;db&#125;</span><br><span class="line">## password: 密码; host: ip或者域名; port: 端口; db: 数据库</span><br><span class="line">## 有密码时可以设置url为: http://password:1234@127.0.0.1:6379/0</span><br><span class="line">## 无密码时可以设置url为: http://127.0.0.1:6379/0</span><br><span class="line">default.redis.url=http://127.0.0.1:6379/0</span><br><span class="line">default.redis.key=defaultRedis</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="2-2-2-redis的xml配置"><a href="#2-2-2-redis的xml配置" class="headerlink" title="2.2.2. redis的xml配置"></a>2.2.2. <code>redis</code>的xml配置</h4><blockquote><p>在<red><code>config</code></red>的文件夹下创建<red><code>redis</code></red>的文件夹,新增两个<code>xml</code>文件，为<red><code>redis.xml</code></red>和<red><code>default-redis.xml</code></red>，以下分别是两个<code>xml</code>的配置内容</p></blockquote><ul><li><code>redis.xml</code>配置内容:</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">  http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">  http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">  http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"poolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.maxIdle&#125;"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.maxTotal&#125;"</span> /&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.minIdle&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 默认库-用于数据库表ID缓存 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"./default-redis.xml"</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 有其他新的redis源直接新增xml追加在此处即可 --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"IdRedisGeneratorFactory"</span> <span class="attr">class</span>=<span class="string">"com.asc.commons.dbac.IdRedisGeneratorFactory"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"RedisAccessFactory"</span> <span class="attr">class</span>=<span class="string">"com.asc.commons.redis.RedisAccessFactory"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"redisConnections"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"defaultRedisConnection"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>default-redis.xml</code>配置内容</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/aop  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/aop/spring-aop-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/context  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/context/spring-context-3.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"defaultJedisShardInfo"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisShardInfo"</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">"String"</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"$&#123;default.redis.url&#125;"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"defaultRedisConnection"</span> <span class="attr">class</span>=<span class="string">"com.asc.commons.redis.RedisConnection"</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"key"</span> <span class="attr">value</span>=<span class="string">"$&#123;default.redis.key&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolConfig"</span> <span class="attr">ref</span>=<span class="string">"poolConfig"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"info"</span> <span class="attr">ref</span>=<span class="string">"defaultJedisShardInfo"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-2-3-应用的xml配置"><a href="#2-2-3-应用的xml配置" class="headerlink" title="2.2.3. 应用的xml配置"></a>2.2.3. 应用的<code>xml</code>配置</h4><blockquote><p>在<code>config/app-config.xml</code>里增加对<code>redis.xml</code>的引入，如下：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"../redis/redis.xml"</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-2-4-DataSource的Bean配置修改"><a href="#2-2-4-DataSource的Bean配置修改" class="headerlink" title="2.2.4. DataSource的Bean配置修改"></a>2.2.4. <code>DataSource</code>的<code>Bean</code>配置修改</h4><blockquote><p>针对数据库配置新增数据库唯一实例名</p></blockquote><blockquote><p>在<code>config/core-config.xml</code>的所有<code>com.mixky.dbac.datasource.DataSource</code>的Bean配置，新增<code>schemaName</code>属性的赋值，该属性用于对真实数据库实例的标记，不管是一个项目还是多个项目在采用<code>schemaName</code>时只要是一个数据库实例名和用户名的情况下必须保持<code>schemaName</code>的一致性。</p></blockquote><blockquote><p>比如伤损项目和焊缝项目都用到<code>rdms</code>数据库实例和<code>rdmsapp</code>用户，那么不管在伤损项目还是在焊缝项目的所有应用配置里这个<code>DataSource</code>的<code>schemaName</code>都必须保持一致，可以使用<code>rdmsAppDsn</code>来标记。</p></blockquote><blockquote><p>配置如下:</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schemaName"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>demoPortalDsn<span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="comment">&lt;!-- 该处是某个demo的portal数据库-必须要改 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idSource"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;db.idsource&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-3-流水号功能升级"><a href="#2-3-流水号功能升级" class="headerlink" title="2.3. 流水号功能升级"></a>2.3. 流水号功能升级</h3><blockquote><p>流水号通过<code>redis</code>生成的配置调整</p></blockquote><blockquote><p>以下配置只需要在使用流水号的项目应用中配置即可</p></blockquote><blockquote><p>以下以伤损项目的流水号生成为例，伤损里的流水号生成工具类为<code>com.crmec.rail.commons.serialnumber.SerialNumberFactory</code>，如何把该类改为可以适用<code>redis</code>获取流水号的工具类。</p></blockquote><h4 id="2-3-1-java代码新增"><a href="#2-3-1-java代码新增" class="headerlink" title="2.3.1. java代码新增"></a>2.3.1. <code>java</code>代码新增</h4><blockquote><p>在<code>com.crmec.rail.commons.serialnumber.SerialNumberFactory</code>新增静态字段为<code>idSource</code>和<code>systemCode</code>，并且生成该字段的<code>get</code>、<code>set</code>方法。</p></blockquote><blockquote><p>新增的字段分别为流水号来源、系统标示，<code>idSource</code>为标示生成流水号的来源；<code>systemCode</code>为标示系统，如伤损项目里的所有应用都应该使用一个编号<code>rdms</code>，加油卡可以使用<code>rcms</code>，钢轨供应链可以使用<code>rscm</code>。</p></blockquote><blockquote><p>代码如下所示</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String idSource;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String systemCode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getIdSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> idSource;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIdSource</span><span class="params">(String idSource)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.idSource = idSource;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getSystemCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> systemCode;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSystemCode</span><span class="params">(String systemCode)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.systemCode = systemCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-2-Bean配置修改"><a href="#2-3-2-Bean配置修改" class="headerlink" title="2.3.2. Bean配置修改"></a>2.3.2. <code>Bean</code>配置修改</h4><blockquote><p>进入<code>Rail Defects Application</code>项目，修改<code>WebRoot\WEB-INF\config\spring</code>下面的<code>core-config.xml</code>文件里的<code>SerialNumberFactory</code>的<code>Bean</code>配置。</p></blockquote><blockquote><p>该处仅针对伤损<code>defects</code>应用里的流水号配置，其他项目或应用里使用如下同样的配置</p></blockquote><blockquote><p>在原来<code>Bean</code>的配置上加上对<code>idSource</code>的赋值</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 生成序列号的时候，获取内外网 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"SerialNumberFactory"</span> <span class="attr">class</span>=<span class="string">"com.crmec.rail.commons.serialnumber.SerialNumberFactory"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idGenerator"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;serialnumber.generator&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idSource"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;serialnumber.source&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"systemCode"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;serialnumber.systemCode&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-3-3-param-properties配置新增"><a href="#2-3-3-param-properties配置新增" class="headerlink" title="2.3.3. param.properties配置新增"></a>2.3.3. <code>param.properties</code>配置新增</h4><blockquote><p>进入<code>Rail Defects Application</code>项目，修改<code>WebRoot\WEB-INF</code>下面的<code>param.properties</code>文件，在该文件里增加一个参数配置，如下所示</p></blockquote><blockquote><p>流水号新增参数配置</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 流水号生成来源，可以配置Redis或者Db，不配置默认是Db</span><br><span class="line">serialnumber.source=Redis</span><br><span class="line">serialnumber.systemCode=rdms</span><br></pre></td></tr></table></figure><blockquote><p>流水号需要依赖的<code>redis</code>连接参数配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">serial.redis.url=http://127.0.0.1:6379/1</span><br><span class="line">serial.redis.key=serialRedis</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="2-3-4-redis的xml配置"><a href="#2-3-4-redis的xml配置" class="headerlink" title="2.3.4. redis的xml配置"></a>2.3.4. <code>redis</code>的<code>xml</code>配置</h4><blockquote><p>在<code>{projectPath}/WebRoot\WEB-INF\config\redis</code>所在文件夹下面创建<code>serialRedis.xml</code>文件</p></blockquote><blockquote><p><code>xml</code>内容如下:</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"  </span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/beans  </span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/aop  </span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/aop/spring-aop-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/context  </span></span></span><br><span class="line"><span class="tag"><span class="string">           http://www.springframework.org/schema/context/spring-context-3.0.xsd"</span>&gt;</span></span><br><span class="line">      </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serialJedisShardInfo"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisShardInfo"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">"String"</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"$&#123;serial.redis.url&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serialRedisConnection"</span> <span class="attr">class</span>=<span class="string">"com.asc.commons.redis.RedisConnection"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"key"</span> <span class="attr">value</span>=<span class="string">"$&#123;serial.redis.key&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default"</span> <span class="attr">value</span>=<span class="string">"false"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolConfig"</span> <span class="attr">ref</span>=<span class="string">"poolConfig"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"info"</span> <span class="attr">ref</span>=<span class="string">"serialJedisShardInfo"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">         </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>进入到<code>{projectPath}/WebRoot\WEB-INF\config\redis\redis.xml</code>，在<code>RedisAccessFactory</code>的<code>Bean</code>配置上加入对<code>serialRedisConnection</code>的引用</p></blockquote><blockquote><p>配置修改如下：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"RedisAccessFactory"</span> <span class="attr">class</span>=<span class="string">"com.asc.commons.redis.RedisAccessFactory"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"redisConnections"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"defaultRedisConnection"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"serialRedisConnection"</span>/&gt;</span><span class="comment">&lt;!-- 流水号的redis连接应用 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-3-5-java类新增"><a href="#2-3-5-java类新增" class="headerlink" title="2.3.5. java类新增"></a>2.3.5. <code>java</code>类新增</h4><blockquote><p>创建流水号生成抽象类，该抽象类可以创建在和流水号类同一个包下，伤损里创建的类为<code>com.crmec.rail.commons.serialnumber.AbstractSerialNumberFactory</code>。</p></blockquote><blockquote><p>类的内容如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.crmec.rail.commons.serialnumber;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.asc.commons.dbac.CommonDatabaseAccess;</span><br><span class="line"><span class="keyword">import</span> com.asc.commons.exception.DbAccessException;</span><br><span class="line"><span class="keyword">import</span> com.asc.commons.exception.RedisException;</span><br><span class="line"><span class="keyword">import</span> com.asc.commons.redis.RedisAccessFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: AbstractSerialNumberFactory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 流水号生成抽象工厂类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> F.D.Kang [kangfengde962@gmail.com]</span></span><br><span class="line"><span class="comment"> *   _____ ____   _  __                 </span></span><br><span class="line"><span class="comment"> * |  ___|  _ \ | |/ /__ _ _ __   __ _</span></span><br><span class="line"><span class="comment"> * | |_  | | | || ' // _` | '_ \ / _` |</span></span><br><span class="line"><span class="comment"> * |  _|_| |_| || . \ (_| | | | | (_| |</span></span><br><span class="line"><span class="comment"> * |_| (_)____(_)_|\_\__,_|_| |_|\__, |</span></span><br><span class="line"><span class="comment"> *                               |___/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@company</span> Mixky Technology Company</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020年4月22日 下午2:17:50</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSerialNumberFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isRedisSource</span><span class="params">(String idSource)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"Redis"</span>.equals(idSource)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String serialKeySuffix = <span class="string">"_SerialNum"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String redisKey = <span class="string">"serialRedis"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getKey</span><span class="params">(String systemCode)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> systemCode + serialKeySuffix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getNo</span><span class="params">(String idGenerator, String systemCode, String headNum)</span> </span>&#123;</span><br><span class="line"><span class="keyword">long</span> no = <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Boolean hasHash = RedisAccessFactory.getRedisAccess(redisKey).hasMappedKeyExist(getKey(systemCode), headNum);</span><br><span class="line"><span class="keyword">if</span> (hasHash == <span class="keyword">null</span> || !hasHash) &#123;</span><br><span class="line">setMaxNo(idGenerator, systemCode, headNum);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> step = getStep(idGenerator);</span><br><span class="line">no = RedisAccessFactory.getRedisAccess(redisKey).increaseMappedAmount(getKey(systemCode), headNum, step);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RedisException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"通过redis获取流水号失败"</span>, e);</span><br><span class="line">&#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"通过redis获取流水号失败"</span>, e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> no;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setMaxNo</span><span class="params">(String idGenerator, String systemCode, String headNum)</span> <span class="keyword">throws</span> DbAccessException, RedisException </span>&#123;</span><br><span class="line"><span class="keyword">long</span> maxId = getMaxId(headNum);</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"Even"</span>.equals(idGenerator)) &#123;</span><br><span class="line">maxId = getEvenId(maxId);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"Odd"</span>.equals(idGenerator)) &#123;</span><br><span class="line">maxId = getOddId(maxId);</span><br><span class="line">&#125;</span><br><span class="line">RedisAccessFactory.getRedisAccess(redisKey).increaseMappedAmount(getKey(systemCode), headNum, maxId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getStep</span><span class="params">(String idGenerator)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="string">"Even"</span>.equals(idGenerator) || <span class="string">"Odd"</span>.equals(idGenerator)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getMaxId</span><span class="params">(String headNum)</span> <span class="keyword">throws</span> DbAccessException </span>&#123;</span><br><span class="line">String sql = <span class="string">"select F_NO from T_RDMS_BASE_SERIALNUM where F_HEAD_NUM=?"</span>;</span><br><span class="line">CommonDatabaseAccess.instance().beginTransaction();</span><br><span class="line">SerialEntity serialEntity = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">serialEntity = CommonDatabaseAccess.instance().getObject(sql,</span><br><span class="line"><span class="keyword">new</span> Object[] &#123; headNum &#125;, SerialEntity.class);</span><br><span class="line">&#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line"><span class="keyword">throw</span> e;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">CommonDatabaseAccess.instance().endTransaction();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (serialEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> serialEntity.getF_no();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getOddId</span><span class="params">(<span class="keyword">long</span> maxId)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (maxId % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// 最大ID是偶数，仅需加一</span></span><br><span class="line">maxId = maxId + <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 最大ID是奇数，加二，取下一个奇数</span></span><br><span class="line">maxId = maxId + <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> maxId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getEvenId</span><span class="params">(<span class="keyword">long</span> maxId)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (maxId % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// 最大ID是奇数，仅需加一</span></span><br><span class="line">maxId = maxId + <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 最大ID是偶数，加二，取下一个偶数</span></span><br><span class="line">maxId = maxId + <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> maxId;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-6-java方法修改"><a href="#2-3-6-java方法修改" class="headerlink" title="2.3.6. java方法修改"></a>2.3.6. <code>java</code>方法修改</h4><blockquote><p>流水号生成类里修改以及各个实现方法修改，以伤损项目的年度计划编号生成的方法<code>getYPlanSerialNumber</code>修改为示例</p></blockquote><blockquote><p>该段代码插入到流水号生成最开始</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isRedisSource(idSource)) &#123; <span class="comment">// 采用redis</span></span><br><span class="line">no = getNo(idGenerator, systemCode, YEAR_FLAG);</span><br><span class="line"><span class="keyword">if</span> (no &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">logger.error(<span class="string">"通过redis获取流水号失败"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">serial = headNum + (String.format(f, no));</span><br><span class="line"><span class="keyword">return</span> serial;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>调整前的方法代码</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getYPlanSerialNumber</span><span class="params">(String num, String dateStr)</span> </span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (LOCK1) &#123;</span><br><span class="line">String serial = <span class="keyword">null</span>;</span><br><span class="line">logger.debug(<span class="string">"start getYPlanSerialNumber 开始产生年度计划序列号！"</span>);</span><br><span class="line">IDbacTransaction tx = getDbAccess().beginTransaction();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">long</span> no = <span class="number">0</span>;</span><br><span class="line">String f = <span class="string">"%04d"</span>;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isEmpty(num)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"编码不能为空！"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isEmpty(dateStr)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"年月时间戳不能为空！"</span>);</span><br><span class="line">&#125;</span><br><span class="line">String headNum = YEAR_FLAG + <span class="string">"-"</span> + num + <span class="string">"-"</span> + dateStr;</span><br><span class="line">String sql = <span class="string">"select F_NO from T_RDMS_BASE_SERIALNUM"</span> + <span class="string">" where F_HEAD_NUM=?"</span>;</span><br><span class="line">SerialEntity serialEntity = getDbAccess().getObject(sql, <span class="keyword">new</span> Object[] &#123; headNum &#125;, SerialEntity.class);</span><br><span class="line"><span class="keyword">if</span> (serialEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// 如果存在该类型流水号，则将流水号+1</span></span><br><span class="line">no = serialEntity.getF_no();</span><br><span class="line"><span class="keyword">if</span> (idGenerator.equals(<span class="string">"Even"</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (no % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">no++;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (no % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">no++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">no += <span class="number">2</span>;</span><br><span class="line">String updateSql = <span class="string">"update T_RDMS_BASE_SERIALNUM set "</span> + <span class="string">" F_NO=? where F_HEAD_NUM=? and F_TYPE=? "</span>;</span><br><span class="line">getDbAccess().execute(updateSql, <span class="keyword">new</span> Object[] &#123; no, headNum, YEAR_FLAG &#125;);</span><br><span class="line">logger.debug(<span class="string">"获取年度计划流水号："</span> + no);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">no = idGenerator.equals(<span class="string">"Even"</span>) ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">serialEntity = <span class="keyword">new</span> SerialEntity();</span><br><span class="line">serialEntity.setF_no(no);</span><br><span class="line">serialEntity.setF_type(YEAR_FLAG);</span><br><span class="line">serialEntity.setF_head_num(headNum);</span><br><span class="line">getDbAccess().saveObject(serialEntity);</span><br><span class="line">&#125;</span><br><span class="line">serial = headNum + (String.format(f, no));</span><br><span class="line">tx.commit();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">tx.rollback();</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">getDbAccess().endTransaction();</span><br><span class="line">&#125;</span><br><span class="line">logger.debug(<span class="string">"年度序列号获取成功，序列号为："</span> + serial);</span><br><span class="line"><span class="keyword">return</span> serial;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>调整后的方法代码–可参考调整后的流水号生成代码</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getYPlanSerialNumber</span><span class="params">(String num, String dateStr)</span> </span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (LOCK1) &#123;</span><br><span class="line">String serial = <span class="keyword">null</span>;</span><br><span class="line">String f = <span class="string">"%04d"</span>;</span><br><span class="line"><span class="keyword">long</span> no = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isEmpty(num)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"编码不能为空！"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isEmpty(dateStr)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"年月时间戳不能为空！"</span>);</span><br><span class="line">&#125;</span><br><span class="line">String headNum = YEAR_FLAG + <span class="string">"-"</span> + num + <span class="string">"-"</span> + dateStr;</span><br><span class="line">logger.debug(<span class="string">"start getYPlanSerialNumber 开始产生年度计划序列号！"</span>);</span><br><span class="line"><span class="keyword">if</span> (isRedisSource(idSource)) &#123; <span class="comment">// 采用redis</span></span><br><span class="line">no = getNo(idGenerator, systemCode, YEAR_FLAG);</span><br><span class="line"><span class="keyword">if</span> (no &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">logger.error(<span class="string">"通过redis获取流水号失败"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">serial = headNum + (String.format(f, no));</span><br><span class="line"><span class="keyword">return</span> serial;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">IDbacTransaction tx = getDbAccess().beginTransaction();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">String sql = <span class="string">"select F_NO from T_RDMS_BASE_SERIALNUM"</span> + <span class="string">" where F_HEAD_NUM=?"</span>;</span><br><span class="line">SerialEntity serialEntity = getDbAccess().getObject(sql, <span class="keyword">new</span> Object[] &#123; headNum &#125;, SerialEntity.class);</span><br><span class="line"><span class="keyword">if</span> (serialEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// 如果存在该类型流水号，则将流水号+1</span></span><br><span class="line">no = serialEntity.getF_no();</span><br><span class="line"><span class="keyword">if</span> (idGenerator.equals(<span class="string">"Even"</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (no % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">no++;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (no % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">no++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">no += <span class="number">2</span>;</span><br><span class="line">String updateSql = <span class="string">"update T_RDMS_BASE_SERIALNUM set "</span> + <span class="string">" F_NO=? where F_HEAD_NUM=? and F_TYPE=? "</span>;</span><br><span class="line">getDbAccess().execute(updateSql, <span class="keyword">new</span> Object[] &#123; no, headNum, YEAR_FLAG &#125;);</span><br><span class="line">logger.debug(<span class="string">"获取年度计划流水号："</span> + no);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">no = idGenerator.equals(<span class="string">"Even"</span>) ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">serialEntity = <span class="keyword">new</span> SerialEntity();</span><br><span class="line">serialEntity.setF_no(no);</span><br><span class="line">serialEntity.setF_type(YEAR_FLAG);</span><br><span class="line">serialEntity.setF_head_num(headNum);</span><br><span class="line">getDbAccess().saveObject(serialEntity);</span><br><span class="line">&#125;</span><br><span class="line">serial = headNum + (String.format(f, no));</span><br><span class="line">tx.commit();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">tx.rollback();</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">getDbAccess().endTransaction();</span><br><span class="line">&#125;</span><br><span class="line">logger.debug(<span class="string">"年度序列号获取成功，序列号为："</span> + serial);</span><br><span class="line"><span class="keyword">return</span> serial;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-ID管理升级"><a href="#2-4-ID管理升级" class="headerlink" title="2.4. ID管理升级"></a>2.4. ID管理升级</h3><blockquote><p><code>manager</code>应用新增手动维护redis最大ID功能升级配置</p></blockquote><blockquote><p>该功能主要用于对数据表ID进行向上手动设置当前最大ID</p></blockquote><blockquote><p>该功能属于<code>manager</code>应用，功能菜单位于<code>应用运行管理</code>菜单下</p></blockquote><h4 id="2-4-1-java类新增代码"><a href="#2-4-1-java类新增代码" class="headerlink" title="2.4.1. java类新增代码"></a>2.4.1. <code>java</code>类新增代码</h4><h5 id="2-4-1-1-常量定义新增"><a href="#2-4-1-1-常量定义新增" class="headerlink" title="2.4.1.1. 常量定义新增"></a>2.4.1.1. 常量定义新增</h5><blockquote><p><code>CommonTextFolderNode</code>类新增<code>ID管理</code>的菜单<code>KEY</code>常量定义代码</p></blockquote><blockquote><p>类全路径为<code>com.asc.manager.navigator.node.CommonTextFolderNode</code>，新增代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_APPLICATION_ID_MANAGER = <span class="string">"ApplicationIdManager"</span>;</span><br></pre></td></tr></table></figure><h5 id="2-4-1-2-菜单新增"><a href="#2-4-1-2-菜单新增" class="headerlink" title="2.4.1.2. 菜单新增"></a>2.4.1.2. 菜单新增</h5><blockquote><p><code>ApplicationManagerFolderLoader</code>类新增应用运行管理下子菜单<code>ID管理</code>代码</p></blockquote><blockquote><p>类全路径为<code>com.asc.manager.navigator.loader.ApplicationManagerFolderLoader</code>，新增代码如下：</p></blockquote><blockquote><p>在方法<code>getChildren</code>里，新增代码写在<code>缓存管理</code>和<code>流程实例</code>之间</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node = <span class="keyword">new</span> CommonTextFolderNode(CommonTextFolderNode.TYPE_APPLICATION_ID_MANAGER, key, <span class="string">"ID管理"</span>, <span class="keyword">true</span>);</span><br><span class="line">nodes.add(node);</span><br></pre></td></tr></table></figure><h5 id="2-4-1-3-接口新增"><a href="#2-4-1-3-接口新增" class="headerlink" title="2.4.1.3. 接口新增"></a>2.4.1.3. 接口新增</h5><blockquote><p><code>ManagerAppDirect</code>类新增<code>ID</code>查询接口和<code>ID</code>修改接口代码</p></blockquote><blockquote><p>类全路径<code>com.asc.manager.direct.ManagerAppDirect</code>，新增代码如下：</p></blockquote><blockquote><p>追加方法<code>listSchemaTableId</code>，代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonObject <span class="title">listSchemaTableId</span><span class="params">(String schemaName)</span></span>&#123;</span><br><span class="line">    JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">    json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(schemaName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> json;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;Object, Object&gt; map = RedisAccessFactory.getDefaultRedisAccess()</span><br><span class="line">                .hashEntries(schemaName + <span class="string">"_SEQID"</span>);</span><br><span class="line">        Iterator&lt;Entry&lt;Object, Object&gt;&gt; it = map.entrySet().iterator();</span><br><span class="line">        JsonArray array = <span class="keyword">new</span> JsonArray();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            JsonObject data = <span class="keyword">new</span> JsonObject();</span><br><span class="line">            Entry&lt;Object, Object&gt; entry = it.next();</span><br><span class="line">            data.addProperty(<span class="string">"tableName"</span>, String.valueOf(entry.getKey()));</span><br><span class="line">            data.addProperty(<span class="string">"idValue"</span>, entry.getValue().toString());</span><br><span class="line">            array.add(data);</span><br><span class="line">        &#125;</span><br><span class="line">        json.add(<span class="string">"datas"</span>, array);</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>追加方法<code>saveSchemaTableId</code>，代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DirectMethod</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonObject <span class="title">saveSchemaTableId</span><span class="params">(String schemaName, JsonArray array)</span></span>&#123;</span><br><span class="line">    JsonObject json = <span class="keyword">new</span> JsonObject();</span><br><span class="line">    json.addProperty(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Strings.isNullOrEmpty(schemaName) || array == <span class="keyword">null</span> || array.isJsonNull()) &#123;</span><br><span class="line">            json.addProperty(<span class="string">"message"</span>, <span class="string">"传入参数错误"</span>);</span><br><span class="line">            <span class="keyword">return</span> json;</span><br><span class="line">        &#125;</span><br><span class="line">        Iterator&lt;JsonElement&gt; it = array.iterator();</span><br><span class="line">        <span class="keyword">boolean</span> valid = <span class="keyword">true</span>;</span><br><span class="line">        Map&lt;String, Long&gt; datas = Maps.newHashMap();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            JsonObject obj = it.next().getAsJsonObject();</span><br><span class="line">            String hashKey = obj.get(<span class="string">"tableName"</span>).getAsString();</span><br><span class="line">            Long value = obj.get(<span class="string">"idValue"</span>).getAsLong();</span><br><span class="line">            <span class="keyword">if</span> (Strings.isNullOrEmpty(hashKey) || value == <span class="keyword">null</span> || value &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                valid = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Long newValue = RedisAccessFactory.getDefaultRedisAccess()</span><br><span class="line">                    .getMappedLong(schemaName + <span class="string">"_SEQID"</span>, hashKey);</span><br><span class="line">            <span class="keyword">if</span> (newValue == <span class="keyword">null</span> || newValue &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                valid = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (value - <span class="number">1000</span> &lt;= newValue) &#123;</span><br><span class="line">                valid = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            datas.put(hashKey, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!valid) &#123;</span><br><span class="line">            json.addProperty(<span class="string">"message"</span>, <span class="string">"本次设置ID最大值失败：设置的最大值必须大于当前最大值1000"</span>);</span><br><span class="line">            <span class="keyword">return</span> json;</span><br><span class="line">        &#125;</span><br><span class="line">        Iterator&lt;Entry&lt;String, Long&gt;&gt; it1 = datas.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (it1.hasNext()) &#123;</span><br><span class="line">            Entry&lt;String, Long&gt; entry = it1.next();</span><br><span class="line">            String hashKey = entry.getKey();</span><br><span class="line">            Long value = entry.getValue();</span><br><span class="line">            String idGenerator = DataSourceFactory.instance().getDefaultDataSource().getIdGenerator();</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"Even"</span>.equals(idGenerator)) &#123;</span><br><span class="line">                value = AbstractIdGenerator.getEvenId(value);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"Odd"</span>.equals(idGenerator)) &#123;</span><br><span class="line">                value = AbstractIdGenerator.getOddId(value);</span><br><span class="line">            &#125;</span><br><span class="line">            RedisAccessFactory.getDefaultRedisAccess()</span><br><span class="line">                .putMappedLong(schemaName + <span class="string">"_SEQID"</span>, hashKey, value);</span><br><span class="line">        &#125;</span><br><span class="line">        json.addProperty(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        json.addProperty(<span class="string">"message"</span>, <span class="string">"设置数据表最大ID失败"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-2-js新增代码"><a href="#2-4-2-js新增代码" class="headerlink" title="2.4.2. js新增代码"></a>2.4.2. <code>js</code>新增代码</h4><blockquote><p><code>js</code>新增代码属于平台对ID管理的菜单配置和属性修改配置</p></blockquote><blockquote><p>新增文件路径为<code>Platform Manager\WebRoot\app\framework\manager\class</code>，以下两个js文件均新增在该路径下</p></blockquote><h5 id="2-4-2-1-菜单新增"><a href="#2-4-2-1-菜单新增" class="headerlink" title="2.4.2.1. 菜单新增"></a>2.4.2.1. 菜单新增</h5><blockquote><p>新增<code>ApplicationIdManager.js</code>文件</p></blockquote><blockquote><p>代码如下：</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">AscApp.ClassManager.registerClass(&#123;</span><br><span class="line">    <span class="comment">// 类型</span></span><br><span class="line">    type : <span class="string">'ApplicationIdManager'</span>,</span><br><span class="line">    <span class="comment">// 名称</span></span><br><span class="line">    caption : <span class="string">'ID管理'</span>,</span><br><span class="line">    <span class="comment">// 属性定义</span></span><br><span class="line">    <span class="comment">// 编辑器定义</span></span><br><span class="line">    editors : [&#123;</span><br><span class="line">        title : <span class="string">'运行状态管理'</span>,</span><br><span class="line">        jspUrl : <span class="string">'manager/apptableid/application.table.id'</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="2-4-2-2-属性新增"><a href="#2-4-2-2-属性新增" class="headerlink" title="2.4.2.2. 属性新增"></a>2.4.2.2. 属性新增</h5><blockquote><p>新增<code>TableId.js</code>文件</p></blockquote><blockquote><p>代码如下</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">AscApp.ClassManager.registerClass(&#123;</span><br><span class="line">    <span class="comment">// 类型</span></span><br><span class="line">    type : <span class="string">'TableId'</span>,</span><br><span class="line">    <span class="comment">// 名称</span></span><br><span class="line">    caption : <span class="string">'数据表ID配置'</span>,</span><br><span class="line">    <span class="comment">// 属性定义</span></span><br><span class="line">    properties : [&#123;</span><br><span class="line">        name : <span class="string">'tableName'</span>,</span><br><span class="line">        text : <span class="string">'数据表名'</span>,</span><br><span class="line">        editor : <span class="string">'none'</span>,</span><br><span class="line">        description : <span class="string">'数据表记录ID（唯一）。'</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        name : <span class="string">'idValue'</span>,</span><br><span class="line">        text : <span class="string">'数据表ID值'</span>,</span><br><span class="line">        editor : <span class="string">'number'</span>,</span><br><span class="line">        description : <span class="string">'数据表当前最大ID。'</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="comment">// 列表编辑字段</span></span><br><span class="line">    propertyColumns : &#123;</span><br><span class="line">        <span class="string">'tableName'</span>:&#123;<span class="attr">width</span>: <span class="number">350</span>, <span class="attr">flex</span>: <span class="number">1</span>&#125;,</span><br><span class="line">        <span class="string">'idValue'</span>:&#123;<span class="attr">width</span>: <span class="number">200</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="2-4-3-jsp新增代码"><a href="#2-4-3-jsp新增代码" class="headerlink" title="2.4.3. jsp新增代码"></a>2.4.3. <code>jsp</code>新增代码</h4><blockquote><p><code>jsp</code>代码属于<code>ID</code>的查询和修改界面代码</p></blockquote><h5 id="2-4-3-1-创建文件夹"><a href="#2-4-3-1-创建文件夹" class="headerlink" title="2.4.3.1. 创建文件夹"></a>2.4.3.1. 创建文件夹</h5><blockquote><p>在路径<code>Platform Manager\WebRoot\WEB-INF\jsp\manager</code>下创建名字为<code>apptableid</code>的文件夹</p></blockquote><h5 id="2-4-3-2-页面新增"><a href="#2-4-3-2-页面新增" class="headerlink" title="2.4.3.2. 页面新增"></a>2.4.3.2. 页面新增</h5><blockquote><p>新增<code>application.table.id.jsp</code>文件</p></blockquote><blockquote><p>在路径<code>Platform Manager\WebRoot\WEB-INF\jsp\manager\apptableid</code>下创建<code>application.table.id.jsp</code>文件</p></blockquote><blockquote><p>代码如下：</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@page contentType=<span class="string">"text/html;charset=UTF-8"</span>%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="built_in">String</span> panelid = request.getParameter(<span class="string">"panelid"</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">Ext.onReady(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> panel = Ext.getCmp(<span class="string">'&lt;%=panelid%&gt;'</span>);</span><br><span class="line">    <span class="keyword">var</span> type = <span class="string">'TableId'</span>;</span><br><span class="line">    <span class="keyword">var</span> typeClass = AscApp.ClassManager.getClass(type);</span><br><span class="line">    <span class="comment">// 获得对象属性列表</span></span><br><span class="line">    <span class="keyword">var</span> properties = AscApp.ClassManager.getProperties(type);</span><br><span class="line">    <span class="comment">// 初始化视图列</span></span><br><span class="line">    <span class="keyword">var</span> columns = AscApp.ClassManager.getGridColumns(properties, typeClass.propertyColumns);</span><br><span class="line">    <span class="comment">// 初始化存储字段</span></span><br><span class="line">    <span class="keyword">var</span> fields = AscApp.ClassManager.getStoreFields(properties);</span><br><span class="line">    </span><br><span class="line">    panel.schemaName = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> editor = Ext.create(<span class="string">'Asc.extension.JspPanel'</span>, &#123;</span><br><span class="line">        disabled : <span class="literal">true</span>,</span><br><span class="line">        layout : <span class="string">'fit'</span>,</span><br><span class="line">        region : <span class="string">'east'</span>,</span><br><span class="line">        split : <span class="literal">true</span>,</span><br><span class="line">        border : <span class="literal">false</span>,</span><br><span class="line">        collapseMode:<span class="string">'mini'</span>,</span><br><span class="line">        width : <span class="number">350</span>,</span><br><span class="line">        minWidth : <span class="number">200</span>,</span><br><span class="line">        title : <span class="string">'属性编辑窗口'</span>,</span><br><span class="line">        iconCls : <span class="string">'icon-manager-property'</span>,</span><br><span class="line">        jspUrl : <span class="string">'manager/properties.editor'</span>,</span><br><span class="line">        params : &#123;<span class="attr">type</span> : type&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> store = <span class="keyword">new</span> Ext.data.Store(&#123;</span><br><span class="line">        clearRemovedOnLoad : <span class="literal">true</span>,</span><br><span class="line">        pageSize : <span class="number">30</span>,<span class="comment">//每页显示几条数据(初始值)</span></span><br><span class="line">        proxy : &#123;</span><br><span class="line">            type : <span class="string">'direct'</span>,</span><br><span class="line">            directFn : ManagerAppDirect.listSchemaTableId,</span><br><span class="line">            extraParams : &#123;</span><br><span class="line">                relationId : <span class="string">''</span></span><br><span class="line">            &#125;,</span><br><span class="line">            paramOrder : <span class="string">'schemaName'</span>,</span><br><span class="line">            paramsAsHash : <span class="literal">true</span>,</span><br><span class="line">            reader : &#123;</span><br><span class="line">                type: <span class="string">'json'</span>,</span><br><span class="line">                root : <span class="string">'datas'</span>,</span><br><span class="line">                totalProperty : <span class="string">'total'</span>,</span><br><span class="line">                successProperty : <span class="string">'successed'</span>,</span><br><span class="line">                messageProperty : <span class="string">'message'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        fields : fields,</span><br><span class="line">        listeners : &#123;</span><br><span class="line">            <span class="string">'beforeload'</span> : <span class="function"><span class="keyword">function</span>(<span class="params">s, operation, eOpts</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> schemaNameValue = textfield.getValue();</span><br><span class="line">                <span class="keyword">if</span> (schemaNameValue) &#123;</span><br><span class="line">                    operation.params = &#123;<span class="attr">schemaName</span>: schemaNameValue&#125;;</span><br><span class="line">                    panel.schemaName = schemaNameValue;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查询框</span></span><br><span class="line">    <span class="keyword">var</span> textfield = <span class="keyword">new</span> Ext.form.TextField(&#123;</span><br><span class="line">        width : <span class="number">180</span>,</span><br><span class="line">        emptyText : <span class="string">'输入数据库实例名'</span>,</span><br><span class="line">        enableKeyEvents : <span class="literal">true</span>,</span><br><span class="line">        listeners : &#123;</span><br><span class="line">            <span class="string">'specialkey'</span> : <span class="function"><span class="keyword">function</span> (<span class="params">field, e</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (e.getKey() == e.ENTER) &#123;</span><br><span class="line">                    store.load();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> grid = Ext.create(<span class="string">'Ext.grid.Panel'</span>, &#123;</span><br><span class="line">        region : <span class="string">'center'</span>,</span><br><span class="line">        border : <span class="literal">false</span>,</span><br><span class="line">        sortableColumns : <span class="literal">false</span>,</span><br><span class="line">        viewConfig: &#123;<span class="attr">stripeRows</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">        allowDeselect : <span class="literal">true</span>,</span><br><span class="line">        columns : columns,</span><br><span class="line">        store : store,</span><br><span class="line"><span class="comment">//      width : 800,</span></span><br><span class="line">        split : <span class="literal">true</span>,</span><br><span class="line">        tbar : [textfield, &#123;</span><br><span class="line">            text : <span class="string">'搜索'</span>,</span><br><span class="line">            iconCls : <span class="string">'icon-sys-search'</span>,</span><br><span class="line">            handler : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                store.load();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">'-'</span>, &#123;</span><br><span class="line">            text : <span class="string">'刷新'</span>,</span><br><span class="line">            iconCls : <span class="string">'icon-sys-refresh'</span>,</span><br><span class="line">            handler : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                grid.getStore().reload();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 选中</span></span><br><span class="line">    grid.on(<span class="string">'selectionchange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">g, selected</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(selected.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            editor.loadRecord(selected[<span class="number">0</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            editor.clearRecord();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    panel.doApply = panel.doSave = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> updateRecs = grid.getStore().getUpdatedRecords();</span><br><span class="line">        <span class="keyword">if</span>(updateRecs.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> datas = [];</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> updateRecs)&#123;</span><br><span class="line">                <span class="keyword">var</span> record = updateRecs[i];</span><br><span class="line">                datas.push(&#123;</span><br><span class="line">                    <span class="string">'tableName'</span>: record.get(<span class="string">'tableName'</span>),</span><br><span class="line">                    <span class="string">'idValue'</span>: record.get(<span class="string">'idValue'</span>)</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            ManagerAppDirect.saveSchemaTableId(panel.schemaName, datas, <span class="function"><span class="keyword">function</span>(<span class="params">result, e</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(result &amp;&amp; result.success)&#123;</span><br><span class="line">                    Asc.common.Message.showInfo(<span class="string">'设置数据表ID最大值成功！'</span>);</span><br><span class="line">                    grid.getStore().reload();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result &amp;&amp; result.message) &#123;</span><br><span class="line">                    Asc.common.Message.showError(result.message);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Asc.common.Message.showError(<span class="string">'保存对象操作失败！'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Asc.common.Message.showError(<span class="string">'当前无修改数据，需要修改后再保存！'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 显示界面</span></span><br><span class="line">    panel.add(&#123;</span><br><span class="line">        layout : <span class="string">'border'</span>,</span><br><span class="line">        border : <span class="literal">false</span>,</span><br><span class="line">        items : [grid, editor]</span><br><span class="line">    &#125;);</span><br><span class="line">    panel.doLayout();</span><br><span class="line">&#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-5-在线监控升级"><a href="#2-5-在线监控升级" class="headerlink" title="2.5. 在线监控升级"></a>2.5. 在线监控升级</h3><blockquote><p>属于用户在线监控功能升级配置</p></blockquote><blockquote><p>正在开发中，待更新文档</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TODO 正在开发</span></span><br></pre></td></tr></table></figure><h3 id="2-6-默认密码设置"><a href="#2-6-默认密码设置" class="headerlink" title="2.6. 默认密码设置"></a>2.6. 默认密码设置</h3><h4 id="2-6-1-创建用户默认密码设置"><a href="#2-6-1-创建用户默认密码设置" class="headerlink" title="2.6.1. 创建用户默认密码设置"></a>2.6.1. 创建用户默认密码设置</h4><blockquote><p>在<code>manager</code>里创建用户时的默认密码设置，直接在<code>bs</code>项目修改都可以</p></blockquote><blockquote><p>进入<code>bs</code>项目，打开类<code>com.asc.bs.organization.access.imp.OrganizationWriterImp</code>，进入<code>saveUser</code>方法，在以下代码处进行调整</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> <span class="keyword">throws</span> OrganizationException </span>&#123;</span><br><span class="line">    <span class="comment">// 检查用户信息是否合法（关键字段）</span></span><br><span class="line">    <span class="keyword">if</span> (user.getF_name() == <span class="keyword">null</span> || <span class="string">""</span>.equals(user.getF_name())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OrganizationException(<span class="string">"未指定用户登录名"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (user.getF_caption() == <span class="keyword">null</span> || <span class="string">""</span>.equals(user.getF_caption())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OrganizationException(<span class="string">"未指定用户姓名"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未指定密码时使用默认密码</span></span><br><span class="line">    <span class="keyword">if</span> (user.getF_password() == <span class="keyword">null</span> || <span class="string">""</span>.equals(user.getF_password())) &#123;</span><br><span class="line">        PasswordEncoder encoder = <span class="keyword">new</span> PasswordEncoder();</span><br><span class="line">        user.setF_password(encoder.encode(<span class="string">"csmm@6789"</span>)); <span class="comment">// 直接修改此处的默认密码</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存用户实体对象</span></span><br><span class="line">    user.setF_update_time(<span class="keyword">new</span> Date());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getDbAccess().saveObject(user);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OrganizationException(<span class="string">"保存用户对象失败："</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 记录日志</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-6-2-重置密码默认密码设置"><a href="#2-6-2-重置密码默认密码设置" class="headerlink" title="2.6.2. 重置密码默认密码设置"></a>2.6.2. 重置密码默认密码设置</h4><blockquote><p>进入<code>manager</code>项目，打开类<code>com.asc.manager.org.OrganizationHandler</code>，进入<code>retPassword</code>方法，在以下代码处进行调整</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retPassword</span><span class="params">(<span class="keyword">long</span> userId)</span> <span class="keyword">throws</span> OrganizationException </span>&#123;</span><br><span class="line">    User user = OrganizationService.instance().getUserById(userId);</span><br><span class="line">    IDbacTransaction tx = CommonDatabaseAccess.instance().beginTransaction();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PasswordEncoder encoder = <span class="keyword">new</span> PasswordEncoder();</span><br><span class="line">        user.setF_password(encoder.encode(<span class="string">"csmm@6789"</span>)); <span class="comment">// 直接修改此处的默认密码</span></span><br><span class="line">        user.save();</span><br><span class="line">        tx.commit();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DbAccessException e) &#123;</span><br><span class="line">        tx.rollback();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OrganizationException(<span class="string">"密码重置失败。"</span>, e);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        CommonDatabaseAccess.instance().endTransaction();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> asc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> asc </tag>
            
            <tag> js </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Hexo之NexT主题搭建博客详细过程</title>
      <link href="/2018/05/20/name/"/>
      <url>/2018/05/20/name/</url>
      <content type="html"><![CDATA[<h1 id="aaaaa"><a href="#aaaaa" class="headerlink" title="aaaaa"></a>aaaaa</h1>]]></content>
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nodejs </tag>
            
            <tag> hexo </tag>
            
            <tag> NexT </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Hello World</title>
      <link href="/2018/05/18/hello-world/"/>
      <url>/2018/05/18/hello-world/</url>
      <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
      
      
    </entry>
    
  
  
</search>
